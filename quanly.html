<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng nh√¢n vi√™n</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f0f4f8;
    margin: 0;
    padding: 20px;
    text-align: center;
  }

  h1 {
    color: #007bff;
    margin-bottom: 20px;
  }

  select, button {
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin: 5px;
    outline: none;
  }

  button {
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }

  button:hover {
    background-color: #0056b3;
  }

  table {
    width: 100%;
    max-width: 1000px;
    margin: 20px auto;
    border-collapse: collapse;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    background-color: white;
  }

  th {
    background-color: #007bff;
    color: white;
    padding: 10px;
  }

  td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
  }

  tr:hover {
    background-color: #f1f9ff;
  }

  #summary {
    margin-top: 20px;
    font-weight: bold;
    color: #333;
  }
</style>
</head>
<body>

<h1>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng nh√¢n vi√™n</h1>

<div>
  <label for="nhanvienSelect">Ch·ªçn nh√¢n vi√™n:</label>
  <select id="nhanvienSelect">
    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
  </select>
  <button id="reloadBtn">üîÑ T·∫£i l·∫°i</button>
  <button id="exportBtn">üìä Xu·∫•t Excel</button>
</div>

<table id="chamcongTable">
  <thead>
    <tr>
      <th>Ng√†y</th>
      <th>V√†o s√°ng</th>
      <th>Ra s√°ng</th>
      <th>V√†o chi·ªÅu</th>
      <th>Ra chi·ªÅu</th>
      <th>V√†o l√†m th√™m</th>
      <th>Ra l√†m th√™m</th>
      <th>Gi·ªù l√†m (h)</th>
      <th>Gi·ªù l√†m th√™m (h)</th>
      <th>Ghi ch√∫</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
  </tbody>
</table>

<div id="summary"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- SheetJS (xu·∫•t Excel) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ================== Firebase Config ==================
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================== Elements ==================
const nhanvienSelect = document.getElementById('nhanvienSelect');
const tableBody = document.querySelector('#chamcongTable tbody');
const summaryDiv = document.getElementById('summary');
const reloadBtn = document.getElementById('reloadBtn');
const exportBtn = document.getElementById('exportBtn');

let currentData = []; // d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã ƒë·ªÉ xu·∫•t Excel

// ================== Load danh s√°ch nh√¢n vi√™n ==================
function loadNhanVien() {
  db.ref('nhanvien').once('value').then(snapshot => {
    nhanvienSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
    snapshot.forEach(child => {
      const nv = child.val();
      nhanvienSelect.insertAdjacentHTML('beforeend', `
        <option value="${nv.email}">${nv.ten} (${nv.email})</option>
      `);
    });
  });
}

// ================== Hi·ªÉn th·ªã d·ªØ li·ªáu ch·∫•m c√¥ng ==================
function loadChamCong(email) {
  if (!email) {
    tableBody.innerHTML = '<tr><td colspan="10">Vui l√≤ng ch·ªçn nh√¢n vi√™n.</td></tr>';
    summaryDiv.textContent = '';
    currentData = [];
    return;
  }

  tableBody.innerHTML = '<tr><td colspan="10">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

  db.ref('chamcong').once('value').then(snapshot => {
    const data = snapshot.val();
    const rows = [];
    let tongGio = 0;
    let tongLamThem = 0;

    for (let key in data) {
      const nhanvienData = data[key];
      for (let ngay in nhanvienData) {
        const info = nhanvienData[ngay];
        if (info.email && info.email.includes(email)) {
          rows.push({
            Ng√†y: ngay,
            "V√†o s√°ng": info.vaoCaSang || '-',
            "Ra s√°ng": info.raCaSang || '-',
            "V√†o chi·ªÅu": info.vaoCaChieu || '-',
            "Ra chi·ªÅu": info.raCaChieu || '-',
            "V√†o l√†m th√™m": info.vaoLamThem || '-',
            "Ra l√†m th√™m": info.raLamThem || '-',
            "Gi·ªù l√†m (h)": parseFloat(info.gioLamTrongNgay || 0),
            "Gi·ªù l√†m th√™m (h)": parseFloat(info.gioLamThem || 0),
            "Ghi ch√∫": info.ghiChu || ''
          });
          tongGio += parseFloat(info.gioLamTrongNgay || 0);
          tongLamThem += parseFloat(info.gioLamThem || 0);
        }
      }
    }

    currentData = rows; // l∆∞u l·∫°i ƒë·ªÉ xu·∫•t excel

    if (rows.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="10">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng cho nh√¢n vi√™n n√†y.</td></tr>';
      summaryDiv.textContent = '';
      return;
    }

    tableBody.innerHTML = '';
    rows.forEach(r => {
      tableBody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${r["Ng√†y"]}</td>
          <td>${r["V√†o s√°ng"]}</td>
          <td>${r["Ra s√°ng"]}</td>
          <td>${r["V√†o chi·ªÅu"]}</td>
          <td>${r["Ra chi·ªÅu"]}</td>
          <td>${r["V√†o l√†m th√™m"]}</td>
          <td>${r["Ra l√†m th√™m"]}</td>
          <td>${r["Gi·ªù l√†m (h)"].toFixed(2)}</td>
          <td>${r["Gi·ªù l√†m th√™m (h)"].toFixed(2)}</td>
          <td>${r["Ghi ch√∫"]}</td>
        </tr>
      `);
    });

    // D√≤ng t·ªïng c·ªông
    tableBody.insertAdjacentHTML('beforeend', `
      <tr style="background:#e9f5ff;font-weight:bold;">
        <td colspan="7">T·ªîNG C·ªòNG</td>
        <td>${tongGio.toFixed(2)}</td>
        <td>${tongLamThem.toFixed(2)}</td>
        <td></td>
      </tr>
    `);

    summaryDiv.textContent = `üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
  });
}

// ================== Xu·∫•t Excel ==================
function exportToExcel() {
  if (!currentData || currentData.length === 0) {
    alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
    return;
  }
  const ws = XLSX.utils.json_to_sheet(currentData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
  const filename = `ChamCong_${nhanvienSelect.options[nhanvienSelect.selectedIndex].text.replace(/[()]/g,'').replace(/\s+/g,'_')}.xlsx`;
  XLSX.writeFile(wb, filename);
}

// ================== S·ª± ki·ªán ==================
nhanvienSelect.addEventListener('change', () => {
  loadChamCong(nhanvienSelect.value.trim());
});

reloadBtn.addEventListener('click', loadNhanVien);
exportBtn.addEventListener('click', exportToExcel);

// ================== Kh·ªüi ƒë·ªông ==================
window.addEventListener('load', loadNhanVien);
</script>

</body>
</html>
