<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω ch·∫•m c√¥ng</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #eef5ff;
  margin: 0;
  padding: 0;
  text-align: center;
}
.container {
  max-width: 95%;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 12px rgba(0,0,0,0.1);
}
h1 {
  background-color: #2196f3;
  color: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 20px;
}
select {
  font-size: 16px;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #2196f3;
  margin-bottom: 15px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
}
th {
  background-color: #2196f3;
  color: white;
  padding: 10px;
}
td {
  border: 1px solid #ccc;
  padding: 8px;
}
td[contenteditable="true"] {
  background-color: #f3faff;
}
tr:hover {
  background-color: #f1f1f1;
}
tfoot td {
  font-weight: bold;
  background-color: #d1ecff;
}
button {
  background-color: #2196f3;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background-color: #0d8bf2;
}
</style>
</head>
<body>
<div class="container">
  <h1>üìã Qu·∫£n l√Ω ch·∫•m c√¥ng</h1>

  <select id="nhanvienSelect">
    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
  </select>

  <table id="chamcongTable">
    <thead>
      <tr>
        <th>Ng√†y</th>
        <th>Gi·ªù v√†o</th>
        <th>Gi·ªù ra</th>
        <th>V√†o l√†m th√™m</th>
        <th>Ra l√†m th√™m</th>
        <th>Gi·ªù l√†m</th>
        <th>Gi·ªù l√†m th√™m</th>
        <th>Ghi ch√∫</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="5">T·ªïng c·ªông</td>
        <td id="tongGio">0</td>
        <td id="tongGioThem">0</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  function encodeEmail(email) {
  return email.replace(/\./g, '_dot_').replace(/@/g, '_at_');
}
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const select = document.getElementById('nhanvienSelect');
const tableBody = document.querySelector('#chamcongTable tbody');
const tongGio = document.getElementById('tongGio');
const tongGioThem = document.getElementById('tongGioThem');

// === L·∫•y danh s√°ch nh√¢n vi√™n ===
firebase.database().ref('nhanvien').once('value').then(snapshot => {
  snapshot.forEach(child => {
    const nv = child.val();
    const opt = document.createElement('option');
    opt.value = nv.email;
    opt.textContent = nv.ten;
    select.appendChild(opt);
  });
});

// === Khi ch·ªçn nh√¢n vi√™n ===
select.addEventListener('change', () => {
  const email = select.value;
  if (!email) {
    tableBody.innerHTML = '';
    tongGio.textContent = tongGioThem.textContent = 0;
    return;
  }
const selectedEmail = document.getElementById('nhanvienSelect').value;
if (!selectedEmail) return;

const emailKey = encodeEmail(selectedEmail);
const chamCongRef = db.ref('chamcong/' + emailKey);

chamCongRef.once('value').then(snapshot => {
  const data = snapshot.val();
  if (!data) {
    tableBody.innerHTML = '<tr><td colspan="10">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng!</td></tr>';
    return;
  }

  // render ra b·∫£ng
  renderChamCongTable(data);
});
  function renderChamCongTable(data) {
  const tableBody = document.querySelector('#chamcongTable tbody');
  tableBody.innerHTML = '';

  Object.entries(data).forEach(([date, info]) => {
    const row = `
      <tr>
        <td>${date}</td>
        <td>${info.vaoCaSang || '-'}</td>
        <td>${info.raCaSang || '-'}</td>
        <td>${info.vaoCaChieu || '-'}</td>
        <td>${info.raCaChieu || '-'}</td>
        <td>${info.vaoLamThem || '-'}</td>
        <td>${info.raLamThem || '-'}</td>
        <td>${info.gioLamTrongNgay || '-'}</td>
        <td>${info.gioLamThem || '-'}</td>
        <td>${info.ghiChu || ''}</td>
      </tr>
    `;
    tableBody.insertAdjacentHTML('beforeend', row);
  });
}

  firebase.database().ref('chamcong').orderByChild('email').equalTo(email).once('value')
  .then(snapshot => {
    tableBody.innerHTML = '';
    let total = 0, totalExtra = 0;

    snapshot.forEach(child => {
      const data = child.val();
      const key = child.key;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${data.ngay || ''}</td>
        <td contenteditable="true">${data.gioVao || ''}</td>
        <td contenteditable="true">${data.gioRa || ''}</td>
        <td contenteditable="true">${data.gioVaoThem || ''}</td>
        <td contenteditable="true">${data.gioRaThem || ''}</td>
        <td>${data.gioLam || 0}</td>
        <td>${data.gioLamThem || 0}</td>
        <td contenteditable="true">${data.ghichu || ''}</td>
        <td><button onclick="xoa('${key}')">X√≥a</button></td>
      `;
      tableBody.appendChild(row);

      total += parseFloat(data.gioLam || 0);
      totalExtra += parseFloat(data.gioLamThem || 0);

      row.querySelectorAll('[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('blur', () => capNhat(child.key, row));
      });
    });

    tongGio.textContent = total.toFixed(1);
    tongGioThem.textContent = totalExtra.toFixed(1);
  });
});

function capNhat(id, row) {
  const tds = row.querySelectorAll('td');
  const data = {
    gioVao: tds[1].textContent.trim(),
    gioRa: tds[2].textContent.trim(),
    gioVaoThem: tds[3].textContent.trim(),
    gioRaThem: tds[4].textContent.trim(),
    ghichu: tds[7].textContent.trim(),
  };

  // T√≠nh gi·ªù l√†m
  data.gioLam = tinhGio(data.gioVao, data.gioRa);
  data.gioLamThem = tinhGio(data.gioVaoThem, data.gioRaThem);
  tds[5].textContent = data.gioLam;
  tds[6].textContent = data.gioLamThem;

  firebase.database().ref('chamcong/' + id).update(data);
}

function tinhGio(gioVao, gioRa) {
  if (!gioVao || !gioRa) return 0;
  const [h1,m1] = gioVao.split(':').map(Number);
  const [h2,m2] = gioRa.split(':').map(Number);
  const diff = (h2*60+m2)-(h1*60+m1);
  return diff>0 ? (diff/60).toFixed(1) : 0;
}

function xoa(id) {
  if (confirm("X√≥a d√≤ng n√†y?")) {
    firebase.database().ref('chamcong/' + id).remove();
    select.dispatchEvent(new Event('change'));
  }
}
</script>
</body>
</html>

