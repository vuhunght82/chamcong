<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng nh√¢n vi√™n</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f0f4f8; margin:0; padding:20px; text-align:center;}
  h1 { color:#007bff; margin-bottom:20px; }
  select, input[type="month"], button { padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; margin:5px; outline:none;}
  button { background-color:#007bff; color:white; cursor:pointer; transition: 0.2s; }
  button:hover { background-color:#0056b3; }
  table { width:100%; max-width:1000px; margin:20px auto; border-collapse:collapse; box-shadow:0 4px 10px rgba(0,0,0,0.1); background-color:white; }
  th { background-color:#4da6ff; color:white; padding:10px; }
  td { padding:8px; border:1px solid #ddd; text-align:center; }
  tr:hover { background-color:#f1f9ff; }
  .deleteBtn { background:#ff4d4f; color:white; padding:4px 8px; border:none; border-radius:5px; cursor:pointer; transition:0.2s; }
  .deleteBtn:hover { background:#c82333; }
  #summary { margin-top:20px; font-weight:bold; color:#333; }
</style>
</head>
<body>

<h1>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng</h1>

<div>
  <label for="nhanvienSelect">Nh√¢n vi√™n:</label>
  <select id="nhanvienSelect">
    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
  </select>

  <label for="monthSelect">Th√°ng:</label>
  <input type="month" id="monthSelect">

  <button id="reloadBtn">üîÑ T·∫£i l·∫°i</button>
  <button id="exportBtn">üìä Xu·∫•t Excel</button>
</div>

<table id="chamcongTable">
  <thead>
    <tr>
      <th>Ng√†y</th>
      <th>V√†o s√°ng</th>
      <th>Ra s√°ng</th>
      <th>V√†o chi·ªÅu</th>
      <th>Ra chi·ªÅu</th>
      <th>V√†o l√†m th√™m</th>
      <th>Ra l√†m th√™m</th>
      <th>Gi·ªù l√†m (h)</th>
      <th>Gi·ªù l√†m th√™m (h)</th>
      <th>Ghi ch√∫</th>
      <th>X√≥a</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
  </tbody>
</table>

<div id="summary"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ================== Firebase Config ==================
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================== Elements ==================
const nhanvienSelect = document.getElementById('nhanvienSelect');
const monthSelect = document.getElementById('monthSelect');
const tableBody = document.querySelector('#chamcongTable tbody');
const summaryDiv = document.getElementById('summary');
const reloadBtn = document.getElementById('reloadBtn');
const exportBtn = document.getElementById('exportBtn');

let currentData = []; // d·ªØ li·ªáu hi·ªÉn th·ªã

// ================== Set th√°ng hi·ªán t·∫°i ==================
(function(){
  const now = new Date();
  monthSelect.value = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
})();

// ================== Load danh s√°ch nh√¢n vi√™n ==================
function loadNhanVien() {
  db.ref('nhanvien').once('value').then(snapshot => {
    nhanvienSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
    snapshot.forEach(child => {
      const nv = child.val();
      nhanvienSelect.insertAdjacentHTML('beforeend', `<option value="${nv.email}">${nv.ten} (${nv.email})</option>`);
    });
    // load d·ªØ li·ªáu nh√¢n vi√™n ƒë·∫ßu ti√™n n·∫øu c√≥
    if(nhanvienSelect.value) loadChamCong(nhanvienSelect.value, monthSelect.value);
  });
}

// ================== Load ch·∫•m c√¥ng ==================
function loadChamCong(email, month){
  if(!email){
    tableBody.innerHTML = '<tr><td colspan="11">Vui l√≤ng ch·ªçn nh√¢n vi√™n.</td></tr>';
    summaryDiv.textContent = '';
    currentData = [];
    return;
  }
  tableBody.innerHTML = '<tr><td colspan="11">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

  db.ref('chamcong/' + encodeEmail(email)).once('value').then(snapshot => {
    const data = snapshot.val() || {};
    const rows = [];
    let tongGio = 0;
    let tongLamThem = 0;

    for(const ngay in data){
      if(!month || ngay.startsWith(month)){
        const info = data[ngay];
        const gioLam = parseFloat(info.gioLamTrongNgay || 0);
        const gioLamThem = parseFloat(info.gioLamThem || 0);
        rows.push({
          Ngay: ngay,
          vaoCaSang: info.vaoCaSang || '-',
          raCaSang: info.raCaSang || '-',
          vaoCaChieu: info.vaoCaChieu || '-',
          raCaChieu: info.raCaChieu || '-',
          vaoLamThem: info.vaoLamThem || '-',
          raLamThem: info.raLamThem || '-',
          gioLam: gioLam,
          gioLamThem: gioLamThem,
          ghiChu: info.ghiChu || ''
        });
        tongGio += gioLam;
        tongLamThem += gioLamThem;
      }
    }

    currentData = rows;

    if(rows.length===0){
      tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
      summaryDiv.textContent = '';
      return;
    }

    tableBody.innerHTML = '';
    rows.forEach((r,index)=>{
      tableBody.insertAdjacentHTML('beforeend',`
        <tr data-ngay="${r.Ngay}">
          <td contenteditable="true">${r.Ngay}</td>
          <td contenteditable="true">${r.vaoCaSang}</td>
          <td contenteditable="true">${r.raCaSang}</td>
          <td contenteditable="true">${r.vaoCaChieu}</td>
          <td contenteditable="true">${r.raCaChieu}</td>
          <td contenteditable="true">${r.vaoLamThem}</td>
          <td contenteditable="true">${r.raLamThem}</td>
          <td contenteditable="true">${r.gioLam.toFixed(2)}</td>
          <td contenteditable="true">${r.gioLamThem.toFixed(2)}</td>
          <td contenteditable="true">${r.ghiChu}</td>
          <td><button class="deleteBtn">X√≥a</button></td>
        </tr>
      `);
    });

    // T·ªïng c·ªông
    tableBody.insertAdjacentHTML('beforeend',`
      <tr style="background:#e9f5ff;font-weight:bold;">
        <td colspan="7">T·ªîNG C·ªòNG</td>
        <td>${tongGio.toFixed(2)}</td>
        <td>${tongLamThem.toFixed(2)}</td>
        <td colspan="2"></td>
      </tr>
    `);

    summaryDiv.textContent = `üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
  });
}

// ================== Encode email ==================
function encodeEmail(email){ return email.replace(/\./g,','); }

// ================== X√≥a d√≤ng ==================
tableBody.addEventListener('click', e=>{
  if(e.target.classList.contains('deleteBtn')){
    const tr = e.target.closest('tr');
    const date = tr.dataset.ngay;
    const email = nhanvienSelect.value;
    if(confirm(`X√≥a d·ªØ li·ªáu ng√†y ${date}?`)){
      db.ref(`chamcong/${encodeEmail(email)}/${date}`).remove()
        .then(()=>{ tr.remove(); alert('‚úÖ X√≥a th√†nh c√¥ng'); })
        .catch(err=>alert('‚ùå L·ªói: '+err));
    }
  }
});

// ================== Xu·∫•t Excel ==================
exportBtn.addEventListener('click', ()=>{
  if(!currentData || currentData.length===0){ alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.'); return; }
  const ws = XLSX.utils.json_to_sheet(currentData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
  const filename = `ChamCong_${nhanvienSelect.options[nhanvienSelect.selectedIndex].text.replace(/[()]/g,'').replace(/\s+/g,'_')}.xlsx`;
  XLSX.writeFile(wb, filename);
});

// ================== S·ª± ki·ªán ==================
nhanvienSelect.addEventListener('change', ()=>loadChamCong(nhanvienSelect.value, monthSelect.value));
monthSelect.addEventListener('change', ()=>loadChamCong(nhanvienSelect.value, monthSelect.value));
reloadBtn.addEventListener('click', loadNhanVien);

// ================== Kh·ªüi ƒë·ªông ==================
window.addEventListener('load', loadNhanVien);

</script>
</body>
</html>
