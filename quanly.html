<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng</title>
    <style>
        .extra-col {
            background-color: #d0e7ff; /* xanh d∆∞∆°ng nh·∫°t */
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #007bff;
            margin-bottom: 20px;
        }

        select, input[type="month"], button {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin: 5px;
            outline: none;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }

            button:hover {
                background-color: #0056b3;
            }

        table {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background-color: white;
        }

        th {
            background-color: #4da6ff;
            color: white;
            padding: 10px;
        }

        td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        tr:hover {
            background-color: #f1f9ff;
        }

        .deleteBtn {
            background: #ff4d4f;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

            .deleteBtn:hover {
                background: #c82333;
               
            }

        #summary {
            margin-top: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>

    <h1>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng</h1>

    <div>
        <label for="nhanvienSelect">Nh√¢n vi√™n:</label>
        <select id="nhanvienSelect">
            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
        </select>

        <label for="monthSelect">Th√°ng:</label>
        <input type="month" id="monthSelect">

        <button id="reloadBtn">üîÑ T·∫£i l·∫°i</button>
        <button id="exportBtn">üìä Xu·∫•t Excel</button>
    </div>

    <table id="chamcongTable">
        <thead>
            <tr>
                <th>Ng√†y</th>
                <th>V√†o s√°ng</th>
                <th>Ra s√°ng</th>
                <th>V√†o tr∆∞a</th>
                <th>Ra tr∆∞a</th>
                <th>V√†o chi·ªÅu</th>
                <th>Ra chi·ªÅu</th>

                <th>V√†o l√†m th√™m</th>
                <th>Ra l√†m th√™m</th>
                <th>Gi·ªù l√†m (h)</th>
                <th>Gi·ªù l√†m th√™m (h)</th>
                <th>Ghi ch√∫</th>
                <th>X√≥a</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
        </tbody>
    </table>

    <div id="summary"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ================== Firebase Config ==================
        const firebaseConfig = {
            apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
            authDomain: "sellglass-3ebe9.firebaseapp.com",
            databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sellglass-3ebe9",
            storageBucket: "sellglass-3ebe9.appspot.com",
            messagingSenderId: "513741829035",
            appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================== Elements ==================
        const nhanvienSelect = document.getElementById('nhanvienSelect');
        const monthSelect = document.getElementById('monthSelect');
        const tableBody = document.querySelector('#chamcongTable tbody');
        const summaryDiv = document.getElementById('summary');
        const reloadBtn = document.getElementById('reloadBtn');
        const exportBtn = document.getElementById('exportBtn');

        let currentData = [];

        // ================== Load danh s√°ch nh√¢n vi√™n ==================
        function loadNhanVien() {
            db.ref('users').once('value').then(snapshot => {
                nhanvienSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
                snapshot.forEach(child => {
                    const nv = child.val();
                    nhanvienSelect.insertAdjacentHTML('beforeend', `<option value="${nv.username}">${nv.hoten} (${nv.username})</option>`);
                });
            });
        }

       

        // ================== H√†m parse gi·ªù hh:mm -> s·ªë gi·ªù ==================
        function parseHour(timeStr) {
            if (!timeStr || timeStr === '-') return 0;
            const [h, m] = timeStr.split(':').map(Number);
            if (isNaN(h) || isNaN(m)) return 0;
            return h + m / 60;
        }

        // ================== T√≠nh gi·ªù cho 1 d√≤ng ==================
        function calculateHours(tr) {
            const vaoSang = parseHour(tr.children[1].textContent.trim());
            const raSang = parseHour(tr.children[2].textContent.trim());
            const vaoTrua = parseHour(tr.children[3].textContent.trim());
            const raTrua = parseHour(tr.children[4].textContent.trim());
            const vaoChieu = parseHour(tr.children[5].textContent.trim());
            const raChieu = parseHour(tr.children[6].textContent.trim());
            const vaoLamThem = parseHour(tr.children[7].textContent.trim());
            const raLamThem = parseHour(tr.children[8].textContent.trim());

            const gioLam = (raSang - vaoSang) + (raChieu - vaoChieu);
            const gioLamThem =  (raTrua - vaoTrua) +( raLamThem - vaoLamThem);

          tr.children[9].textContent = gioLam.toFixed(2);
          tr.children[10].textContent = gioLamThem.toFixed(2);

            return { gioLam, gioLamThem };
        }

        // ================== C·∫≠p nh·∫≠t t·ªïng c·ªông ==================
        function updateTotals() {
            let tongGio = 0;
            let tongLamThem = 0;

            const dataRows = tableBody.querySelectorAll('tr[data-ngay]');
            dataRows.forEach(tr => {
                const { gioLam, gioLamThem } = calculateHours(tr);
                tongGio += gioLam;
                tongLamThem += gioLamThem;
            });

            // t·∫°o ho·∫∑c c·∫≠p nh·∫≠t d√≤ng t·ªïng c·ªông
            let totalRow = tableBody.querySelector('tr.total-row');
            if (!totalRow) {
                totalRow = document.createElement('tr');
                totalRow.classList.add('total-row');
                totalRow.style.background = "#e9f5ff";
                totalRow.style.fontWeight = "bold";

                // t·∫°o ƒë·ªß 13 c·ªôt
                for (let i = 0; i < 13; i++) {
                    const td = document.createElement('td');
                    totalRow.appendChild(td);
                }
                tableBody.appendChild(totalRow);
            }

            // g√°n gi√° tr·ªã
        //    totalRow.children[0].textContent = "T·ªîNG C·ªòNG";
        //    totalRow.children[7].textContent = tongGio.toFixed(2);
       //     totalRow.children[8].textContent = tongLamThem.toFixed(2);
           

           //  c√°c c·ªôt kh√°c ƒë·ªÉ tr·ªëng
            //for (let i = 1; i < 7; i++) totalRow.children[i].textContent = "";
            //totalRow.children[11].textContent = "";
            //totalRow.children[12].textContent = "";
           

            summaryDiv.textContent = `üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
        }


        // ================== H√†m l·∫•y th√°ng t·ª´ ng√†y ==================
        function getMonthFromDateStr(dateStr) {
            return dateStr.substring(0, 7);
        }

        // ================== Load d·ªØ li·ªáu ch·∫•m c√¥ng ==================
        function loadChamCong(email, month) {
            if (!email) {
                tableBody.innerHTML = '<tr><td colspan="11">Vui l√≤ng ch·ªçn nh√¢n vi√™n.</td></tr>';
                summaryDiv.textContent = '';
                currentData = [];
                return;
            }

            tableBody.innerHTML = '<tr><td colspan="11">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('chamcong/' + encodeEmail(email)).once('value').then(snapshot => {
                const data = snapshot.val();
                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
                    summaryDiv.textContent = '';
                    currentData = [];
                    return;
                }

                const rows = [];
                for (let ngay in data) {
                    const info = data[ngay];
                    if (!month || getMonthFromDateStr(ngay) === month) {
                        const gioLam = parseFloat(info.gioLamTrongNgay || 0);
                        const gioLamThem = parseFloat(info.gioLamThem || 0);
                        rows.push({
                            Ngay: ngay,
                            vaoCaSang: info.vaoCaSang || '-',
                            noteVaoCaSang: info.noteVaoCaSang || '-',

                            raCaSang: info.raCaSang || '-',
                            noteRaCaSang: info.noteRaCaSang || '-',

                            vaoCaTrua: info.vaoCaTrua || '-',
                            noteVaoCaTrua: info.noteVaoCaTrua || '',
                            raCaTrua: info.raCaTrua || '-',
                            noteRaCaTrua:info.noteRaCaTrua || '-',

                            vaoCaChieu: info.vaoCaChieu || '-',
                            noteVaoCaChieu: info.noteVaoCaChieu || '-',
                           
                            raCaChieu: info.raCaChieu || '-',
                            noteRaCaChieu: info.noteRaCaChieu || '-',

                            vaoLamThem: info.vaoLamThem || '-',
                            noteVaoLamThem: info.noteVaoLamThem||'-',
                            raLamThem: info.raLamThem || '-',
                            noteRaLamThem: info.noteRaLamThem||'-',
                            gioLam: gioLam,
                            gioLamThem: gioLamThem,
                            ghiChu: info.ghiChu || '-'
                        });
                    }
                }

                currentData = rows;

                if (rows.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
                    summaryDiv.textContent = '';
                    return;
                }

                // hi·ªÉn th·ªã b·∫£ng
                tableBody.innerHTML = '';
                rows.forEach((r) => {
                    tableBody.insertAdjacentHTML('beforeend', `
           <!-- D√≤ng ch√≠nh -->
        <tr data-ngay="${r.Ngay}" class="main-row">
          <td contenteditable="true" >${r.Ngay}</td>
          <td contenteditable="true">${r.vaoCaSang}</td>
          <td contenteditable="true">${r.raCaSang}</td>
           <td contenteditable="true" style="background-color: #ffcc33;">${r.vaoCaTrua}</td>
          <td contenteditable="true" style="background-color: #ffcc33;">${r.raCaTrua}</td>

          <td contenteditable="true">${r.vaoCaChieu}</td>
          <td contenteditable="true">${r.raCaChieu}</td>
          <td contenteditable="true" class="extra-col">${r.vaoLamThem}</td>
          <td contenteditable="true" class="extra-col">${r.raLamThem}</td>
          <td contenteditable="true" rowspan="2"  >${r.gioLam.toFixed(2)}</td>
          <td contenteditable="true" rowspan="2">${r.gioLamThem.toFixed(2)}</td>
          <td contenteditable="true" rowspan="2"> ${r.ghiChu || ''}</td>

          <td><button class="deleteBtn">X√≥a</button></td>
        </tr>

        <!-- D√≤ng ghi ch√∫ th√™m -->
        <tr class="note-row" style="background-color: #f4e191;">
    <td style="font-size:12px">tr·∫°ng th√°i</td>
    <td contenteditable="true">${r.noteVaoCaSang}</td>
    <td contenteditable="true">${r.noteRaCaSang}</td>
    <td contenteditable="true">${r.noteVaoCaTrua}</td>
    <td contenteditable="true">${r.noteRaCaTrua}</td>
    <td contenteditable="true">${r.noteVaoCaChieu}</td>
    <td contenteditable="true">${r.noteRaCaChieu}</td>
    <td contenteditable="true">${r.noteVaoLamThem}</td>
    <td contenteditable="true">${r.noteRaLamThem}</td>

    <!-- 3 c·ªôt cu·ªëi ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ªïng = 13 c·ªôt -->
    
</tr>
            
          `);
                });

                updateTotals(); // t√≠nh t·ªïng sau khi hi·ªÉn th·ªã
                highlightNoteRows();
            });
        }

        // ================== Encode email ==================
        function encodeEmail(email) { return email.replace(/\./g, ','); }

        // ================== C·∫≠p nh·∫≠t d·ªØ li·ªáu khi s·ª≠a b·∫£ng ==================
        tableBody.addEventListener('input', e => {
            const tr = e.target.closest('tr');

            // ============================================
            // üü¶ 1) N·∫æU L√Ä D√íNG CH√çNH (c√≥ data-ngay)
            // ============================================
            if (tr && tr.dataset.ngay) {
                const ngay = tr.dataset.ngay;
                const email = nhanvienSelect.value;

                const vaoCaSang = tr.children[1].textContent.trim();
                const raCaSang = tr.children[2].textContent.trim();
                const vaoCaTrua = tr.children[3].textContent.trim();
                const raCaTrua = tr.children[4].textContent.trim();
                const vaoCaChieu = tr.children[5].textContent.trim();
                const raCaChieu = tr.children[6].textContent.trim();
                const vaoLamThem = tr.children[7].textContent.trim();
                const raLamThem = tr.children[8].textContent.trim();
                const ghiChu = tr.children[11].textContent;

                // L·∫•y note-row
                const noteRow = tr.nextElementSibling;

                const noteVaoCaSang = noteRow.children[1].textContent.trim();
                const noteRaCaSang = noteRow.children[2].textContent.trim();
                const noteVaoCaTrua = noteRow.children[3].textContent.trim();
                const noteRaCaTrua = noteRow.children[4].textContent.trim();
                const noteVaoCaChieu = noteRow.children[5].textContent.trim();
                const noteRaCaChieu = noteRow.children[6].textContent.trim();
                const noteVaoLamThem = noteRow.children[7].textContent.trim();
                const noteRaLamThem = noteRow.children[8].textContent.trim();

                const { gioLam, gioLamThem } = calculateHours(tr);

                const updateData = {
                    vaoCaSang, raCaSang,
                    vaoCaTrua, raCaTrua,
                    vaoCaChieu, raCaChieu,
                    vaoLamThem, raLamThem,
                    ghiChu,
                    noteVaoCaSang, noteRaCaSang,
                    noteVaoCaTrua, noteRaCaTrua,
                    noteVaoCaChieu, noteRaCaChieu,
                    noteVaoLamThem, noteRaLamThem,
                    gioLamTrongNgay: gioLam,
                    gioLamThem: gioLamThem
                };

                db.ref("chamcong/" + encodeEmail(email) + "/" + ngay).update(updateData);
                updateTotals();
               
                return;
            }

            // ============================================
            // üü© 2) N·∫æU L√Ä D√íNG NOTE-ROW (KH√îNG c√≥ data-ngay)
            // ============================================
            if (tr && tr.classList.contains("note-row")) {
                const mainRow = tr.previousElementSibling;
                const ngay = mainRow.dataset.ngay;
                const email = nhanvienSelect.value;

                const noteVaoCaSang = tr.children[1].textContent.trim();
                const noteRaCaSang = tr.children[2].textContent.trim();
                const noteVaoCaTrua = tr.children[3].textContent.trim();
                const noteRaCaTrua = tr.children[4].textContent.trim();
                const noteVaoCaChieu = tr.children[5].textContent.trim();
                const noteRaCaChieu = tr.children[6].textContent.trim();
                const noteVaoLamThem = tr.children[7].textContent.trim();
                const noteRaLamThem = tr.children[8].textContent.trim();

                db.ref("chamcong/" + encodeEmail(email) + "/" + ngay).update({
                    noteVaoCaSang,
                    noteRaCaSang,
                    noteVaoCaTrua,
                    noteRaCaTrua,
                    noteVaoCaChieu,
                    noteRaCaChieu,
                    noteVaoLamThem,
                    noteRaLamThem
                });
            }
        });


        // ================== X√≥a d√≤ng ==================
        tableBody.addEventListener('click', e => {
            if (e.target.classList.contains('deleteBtn')) {
                const tr = e.target.closest('tr');
                const ngay = tr.dataset.ngay;
                const email = nhanvienSelect.value;
                if (confirm(`X√≥a d·ªØ li·ªáu ng√†y ${ngay}?`)) {
                    db.ref('chamcong/' + encodeEmail(email) + '/' + ngay).remove()
                        .then(() => { tr.remove(); updateTotals(); alert('‚úÖ X√≥a th√†nh c√¥ng'); })
                        .catch(err => alert('‚ùå L·ªói: ' + err));
                }
            }
        });

        // ================== Xu·∫•t Excel ==================
        function exportToExcel() {
            if (!currentData || currentData.length === 0) { alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.'); return; }
            const ws = XLSX.utils.json_to_sheet(currentData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
            const filename = `ChamCong_${nhanvienSelect.options[nhanvienSelect.selectedIndex].text.replace(/[()]/g, '').replace(/\s+/g, '_')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // ================== S·ª± ki·ªán ==================
        nhanvienSelect.addEventListener('change', () => loadChamCong(nhanvienSelect.value, monthSelect.value));
        monthSelect.addEventListener('change', () => loadChamCong(nhanvienSelect.value, monthSelect.value));
        reloadBtn.addEventListener('click', loadNhanVien);
        exportBtn.addEventListener('click', exportToExcel);

        // ================== Kh·ªüi ƒë·ªông ==================
        window.addEventListener('load', () => {
            loadNhanVien();
            const today = new Date();
            monthSelect.value = today.toISOString().substring(0, 7);
        });

        function highlightNoteRows() {
            const noteRows = document.querySelectorAll(".note-row");

            noteRows.forEach(row => {
                for (let i = 1; i <= 8; i++) {
                    let cell = row.children[i];
                    let text = cell.textContent.toLowerCase();

                    if (text.includes("ƒëi s·ªõm")) {
                        cell.style.background = "#C8F7C5"; // xanh nh·∫°t
                        cell.style.color = "green";
                    } else if (text.trim() !== "") {
                        cell.style.background = "#FFD2D2"; // ƒë·ªè nh·∫°t
                        cell.style.color = "red";
                    } else {
                        cell.style.background = ""; // reset n·∫øu √¥ tr·ªëng
                        cell.style.color = "black";
                    }
                }
            });
        }
    </script>
</body>
</html>


