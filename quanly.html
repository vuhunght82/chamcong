<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng nh√¢n vi√™n</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f0f4f8; margin:0; padding:20px; text-align:center;}
  h1 { color:#007bff; margin-bottom:20px; }
  select, input[type="month"], button { padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; margin:5px; outline:none;}
  button { background-color:#007bff; color:white; cursor:pointer; }
  button:hover { background-color:#0056b3; }
  table { width:100%; max-width:1000px; margin:20px auto; border-collapse:collapse; box-shadow:0 4px 10px rgba(0,0,0,0.1); background-color:white; }
  th { background-color:#007bff; color:white; padding:10px; }
  td { padding:8px; border:1px solid #ddd; text-align:center; }
  tr:hover { background-color:#f1f9ff; }
  .deleteBtn { background:#ff4d4f; color:white; padding:4px 8px; border:none; border-radius:5px; cursor:pointer; }
  .deleteBtn:hover { background:#c82333; }
  #summary { margin-top:20px; font-weight:bold; color:#333; }
</style>
</head>
<body>

<h1>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng</h1>

<div>
  <label for="nhanvienSelect">Nh√¢n vi√™n:</label>
  <select id="nhanvienSelect">
    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
  </select>

  <label for="monthSelect">Th√°ng:</label>
  <input type="month" id="monthSelect">
  
  <button id="reloadBtn">üîÑ T·∫£i l·∫°i</button>
  <button id="exportBtn">üìä Xu·∫•t Excel</button>
</div>

<table id="chamcongTable">
  <thead>
    <tr>
      <th>Ng√†y</th>
      <th>V√†o s√°ng</th>
      <th>Ra s√°ng</th>
      <th>V√†o chi·ªÅu</th>
      <th>Ra chi·ªÅu</th>
      <th>V√†o l√†m th√™m</th>
      <th>Ra l√†m th√™m</th>
      <th>Gi·ªù l√†m (h)</th>
      <th>Gi·ªù l√†m th√™m (h)</th>
      <th>Ghi ch√∫</th>
      <th>X√≥a</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
  </tbody>
</table>

<div id="summary"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ================== Firebase Config ==================
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================== Elements ==================
const nhanvienSelect = document.getElementById('nhanvienSelect');
const monthSelect = document.getElementById('monthSelect');
const tableBody = document.querySelector('#chamcongTable tbody');
const summaryDiv = document.getElementById('summary');
const reloadBtn = document.getElementById('reloadBtn');
const exportBtn = document.getElementById('exportBtn');

let currentData = []; // d·ªØ li·ªáu hi·ªÉn th·ªã

// ================== Load danh s√°ch nh√¢n vi√™n ==================
function loadNhanVien() {
  db.ref('nhanvien').once('value').then(snapshot => {
    nhanvienSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
    snapshot.forEach(child => {
      const nv = child.val();
      nhanvienSelect.insertAdjacentHTML('beforeend', `<option value="${nv.email}">${nv.ten} (${nv.email})</option>`);
    });
  });
}

// ================== H√†m t√≠nh gi·ªù l√†m ==================
function computeHours(info){
  let gioLam=0, gioLamThem=0;
  function toHour(time){
    if(!time || time==='-') return 0;
    const [h,m] = time.split(':');
    return parseInt(h)+parseInt(m)/60;
  }
  if(info.vaoCaSang && info.raCaSang) gioLam += toHour(info.raCaSang)-toHour(info.vaoCaSang);
  if(info.vaoCaChieu && info.raCaChieu) gioLam += toHour(info.raCaChieu)-toHour(info.vaoCaChieu);
  if(info.vaoLamThem && info.raLamThem) gioLamThem += toHour(info.raLamThem)-toHour(info.vaoLamThem);
  return {gioLam, gioLamThem};
}

// ================== Load d·ªØ li·ªáu ch·∫•m c√¥ng ==================
function loadChamCong(email, month){
  if(!email){
    tableBody.innerHTML='<tr><td colspan="11">Vui l√≤ng ch·ªçn nh√¢n vi√™n.</td></tr>';
    summaryDiv.textContent='';
    currentData=[];
    return;
  }
  tableBody.innerHTML='<tr><td colspan="11">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

  db.ref('chamcong').once('value').then(snapshot=>{
    const data = snapshot.val();
    const rows=[];
    let tongGio=0, tongLamThem=0;

    for(let key in data){
      const nhanvienData = data[key];
      for(let ngay in nhanvienData){
        const info = nhanvienData[ngay];
        if(info.email && info.email.includes(email) && (!month || ngay.startsWith(month))){
          const {gioLam, gioLamThem} = computeHours(info);
          rows.push({
            key:key,
            Ngay:ngay,
            vaoCaSang:info.vaoCaSang||'-',
            raCaSang:info.raCaSang||'-',
            vaoCaChieu:info.vaoCaChieu||'-',
            raCaChieu:info.raCaChieu||'-',
            vaoLamThem:info.vaoLamThem||'-',
            raLamThem:info.raLamThem||'-',
            gioLam, gioLamThem,
            ghiChu:info.ghiChu||''
          });
          tongGio+=gioLam;
          tongLamThem+=gioLamThem;
        }
      }
    }

    currentData=rows;

    if(rows.length===0){
      tableBody.innerHTML='<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
      summaryDiv.textContent='';
      return;
    }

    tableBody.innerHTML='';
    rows.forEach(r=>{
      tableBody.insertAdjacentHTML('beforeend',`
        <tr data-key="${r.key}" data-ngay="${r.Ngay}">
          <td contenteditable="true">${r.Ngay}</td>
          <td contenteditable="true">${r.vaoCaSang}</td>
          <td contenteditable="true">${r.raCaSang}</td>
          <td contenteditable="true">${r.vaoCaChieu}</td>
          <td contenteditable="true">${r.raCaChieu}</td>
          <td contenteditable="true">${r.vaoLamThem}</td>
          <td contenteditable="true">${r.raLamThem}</td>
          <td contenteditable="true">${r.gioLam.toFixed(2)}</td>
          <td contenteditable="true">${r.gioLamThem.toFixed(2)}</td>
          <td contenteditable="true">${r.ghiChu}</td>
          <td><button class="deleteBtn">X√≥a</button></td>
        </tr>
      `);
    });

    // T·ªïng c·ªông
    tableBody.insertAdjacentHTML('beforeend',`
      <tr style="background:#e9f5ff;font-weight:bold;" id="totalRow">
        <td colspan="7">T·ªîNG C·ªòNG</td>
        <td>${tongGio.toFixed(2)}</td>
        <td>${tongLamThem.toFixed(2)}</td>
        <td colspan="2"></td>
      </tr>
    `);
    summaryDiv.textContent=`üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
  });
}

// ================== S·ª≠a d·ªØ li·ªáu tr·ª±c ti·∫øp ==================
tableBody.addEventListener('blur', e=>{
  if(!e.target.isContentEditable) return;
  const tr = e.target.closest('tr');
  if(!tr || !tr.dataset.key) return;
  const key = tr.dataset.key;
  const ngay = tr.dataset.ngay;
  const cells = tr.children;

  const updated={
    vaoCaSang:cells[1].textContent.trim(),
    raCaSang:cells[2].textContent.trim(),
    vaoCaChieu:cells[3].textContent.trim(),
    raCaChieu:cells[4].textContent.trim(),
    vaoLamThem:cells[5].textContent.trim(),
    raLamThem:cells[6].textContent.trim(),
    ghiChu:cells[9].textContent.trim()
  };

  const {gioLam, gioLamThem} = computeHours(updated);
  cells[7].textContent = gioLam.toFixed(2);
  cells[8].textContent = gioLamThem.toFixed(2);

  db.ref(`chamcong/${key}/${ngay}`).update(updated)
    .then(()=>console.log('‚úÖ C·∫≠p nh·∫≠t Firebase th√†nh c√¥ng:', ngay))
    .catch(err=>console.error('‚ùå L·ªói Firebase:', err));

  // C·∫≠p nh·∫≠t t·ªïng c·ªông
  let tongGio=0, tongLamThem=0;
  tableBody.querySelectorAll('tr[data-key]').forEach(r=>{
    const c=r.children;
    tongGio+=parseFloat(c[7].textContent)||0;
    tongLamThem+=parseFloat(c[8].textContent)||0;
  });
  const totalRow = document.getElementById('totalRow');
  if(totalRow){
    totalRow.children[7].textContent=tongGio.toFixed(2);
    totalRow.children[8].textContent=tongLamThem.toFixed(2);
  }
  summaryDiv.textContent=`üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
}, true);

// ================== X√≥a d√≤ng ==================
tableBody.addEventListener('click', e=>{
  if(e.target.classList.contains('deleteBtn')){
    const tr = e.target.closest('tr');
    const key = tr.dataset.key;
    const ngay = tr.dataset.ngay;
    if(confirm(`X√≥a d·ªØ li·ªáu ng√†y ${ngay}?`)){
      db.ref(`chamcong/${key}/${ngay}`).remove()
        .then(()=>{ tr.remove(); alert('‚úÖ X√≥a th√†nh c√¥ng'); })
        .catch(err=>alert('‚ùå L·ªói: '+err));
    }
  }
});

// ================== Xu·∫•t Excel ==================
function exportToExcel(){
  if(!currentData || currentData.length===0){ alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.'); return; }
  const ws = XLSX.utils.json_to_sheet(currentData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
  const filename = `ChamCong_${nhanvienSelect.options[nhanvienSelect.selectedIndex].text.replace(/[()]/g,'').replace(/\s+/g,'_')}.xlsx`;
  XLSX.writeFile(wb, filename);
}

// ================== S·ª± ki·ªán ==================
nhanvienSelect.addEventListener('change', ()=>loadChamCong(nhanvienSelect.value, monthSelect.value));
monthSelect.addEventListener('change', ()=>loadChamCong(nhanvienSelect.value, monthSelect.value));
reloadBtn.addEventListener('click', loadNhanVien);
exportBtn.addEventListener('click', exportToExcel);

// ================== Kh·ªüi ƒë·ªông ==================
window.addEventListener('load', loadNhanVien);
</script>

</body>
</html>
