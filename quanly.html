<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f0f4f8; margin:0; padding:20px; text-align:center;}
h1 { color:#007bff; margin-bottom:20px; }
select, input[type="month"], button { padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; margin:5px; outline:none;}
button { background-color:#007bff; color:white; cursor:pointer; transition:0.3s;}
button:hover { background-color:#0056b3; }
table { width:100%; max-width:1000px; margin:20px auto; border-collapse:collapse; box-shadow:0 4px 10px rgba(0,0,0,0.1); background-color:white; }
th { background-color:#4da6ff; color:white; padding:10px; }
td { padding:8px; border:1px solid #ddd; text-align:center; }
tr:hover { background-color:#f1f9ff; }
.deleteBtn { background:#ff4d4f; color:white; padding:4px 8px; border:none; border-radius:5px; cursor:pointer; }
.deleteBtn:hover { background:#c82333; }
#summary { margin-top:20px; font-weight:bold; color:#333; }
</style>
</head>
<body>

<h1>üë®‚Äçüíº Qu·∫£n l√Ω ch·∫•m c√¥ng</h1>

<div>
  <label for="nhanvienSelect">Nh√¢n vi√™n:</label>
  <select id="nhanvienSelect">
    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
  </select>

  <label for="monthSelect">Th√°ng:</label>
  <input type="month" id="monthSelect">

  <button id="reloadBtn">üîÑ T·∫£i l·∫°i</button>
  <button id="exportBtn">üìä Xu·∫•t Excel</button>
</div>

<table id="chamcongTable">
  <thead>
    <tr>
      <th>Ng√†y</th>
      <th>V√†o s√°ng</th>
      <th>Ra s√°ng</th>
      <th>V√†o chi·ªÅu</th>
      <th>Ra chi·ªÅu</th>
      <th>V√†o l√†m th√™m</th>
      <th>Ra l√†m th√™m</th>
      <th>Gi·ªù l√†m (h)</th>
      <th>Gi·ªù l√†m th√™m (h)</th>
      <th>Ghi ch√∫</th>
      <th>X√≥a</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
  </tbody>
</table>

<div id="summary"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ================== Firebase Config ==================
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================== Elements ==================
const nhanvienSelect = document.getElementById('nhanvienSelect');
const monthSelect = document.getElementById('monthSelect');
const tableBody = document.querySelector('#chamcongTable tbody');
const summaryDiv = document.getElementById('summary');
const reloadBtn = document.getElementById('reloadBtn');
const exportBtn = document.getElementById('exportBtn');

let currentData = []; // d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã ƒë·ªÉ xu·∫•t Excel
// c·∫≠p nh·∫≠t t·ªïng gi·ªù 
    function updateTotals() {
        let tongGio = 0;
        let tongLamThem = 0;
        const trs = tableBody.querySelectorAll('tr');
        trs.forEach(tr => {
            if (tr.dataset.ngay) { // b·ªè qua d√≤ng t·ªïng c·ªông
                const gioLam = parseFloat(tr.children[7].textContent) || 0;
                const gioLamThem = parseFloat(tr.children[8].textContent) || 0;
                tongGio += gioLam;
                tongLamThem += gioLamThem;
            }
        });

        // C·∫≠p nh·∫≠t d√≤ng t·ªïng c·ªông
        const totalRow = tableBody.querySelector('tr:last-child');
        totalRow.children[7].textContent = tongGio.toFixed(2);
        totalRow.children[8].textContent = tongLamThem.toFixed(2);

        summaryDiv.textContent = `üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
    }
    // s·ª±  ki·ªán cho b·∫£ng
    tableBody.addEventListener('input', e => {
        const tr = e.target.closest('tr');
        if (tr && tr.dataset.ngay) {
            calculateHours(tr);
            updateTotals();
        }
    });
// ================== Load danh s√°ch nh√¢n vi√™n ==================
function loadNhanVien() {
  db.ref('nhanvien').once('value').then(snapshot => {
    nhanvienSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
    snapshot.forEach(child => {
      const nv = child.val();
      nhanvienSelect.insertAdjacentHTML('beforeend', `<option value="${nv.email}">${nv.ten} (${nv.email})</option>`);
    });
  });
}

// ================== H√†m l·∫•y th√°ng t·ª´ ng√†y ==================
function getMonthFromDateStr(dateStr){
  // gi·∫£ s·ª≠ ng√†y l∆∞u Firebase l√† yyyy-mm-dd
  return dateStr.substring(0,7);
}

// ================== T√≠nh gi·ªù t·ª´ gi·ªù string hh:mm -> s·ªë gi·ªù
function parseHour(timeStr){
  if(!timeStr || timeStr==='-') return 0;
  const [h,m] = timeStr.split(':').map(Number);
  return h + m/60;
}

// ================== Load d·ªØ li·ªáu ch·∫•m c√¥ng ==================
function loadChamCong(email, month){
  if(!email){
    tableBody.innerHTML = '<tr><td colspan="11">Vui l√≤ng ch·ªçn nh√¢n vi√™n.</td></tr>';
    summaryDiv.textContent = '';
    currentData = [];
    return;
  }

  tableBody.innerHTML = '<tr><td colspan="11">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

  db.ref('chamcong/' + encodeEmail(email)).once('value').then(snapshot=>{
    const data = snapshot.val();
    if(!data){
      tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
      summaryDiv.textContent = '';
      currentData = [];
      return;
    }

    const rows = [];
    let tongGio = 0;
    let tongLamThem = 0;

    for(let ngay in data){
      const info = data[ngay];
      if(!month || getMonthFromDateStr(ngay)===month){
        const gioLam = parseFloat(info.gioLamTrongNgay||0);
        const gioLamThem = parseFloat(info.gioLamThem||0);
        rows.push({
          Ngay: ngay,
          vaoCaSang: info.vaoCaSang||'-',
          raCaSang: info.raCaSang||'-',
          vaoCaChieu: info.vaoCaChieu||'-',
          raCaChieu: info.raCaChieu||'-',
          vaoLamThem: info.vaoLamThem||'-',
          raLamThem: info.raLamThem||'-',
          gioLam: gioLam,
          gioLamThem: gioLamThem,
          ghiChu: info.ghiChu||''
        });
        tongGio += gioLam;
        tongLamThem += gioLamThem;
      }
    }

    currentData = rows;

    if(rows.length===0){
      tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
      summaryDiv.textContent = '';
      return;
    }

    // hi·ªÉn th·ªã b·∫£ng
    tableBody.innerHTML = '';
    rows.forEach((r,index)=>{
      tableBody.insertAdjacentHTML('beforeend',`
        <tr data-ngay="${r.Ngay}">
          <td contenteditable="true">${r.Ngay}</td>
          <td contenteditable="true">${r.vaoCaSang}</td>
          <td contenteditable="true">${r.raCaSang}</td>
          <td contenteditable="true">${r.vaoCaChieu}</td>
          <td contenteditable="true">${r.raCaChieu}</td>
          <td contenteditable="true">${r.vaoLamThem}</td>
          <td contenteditable="true">${r.raLamThem}</td>
          <td contenteditable="true">${r.gioLam.toFixed(2)}</td>
          <td contenteditable="true">${r.gioLamThem.toFixed(2)}</td>
          <td contenteditable="true">${r.ghiChu}</td>
          <td><button class="deleteBtn">X√≥a</button></td>
        </tr>
      `);
    });

    // T·ªïng c·ªông
    tableBody.insertAdjacentHTML('beforeend',`
      <tr style="background:#e9f5ff;font-weight:bold;">
        <td colspan="7">T·ªîNG C·ªòNG</td>
        <td>${tongGio.toFixed(2)}</td>
        <td>${tongLamThem.toFixed(2)}</td>
        <td colspan="2"></td>
      </tr>
    `);

    summaryDiv.textContent = `üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
  });
}

// ================== Encode email ==================
function encodeEmail(email){ return email.replace(/\./g,','); }

// ================== X√≥a d√≤ng ==================
tableBody.addEventListener('click', e=>{
  if(e.target.classList.contains('deleteBtn')){
    const tr = e.target.closest('tr');
    const ngay = tr.dataset.ngay;
    const email = nhanvienSelect.value;
    if(confirm(`X√≥a d·ªØ li·ªáu ng√†y ${ngay}?`)){
      db.ref('chamcong/' + encodeEmail(email) + '/' + ngay).remove()
        .then(()=>{ tr.remove(); alert('‚úÖ X√≥a th√†nh c√¥ng'); })
        .catch(err=>alert('‚ùå L·ªói: '+err));
    }
  }
});

// ================== Xu·∫•t Excel ==================
function exportToExcel(){
  if(!currentData || currentData.length===0){ alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.'); return; }
  const ws = XLSX.utils.json_to_sheet(currentData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
  const filename = `ChamCong_${nhanvienSelect.options[nhanvienSelect.selectedIndex].text.replace(/[()]/g,'').replace(/\s+/g,'_')}.xlsx`;
  XLSX.writeFile(wb, filename);
}

// ================== S·ª± ki·ªán ==================
nhanvienSelect.addEventListener('change', ()=>loadChamCong(nhanvienSelect.value, monthSelect.value));
monthSelect.addEventListener('change', ()=>loadChamCong(nhanvienSelect.value, monthSelect.value));
reloadBtn.addEventListener('click', loadNhanVien);
exportBtn.addEventListener('click', exportToExcel);

// ================== Kh·ªüi ƒë·ªông ==================
window.addEventListener('load', ()=>{
  loadNhanVien();
  // ƒë·∫∑t th√°ng m·∫∑c ƒë·ªãnh
  const today = new Date();
  monthSelect.value = today.toISOString().substring(0,7);
});
</script>
</body>
</html>

