<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>
<style>
body {
  font-family: Arial;
  text-align: center;
  background: linear-gradient(to right, #00ffcc, #00c6ff);
  margin: 0;
  padding: 0 10px;
}
h1 { color:#ffffff; margin: 15px 0; }
#video-container { margin:20px auto; width:100%; max-width:360px; border:2px solid #007bff; border-radius:10px; overflow:hidden; }
video { width:100%; height:auto; }
#result { font-weight:bold; color:green; margin-top:20px; white-space: pre-line; }
#error { color:red; margin-top:10px; }
button {
  margin: 5px;
  padding: 12px 18px;
  font-size: 16px;
  border-radius: 10px;
  background-color:green;
  color:#fff;
  border-color:#fff;
}
@media (max-width:480px){
  button, input { width:95%; font-size:1em; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init("zw8NnWti6A--Pyys9"); // giá»¯ public key EmailJS cá»§a báº¡n
  })();
</script>
</head>

<body>
<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<h1>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h1>

<div id="video-container">
  <video id="qr-video" muted></video>
</div>

<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>
<button id="restartBtn" style="display:none;">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>
<button onclick="checkLocation()">Kiá»ƒm tra vá»‹ trÃ­</button>

<script>
function checkLocation() {
  if (!navigator.geolocation) { alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ geolocation!'); return; }
  navigator.geolocation.getCurrentPosition(
    pos => alert(`VÄ© Ä‘á»™: ${pos.coords.latitude}, Kinh Ä‘á»™: ${pos.coords.longitude}`),
    err => alert(`Lá»—i: ${err.code} - ${err.message}`),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QR Scanner -->
<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== check login =====
const userEmail = sessionStorage.getItem('userEmail');
if (!userEmail) {
  alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
  window.location.href = 'index.html';
}

// ===== elements =====
const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const restartBtn = document.getElementById('restartBtn');
const logoutBtn = document.getElementById('logoutBtn');
const viewBtn = document.getElementById('viewBtn');
const beep = document.getElementById('beepSound');

let scanner = null;

// ===== scanner start =====
function startScanner(){
  resultDiv.textContent = 'Äang chá» quÃ©t QR...';
  errorDiv.textContent = '';
  restartBtn.style.display = 'none';

  // QrScanner callback tráº£ vá» string decoded text
  scanner = new QrScanner(videoElem, (decodedText) => {
    console.log('QR decoded:', decodedText);
    // Láº¥y vá»‹ trÃ­ rá»“i xá»­ lÃ½
    if (!navigator.geolocation) {
      // Náº¿u khÃ´ng cÃ³ geolocation API thÃ¬ váº«n gá»i xá»­ lÃ½ nhÆ°ng sáº½ bÃ¡o thiáº¿u vá»‹ trÃ­
      handleAttendance(userEmail, decodedText, null, null);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => handleAttendance(userEmail, decodedText, pos.coords.latitude, pos.coords.longitude),
      err => {
        console.warn('KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­:', err);
        // náº¿u user tá»« chá»‘i vá»‹ trÃ­, báº¡n cÃ³ thá»ƒ quyáº¿t Ä‘á»‹nh tá»« chá»‘i hoáº·c váº«n lÆ°u; hiá»‡n Ä‘ang tá»« chá»‘i vÃ  yÃªu cáº§u vá»‹ trÃ­
        handleAttendance(userEmail, decodedText, null, null);
      },
      { enableHighAccuracy:true, timeout:7000, maximumAge:0 }
    );
  }, { highlightScanRegion:true, highlightCodeOutline:true });

  scanner.start().then(()=> {
    console.log('Scanner started');
  }).catch(err=>{
    console.error('Cannot start scanner', err);
    errorDiv.textContent = 'âŒ KhÃ´ng thá»ƒ má»Ÿ camera: '+err;
  });
}

// ===== company config =====
const COMPANY_LOCATION = { lat: 10.849641858164617, lng: 106.58569113116769 };
const VALID_QR_CODE = "CHECKIN_GLASS_COMPANY";

// ===== handle attendance =====
function handleAttendance(email, qrContent, lat, lng){
  // báº£o Ä‘áº£m scanner tá»“n táº¡i trÆ°á»›c khi stop
  if (scanner && typeof scanner.stop === 'function') {
    try { scanner.stop(); } catch(e){ console.warn('scanner.stop error', e); }
  }

  console.log('handleAttendance', {email, qrContent, lat, lng});
  if (!qrContent) {
    alert('âŒ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c ná»™i dung QR!');
    restartBtn.style.display = 'inline-block';
    return;
  }

  if (qrContent !== VALID_QR_CODE) {
    alert('âŒ MÃ£ QR khÃ´ng há»£p lá»‡!');
    restartBtn.style.display = 'inline-block';
    return;
  }

  // Kiá»ƒm tra vá»‹ trÃ­ (náº¿u báº¡n báº¯t buá»™c pháº£i cÃ³ vá»‹ trÃ­)
  if (lat != null && lng != null) {
    const distance = getDistanceFromLatLonInMeters(lat, lng, COMPANY_LOCATION.lat, COMPANY_LOCATION.lng);
    console.log('distance', distance);
    if (distance > 100) {
      alert(`âŒ Vá»‹ trÃ­ quÃ©t quÃ¡ xa so vá»›i cÃ´ng ty (${distance.toFixed(1)} m)!`);
      restartBtn.style.display = 'inline-block';
      return;
    }
  } else {
    // náº¿u báº¡n muá»‘n Tá»ª CHá»I khi thiáº¿u GPS: hiá»‡n thÃ´ng bÃ¡o vÃ  dá»«ng
    alert('âŒ KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c vá»‹ trÃ­ quÃ©t! Vui lÃ²ng cho phÃ©p vá»‹ trÃ­ hoáº·c thá»­ láº¡i.');
    restartBtn.style.display = 'inline-block';
    return;
  }

  const now = new Date();
  const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
  const currentTime = now.toLocaleTimeString('en-GB'); // HH:MM:SS 24h preferable
  const currentHour = now.getHours() + now.getMinutes()/60;
  const emailKey = encodeEmail(email);
  const ref = db.ref('chamcong/' + emailKey + '/' + today);

  // khá»Ÿi táº¡o cÃ¡c chuá»—i ghi chÃº
  let ghichucalam = "";
  let noteVaoCaSang = "";
  let noteRaCaSang = "";
  let noteVaoCaTrua = "";
  let noteRaCaTrua = "";
  let noteVaoCaChieu = "";
  let noteRaCaChieu = "";
  let noteVaoLamThem = "";
  let noteRaLamThem = "";

  ref.once('value').then(snapshot=>{
    const data = snapshot.val() || {};

    let msg = '';
    let isOvertime = false;

    // --- Ca sÃ¡ng ---
    if (currentHour >= 7.5 && currentHour <= 11.5) {
      if (!data.vaoCaSang) {
        data.vaoCaSang = currentTime;
        if (currentHour > 7.5) {
          msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
          noteVaoCaSang += 'Äi muá»™n ca sÃ¡ng! ';
          ghichucalam += 'Äi muá»™n ca sÃ¡ng! ';
        }
      } else {
        data.raCaSang = currentTime;
        if (currentHour < 11.5) {
          msg += 'âš  Vá» sá»›m ca sÃ¡ng! ';
          noteRaCaSang += 'Vá» sá»›m ca sÃ¡ng! ';
          ghichucalam += 'Vá» sá»›m ca sÃ¡ng! ';
        }
      }
    }
    // --- Äi sá»›m ca sÃ¡ng (trÆ°á»ng há»£p quÃ©t trÆ°á»›c 7:30) ---
    else if (currentHour < 7.5) {
      data.vaoCaSang = currentTime;
      msg += 'âœ… Äi sá»›m ca sÃ¡ng! ';
      ghichucalam += 'Äi sá»›m ca sÃ¡ng! ';
    }
    // --- Nghá»‰ trÆ°a / LÃ m thÃªm giá»¯a ca (11:30 - 13:00) ---
    else if (currentHour >= 11.5 && currentHour < 13) {
      // náº¿u chÆ°a cÃ³ vÃ o trÆ°a thÃ¬ ghi vÃ o trÆ°a
      if (!data.vaoCaTrua) {
        data.vaoCaTrua = currentTime;
        noteVaoCaTrua += 'VÃ o trÆ°a';
        ghichucalam += 'VÃ o trÆ°a ';
        msg += 'â± VÃ o trÆ°a / táº¡m nghá»‰. ';
      } else if (data.vaoCaTrua && !data.raCaTrua) {
        data.raCaTrua = currentTime;
        noteRaCaTrua += 'Ra trÆ°a';
        ghichucalam += 'Ra trÆ°a ';
        msg += 'â± Ra trÆ°a. ';
      } else {
        // náº¿u Ä‘Ã£ cÃ³ cáº£ vao/ra trÆ°a, thÃ¬ tÃ­nh lÃ m thÃªm giá»¯a ca
        isOvertime = true;
        msg += 'â„¹ LÃ m thÃªm trong giá» trÆ°a. ';
        if (!data.vaoLamThem) data.vaoLamThem = currentTime;
        else if (data.vaoLamThem && !data.raLamThem) data.raLamThem = currentTime;
      }
    }
    // --- Ca chiá»u ---
    else if (currentHour >= 13 && currentHour <= 17.5) {
      if (!data.vaoCaChieu) {
        data.vaoCaChieu = currentTime;
        if (currentHour > 13) {
          msg += 'âš  Äi muá»™n ca chiá»u! ';
          noteVaoCaChieu += 'Äi muá»™n ca chiá»u! ';
          ghichucalam += 'Äi muá»™n ca chiá»u! ';
        }
      } else {
        data.raCaChieu = currentTime;
        if (currentHour < 17.5) {
          msg += 'âš  Vá» sá»›m ca chiá»u! ';
          noteRaCaChieu += 'Vá» sá»›m ca chiá»u! ';
          ghichucalam += 'Vá» sá»›m ca chiá»u! ';
        }
      }
    }
    // --- LÃ m thÃªm sau giá» ---
    else if (currentHour > 17.5) {
      isOvertime = true;
      msg += 'â„¹ Giá» lÃ m thÃªm sau giá» hÃ nh chÃ­nh. ';
      if (!data.raCaChieu) {
        data.raCaChieu = '17:30';
        msg += 'âš  Tá»± Ä‘á»™ng chá»‘t ca chiá»u 17:30. ';
        ghichucalam += 'Tá»± Ä‘á»™ng chá»‘t ca chiá»u 17:30. ';
      }
      if (!data.vaoLamThem) data.vaoLamThem = '17:30';
      data.raLamThem = currentTime + ' (lÃ m thÃªm)';
      noteVaoLamThem += 'Báº¯t Ä‘áº§u OT';
      noteRaLamThem += 'Káº¿t thÃºc OT';
    }

    // --- TÃ­nh tá»•ng giá» lÃ m (chá»‰ tÃ­nh tá»« giá» hh:mm, bá» pháº§n chá»¯ náº¿u cÃ³) ---
    let totalHours = 0;
    try {
      if (data.vaoCaSang && data.raCaSang) totalHours += (parseTime(data.raCaSang) - parseTime(data.vaoCaSang));
      if (data.vaoCaTrua && data.raCaTrua) totalHours += (parseTime(data.raCaTrua) - parseTime(data.vaoCaTrua));
      if (data.vaoCaChieu && data.raCaChieu) totalHours += (parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu));
    } catch(e){
      console.warn('parseTime error', e);
    }
    data.gioLamTrongNgay = Number(totalHours.toFixed(2));

    // --- ná»™i dung quÃ©t & vá»‹ trÃ­ ---
    data.noiDungMaQuet = qrContent;
    data.diadiemQuet = (lat && lng) ? `${lat},${lng}` : 'ChÆ°a láº¥y GPS';

    // combine ghi chÃº (khÃ´ng ghi Ä‘Ã¨, ghÃ©p thÃªm)
    data.ghiChu = (data.ghiChu || "") + (ghichucalam ? ghichucalam + " " : "") 
      + (noteVaoCaSang ? noteVaoCaSang + " " : "")
      + (noteRaCaSang ? noteRaCaSang + " " : "")
      + (noteVaoCaTrua ? noteVaoCaTrua + " " : "")
      + (noteRaCaTrua ? noteRaCaTrua + " " : "")
      + (noteVaoCaChieu ? noteVaoCaChieu + " " : "")
      + (noteRaCaChieu ? noteRaCaChieu + " " : "")
      + (noteVaoLamThem ? noteVaoLamThem + " " : "")
      + (noteRaLamThem ? noteRaLamThem + " " : "");

    // náº¿u lÃ m thÃªm thÃ¬ há»i ghi chÃº bá»• sung
    if (isOvertime) {
      const note = prompt("ğŸ“ Báº¡n cÃ³ giá» lÃ m thÃªm, vui lÃ²ng nháº­p ghi chÃº (bá» trá»‘ng náº¿u khÃ´ng):");
      if (note) data.ghiChu = (data.ghiChu || "") + note + " ";
    }

    // lÆ°u vÃ o Firebase
    ref.set(data)
      .then(()=>{
        // play beep
        try { beep.play().catch(()=>{}); } catch(e){}

        alert('âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!\n' + msg + (isOvertime ? '\nGhi chÃº: '+(data.ghiChu||'') : ''));

        resultDiv.textContent = `NhÃ¢n viÃªn: ${email}
SÃ¡ng: ${data.vaoCaSang||'-'} - ${data.raCaSang||'-'}
TrÆ°a: ${data.vaoCaTrua||'-'} - ${data.raCaTrua||'-'}
Chiá»u: ${data.vaoCaChieu||'-'} - ${data.raCaChieu||'-'}
Tá»•ng giá»: ${data.gioLamTrongNgay}h
${msg}`;

        restartBtn.style.display = 'inline-block';

        // gá»­i mail cho quáº£n lÃ½ (náº¿u muá»‘n)
        const emailParams = {
          to_name: "Quáº£n lÃ½",
          to_email: "vudinhhung11@gmail.com",
          from_name: "Há»‡ thá»‘ng cháº¥m cÃ´ng",
          employee_email: email,
          date: today,
          time: currentTime,
          location: data.diadiemQuet,
          note: data.ghiChu || ''
        };
        emailjs.send("service_pwhmtr3","template_dfq8ykc", emailParams)
          .then(()=>console.log('Email gá»­i thÃ nh cÃ´ng'))
          .catch(e=>console.warn('Email lá»—i', e));
      })
      .catch(err=>{
        console.error('Lá»—i lÆ°u Firebase', err);
        errorDiv.textContent = 'âŒ Lá»—i lÆ°u Firebase: ' + err;
        restartBtn.style.display = 'inline-block';
      });
  }).catch(err=>{
    console.error('Lá»—i Ä‘á»c Firebase', err);
    errorDiv.textContent = 'âŒ Lá»—i Ä‘á»c Firebase: '+err;
    restartBtn.style.display = 'inline-block';
  });
}

// ===== helper =====
function encodeEmail(email) { return String(email).replace(/\./g,','); }
function parseTime(timeStr) {
  if (!timeStr) return 0;
  // loáº¡i bá» kÃ½ tá»± khÃ´ng pháº£i sá»‘ hoáº·c ':', giá»¯ HH:MM[:SS]
  timeStr = String(timeStr).trim().replace(/[^0-9:]/g,'');
  const parts = timeStr.split(':').map(s=>Number(s||0));
  const h = parts[0]||0;
  const m = parts[1]||0;
  const s = parts[2]||0;
  return h + m/60 + s/3600;
}

// ===== events =====
restartBtn.addEventListener('click', ()=>{ startScanner(); });
logoutBtn.addEventListener('click', ()=>{ sessionStorage.removeItem('userEmail'); window.location.href='index.html'; });
viewBtn.addEventListener('click', ()=>{ window.location.href='xem.html'; });

window.addEventListener('load', startScanner);

// HÃ m tÃ­nh khoáº£ng cÃ¡ch (m)
function getDistanceFromLatLonInMeters(lat1,lon1,lat2,lon2){
  const R = 6371000;
  const dLat = deg2rad(lat2-lat1);
  const dLon = deg2rad(lon2-lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}
function deg2rad(deg){ return deg * Math.PI/180; }

</script>
</body>
</html>

