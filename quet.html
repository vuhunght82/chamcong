<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body {
    font-family: Arial;
    text-align: center;
    background: linear-gradient(to right, #00ffff, #00c6ff);
    margin: 0;
}
#video-container {
    width: 100%;
    max-width: 350px;
    margin: 20px auto;
    border: 2px solid #00aaff;
    border-radius: 10px;
}
video { width: 100%; }
#result { font-weight: bold; margin-top: 10px; color: green; }
button {
    margin-top: 15px;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 16px;
    background: green;
    color: white;
    border: none;
}
</style>

<!-- jsQR decode khÃ´ng cáº§n worker -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h2>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
</div>

<div id="result">Äang chá» quÃ©t...</div>

<button id="retry">ğŸ”„ QuÃ©t láº¡i</button>

<script>
/* ========== CAMERA ========== */
const video = document.getElementById("video");
const resultDiv = document.getElementById("result");
const retryBtn = document.getElementById("retry");

let scanning = false;

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        video.srcObject = stream;
        video.play();
        scanning = true;
        scanFrame();
    } catch (e) {
        resultDiv.textContent = "KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera!";
        console.error(e);
    }
}

function scanFrame() {
    if (!scanning) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);

    const code = jsQR(img.data, img.width, img.height);

    if (code) {
        scanning = false;
        handleScan(code.data);
        return;
    }
    requestAnimationFrame(scanFrame);
}

retryBtn.onclick = () => {
    scanning = true;
    resultDiv.textContent = "Äang chá» quÃ©t...";
    scanFrame();
};

/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function encodeEmail(email) {
    return email.replace(/\./g, ",");
}

/* ========== HANDLE QR ========== */
function handleScan(text) {
    resultDiv.textContent = "ÄÃ£ quÃ©t: " + text;

    if (text !== "CHECKIN_GLASS_COMPANY") {
        alert("âŒ MÃ£ QR khÃ´ng há»£p lá»‡!");
        return;
    }

    const email = sessionStorage.getItem("userEmail");
    if (!email) {
        alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
        return;
    }

    const key = encodeEmail(email);
    const now = new Date();
    const day = now.toISOString().slice(0, 10);
    const time = now.toLocaleTimeString();

    const ref = db.ref("chamcong/" + key + "/" + day);

    ref.once("value").then(snap => {
        const d = snap.val() || {};

        if (!d.vaoCaSang) d.vaoCaSang = time;
        else if (!d.raCaSang) d.raCaSang = time;

        ref.set(d).then(() => alert("âœ” Cháº¥m cÃ´ng thÃ nh cÃ´ng!"));
    });
}

startCamera();
</script>

</body>
</html>
