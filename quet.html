<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ch·∫•m c√¥ng QR</title>
<style>
  body { font-family: Arial; text-align:center; background:#f0f2f5; }
  h1 { color:#007bff; }
  #video-container { margin:20px auto; width:300px; border:2px solid #007bff; border-radius:10px; overflow:hidden; }
  video { width:100%; height:auto; }
  #result { font-weight:bold; color:green; margin-top:20px; white-space: pre-line; }
  #error { color:red; margin-top:10px; }
  button { margin-top:10px; padding:10px 20px; font-size:16px; }
</style>
</head>
<body>

<h1>üì∏ Qu√©t QR ch·∫•m c√¥ng</h1>
<div id="video-container">
  <video id="qr-video" muted></video>
</div>
<div id="result">ƒêang ch·ªù qu√©t QR...</div>
<div id="error"></div>
<button id="restartBtn" style="display:none;">Qu√©t l·∫°i</button>
<button id="logoutBtn">ƒêƒÉng xu·∫•t</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QR Scanner -->
<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// L·∫•y userEmail t·ª´ ƒëƒÉng nh·∫≠p
const userEmail = sessionStorage.getItem('userEmail');
if(!userEmail) {
  alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
  window.location.href = 'dangnhap.html';
}

// Kh·ªüi t·∫°o video
const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const restartBtn = document.getElementById('restartBtn');
const logoutBtn = document.getElementById('logoutBtn');

let scanner;

function startScanner() {
  resultDiv.textContent = 'ƒêang ch·ªù qu√©t QR...';
  errorDiv.textContent = '';
  restartBtn.style.display = 'none';

  scanner = new QrScanner(videoElem, qrResult => {
    handleAttendance(qrResult);
  }, { highlightScanRegion: true, highlightCodeOutline: true });

  scanner.start().catch(err => {
    errorDiv.textContent = '‚ùå Kh√¥ng th·ªÉ m·ªü camera: ' + err;
  });
}

restartBtn.addEventListener('click', startScanner);
logoutBtn.addEventListener('click', () => {
  sessionStorage.removeItem('userEmail');
  window.location.href = 'dangnhap.html';
});

// X·ª≠ l√Ω ch·∫•m c√¥ng
function handleAttendance(qrResult) {
  scanner.stop();
  const now = new Date();
  const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
  const currentHour = now.getHours() + now.getMinutes()/60;
  const employeeId = userEmail.replace(/[@.]/g,'_'); // key Firebase

  const attendanceRef = db.ref('chamcong/' + employeeId + '/' + today);

  attendanceRef.once('value', snapshot => {
    let data = snapshot.exists() ? snapshot.val() : {};

    const morningStart = 7.5, morningEnd = 11.5;
    const afternoonStart = 13, afternoonEnd = 17.5;
    let msg = '';

    // X·ª≠ l√Ω ca
    if(currentHour >= morningStart && currentHour <= morningEnd) {
      if(!data.vaoCaSang) {
        data.vaoCaSang = now.toLocaleTimeString();
        if(currentHour > morningStart) msg += '‚ö† ƒêi mu·ªôn ca s√°ng! ';
      } else {
        data.raCaSang = now.toLocaleTimeString();
      }
    } else if(currentHour >= afternoonStart && currentHour <= afternoonEnd) {
      if(!data.vaoCaChieu) {
        data.vaoCaChieu = now.toLocaleTimeString();
        if(currentHour > afternoonStart) msg += '‚ö† ƒêi mu·ªôn ca chi·ªÅu! ';
      } else {
        data.raCaChieu = now.toLocaleTimeString();
      }
    } else if(currentHour > morningEnd && currentHour < afternoonStart) {
      msg += '‚Ñπ Gi·ªù ngh·ªâ tr∆∞a, ghi nh·∫≠n l√†m th√™m n·∫øu c√≥.';
    } else {
      msg += '‚Ñπ Ngo√†i gi·ªù ca.';
    }

    data.noiDungMaQuet = qrResult;
    data.diaDiemQuetMa = 'Ch∆∞a x√°c ƒë·ªãnh'; // c√≥ th·ªÉ th√™m GPS n·∫øu mu·ªën

    // T√≠nh gi·ªù l√†m trong ng√†y s∆° khai
    let totalHours = 0;
    if(data.vaoCaSang && data.raCaSang) totalHours += parseTime(data.raCaSang) - parseTime(data.vaoCaSang);
    if(data.vaoCaChieu && data.raCaChieu) totalHours += parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu);
    data.gioLamTrongNgay = totalHours.toFixed(2);

    attendanceRef.set(data)
      .then(() => {
        resultDiv.textContent = `‚úÖ QR: ${qrResult}\n` +
                                `S√°ng: ${data.vaoCaSang||'-'} - ${data.raCaSang||'-'}\n` +
                                `Chi·ªÅu: ${data.vaoCaChieu||'-'} - ${data.raCaChieu||'-'}\n` +
                                `T·ªïng gi·ªù: ${data.gioLamTrongNgay}h\n` + msg;
        alert('‚úÖ ƒê√£ l∆∞u ch·∫•m c√¥ng!\n' + msg);
        restartBtn.style.display = 'inline-block';
      })
      .catch(err => errorDiv.textContent = '‚ùå L·ªói l∆∞u d·ªØ li·ªáu: '+err);
  });
}

function parseTime(timeStr) {
  const parts = timeStr.split(':');
  return Number(parts[0]) + Number(parts[1])/60 + (parts[2]?Number(parts[2])/3600:0);
}

window.addEventListener('load', startScanner);
</script>

</body>
</html>
