<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>
<style>
body {
  font-family: Arial;
  text-align: center;
  background-color: #f0f2f5;
  margin: 0;
  padding: 0 10px;
}
h1 { color:#007bff; margin: 15px 0; }
#video-container { margin:20px auto; width:100%; max-width:360px; border:2px solid #007bff; border-radius:10px; overflow:hidden; }
video { width:100%; height:auto; }
#result { font-weight:bold; color:green; margin-top:20px; white-space: pre-line; }
#error { color:red; margin-top:10px; }
button { margin:5px; padding:10px 15px; font-size:16px; }
@media (max-width:480px){
  button, input { width:95%; font-size:1em; }
}
</style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init("zw8NnWti6A--Pyys9"); // ğŸ”¹ Thay YOUR_PUBLIC_KEY báº±ng mÃ£ trong EmailJS Dashboard
  })();
</script>
</head>
  
<body>
<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<h1>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h1>

<div id="video-container">
  <video id="qr-video" muted></video>
</div>

<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>
<button id="restartBtn" style="display:none;">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QR Scanner -->
<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

// ================== Firebase ==================
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================== Kiá»ƒm tra Ä‘Äƒng nháº­p ==================
const userEmail = sessionStorage.getItem('userEmail');
if (!userEmail) {
  alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
  window.location.href = 'index.html';
}

// ================== Elements ==================
const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const restartBtn = document.getElementById('restartBtn');
const logoutBtn = document.getElementById('logoutBtn');
const viewBtn = document.getElementById('viewBtn');

let scanner;

// ================== HÃ m quÃ©t ==================
function startScanner() {
  resultDiv.textContent = 'Äang chá» quÃ©t QR...';
  errorDiv.textContent = '';
  restartBtn.style.display = 'none';

  scanner = new QrScanner(videoElem, qrResult => {
    navigator.geolocation.getCurrentPosition(
      pos => handleAttendance(userEmail, qrResult, pos.coords.latitude, pos.coords.longitude),
      () => handleAttendance(userEmail, qrResult.data, null, null)
    );
  }, { highlightScanRegion: true, highlightCodeOutline: true });


  
  scanner.start().catch(err => {
    console.error(err);
    errorDiv.textContent = 'âŒ KhÃ´ng thá»ƒ má»Ÿ camera: ' + err;
  });
}

// ================== Xá»­ lÃ½ cháº¥m cÃ´ng ==================
function handleAttendance(email, qrContent, lat, lng) {
  scanner.stop();

  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const currentTime = now.toLocaleTimeString();
  const currentHour = now.getHours() + now.getMinutes() / 60;
  const emailKey = encodeEmail(email);
  const ref = db.ref('chamcong/' + emailKey + '/' + today);

  ref.once('value').then(snapshot => {
    const data = snapshot.val() || {};
    let msg = '';
    let isOvertime = false;

    // --- Ca sÃ¡ng ---
    if (currentHour >= 7.5 && currentHour <= 11.5) {
      if (!data.vaoCaSang) {
        data.vaoCaSang = currentTime;
        if (currentHour > 7.5) msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
      } else {
        data.raCaSang = currentTime;
        if (currentHour < 11.5) msg += 'âš  Vá» sá»›m ca sÃ¡ng! ';
      }
    }
    // --- Ca chiá»u ---
    else if (currentHour >= 13 && currentHour <= 17.5) {
      if (!data.vaoCaChieu) {
        data.vaoCaChieu = currentTime;
        if (currentHour > 13) msg += 'âš  Äi muá»™n ca chiá»u! ';
      } else {
        data.raCaChieu = currentTime;
        if (currentHour < 17.5) msg += 'âš  Vá» sá»›m ca chiá»u! ';
      }
    }
    // --- LÃ m thÃªm ---
    else if ((currentHour > 11.5 && currentHour < 13) || currentHour > 17.5) {
      msg += 'â„¹ Giá» lÃ m thÃªm!';
      isOvertime = true;
    }
    else {
  isOvertime = true;

  // Náº¿u cÃ³ vaoCaSang mÃ  chÆ°a cÃ³ raCaSang -> tá»± chá»‘t 11:30
  if (data.vaoCaSang && !data.raCaSang) {
    data.raCaSang = '11:30';
    msg += 'âš  Tá»± Ä‘á»™ng chá»‘t ra ca sÃ¡ng 11:30. ';
  }

  // Náº¿u chÆ°a cÃ³ vÃ o/ra ca chiá»u mÃ  quÃ©t sau 17:30 -> tá»± chá»‘t ca chiá»u 13:00â€“17:30
  if (!data.vaoCaChieu && !data.raCaChieu && currentHour > 17.5) {
    data.vaoCaChieu = '13:00';
    data.raCaChieu = '17:30';
    msg += 'âš  Tá»± Ä‘á»™ng tÃ­nh lÃ m ca chiá»u 13:00â€“17:30. ';
  }

  // Pháº§n sau 17:30 lÃ  lÃ m thÃªm
  if (currentHour > 17.5) {
    data.vaoLamThem = '17:30';
    data.raLamThem = currentTime;
    msg += `â„¹ Giá» lÃ m thÃªm tá»« 17:30 Ä‘áº¿n ${currentTime}.`;
  }
}


    // --- Tá»•ng giá» lÃ m ---
    let totalHours = 0;
    if (data.vaoCaSang && data.raCaSang) totalHours += parseTime(data.raCaSang) - parseTime(data.vaoCaSang);
    if (data.vaoCaChieu && data.raCaChieu) totalHours += parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu);
    data.gioLamTrongNgay = totalHours.toFixed(2);

    data.noiDungMaQuet = qrContent;
    data.diadiemQuet = (lat && lng) ? `${lat},${lng}` : 'ChÆ°a láº¥y GPS';

    if (isOvertime) {
      const note = prompt("ğŸ“ Báº¡n cÃ³ giá» lÃ m thÃªm, vui lÃ²ng nháº­p ghi chÃº:");
      if (note) data.ghiChu = note;
    }

    ref.set(data)
      .then(() => {
       document.getElementById('beepSound').play();
        alert('âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!\n' + msg + (isOvertime ? '\nGhi chÃº: ' + (data.ghiChu || '') : ''));
        resultDiv.textContent = `NhÃ¢n viÃªn: ${email}
SÃ¡ng: ${data.vaoCaSang || '-'} - ${data.raCaSang || '-'}
Chiá»u: ${data.vaoCaChieu || '-'} - ${data.raCaChieu || '-'}
Tá»•ng giá»: ${data.gioLamTrongNgay}h
${msg}`;
        restartBtn.style.display = 'inline-block';

const emailParams = {
  to_name: "Quáº£n lÃ½ cÃ´ng ty",
  to_email: "vudinhhung11@gmail.com", // ğŸ”¹ Äá»‹a chá»‰ mail quáº£n lÃ½
  from_name: "Há»‡ thá»‘ng cháº¥m cÃ´ng tá»± Ä‘á»™ng",
  employee_email: email,
  date: today,
  time: currentTime,
  location: (lat && lng) ? `${lat}, ${lng}` : 'ChÆ°a xÃ¡c Ä‘á»‹nh',
  qr_content: qrContent,
  morning: `${data.vaoCaSang || '-'} - ${data.raCaSang || '-'}`,
  afternoon: `${data.vaoCaChieu || '-'} - ${data.raCaChieu || '-'}`,
  total_hours: data.gioLamTrongNgay,
  note: data.ghiChu || 'KhÃ´ng cÃ³',
};

emailjs.send("service_pwhmtr3", "template_dfq8ykc", emailParams)
  .then(() => {
    console.log("ğŸ“§ Email gá»­i thÃ nh cÃ´ng tá»›i quáº£n lÃ½!");
  })
  .catch((err) => {
    console.error("âŒ Lá»—i gá»­i email:", err);
  });

        
      })
             
 
           
      .catch(err => {
        console.error('âŒ Lá»—i lÆ°u Firebase:', err);
        errorDiv.textContent = 'âŒ Lá»—i lÆ°u Firebase: ' + err;
      });

  
  });
}

// ================== HÃ m phá»¥ trá»£ ==================
function encodeEmail(email) {
  return email.replace(/\./g, ',');
}
function parseTime(timeStr) {
  const [h, m, s = 0] = timeStr.split(':');
  return Number(h) + Number(m) / 60 + Number(s) / 3600;
}

// ================== Sá»± kiá»‡n ==================
restartBtn.addEventListener('click', startScanner);
logoutBtn.addEventListener('click', () => {
  sessionStorage.removeItem('userEmail');
  window.location.href = 'index.html';
});
viewBtn.addEventListener('click', () => {
  window.location.href = 'xem.html';
});

window.addEventListener('load', startScanner);
</script>
</body>
</html>













