<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body {
  font-family: Arial;
  text-align: center;
  background: linear-gradient(to right, #00ffff, #00c6ff);
  margin: 0;
  padding: 0 10px;
}
h1 {
  color:#ffffff;
  margin: 15px 0;
}
#video-container {
  margin:20px auto;
  width:100%;
  max-width:360px;
  border:2px solid #007bff;
  border-radius:10px;
  overflow:hidden;
}
video {
  width:100%;
  height:auto;
}
#result {
  font-weight:bold;
  color:green;
  margin-top:20px;
  white-space: pre-line;
}
#error { color:red; margin-top:10px; }

button {
  margin: 5px;
  padding: 20px 30px;
  font-size: 16px;
  border-radius: 10px;
  background-color:green;
  color:#fff;
  border-color:#fff;
}
@media (max-width:480px){
  button { width:95%; font-size:1em; }
}
</style>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init("zw8NnWti6A--Pyys9");
  })();
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QRScanner UMD â€“ cháº¡y Ä‘Æ°á»£c trÃªn iPhone -->
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

</head>
<body>

<h1>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h1>

<div id="video-container">
  <video id="qr-video" muted playsinline></video>
</div>

<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>

<button id="restartBtn" style="display:none;">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<script>
/*===========================
  Firebase
===========================*/
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*===========================
  Check login
===========================*/
const userEmail = sessionStorage.getItem("userEmail");
if (!userEmail) {
  alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c");
  location.href = "index.html";
}

/*===========================
  QR Scanner (UMD â€“ cháº¡y Ä‘Æ°á»£c trÃªn iPhone)
===========================*/
const videoElem = document.getElementById("qr-video");
let scanner;

function startScanner() {
  scanner = new QrScanner(
    videoElem,
    result => {
      handleScan(result.data);
    },
    {
      highlightScanRegion: true,
      highlightCodeOutline: true,
      preferredCamera: "environment"
    }
  );

  scanner.start().catch(err => {
    document.getElementById("error").textContent =
      "KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera: " + err;
  });
}

function handleScan(text) {
  scanner.stop();
  document.getElementById("result").textContent = "ÄÃ£ quÃ©t: " + text;

  if (text !== "CHECKIN_GLASS_COMPANY") {
    alert("âŒ MÃ£ QR khÃ´ng há»£p lá»‡");
    restartBtn.style.display = "block";
    return;
  }

  handleAttendance();
}

/*===========================
  Xá»­ lÃ½ cháº¥m cÃ´ng
===========================*/
function handleAttendance() {
  const emailKey = userEmail.replace(/\./g, ",");
  const now = new Date();
  const today = now.toISOString().split("T")[0];
  const time = now.toLocaleTimeString();

  const ref = db.ref("chamcong/" + emailKey + "/" + today);

  ref.once("value").then(snap => {
    const data = snap.val() || {};

    if (!data.vaoCaSang) data.vaoCaSang = time;
    else if (!data.raCaSang) data.raCaSang = time;

    ref.set(data).then(() => {
      alert("âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!");
      restartBtn.style.display = "block";
    });
  });
}

/*===========================
  Button
===========================*/
restartBtn.onclick = startScanner;
viewBtn.onclick = () => location.href = "xem.html";
logoutBtn.onclick = () => {
  sessionStorage.clear();
  location.href = "index.html";
};

window.onload = startScanner;
</script>

</body>
</html>
