<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#00c6ff,#007bff);color:#fff;margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:18px}
  h1{margin:10px 0}
  #video-container{width:100%;max-width:420px;border-radius:12px;overflow:hidden;border:3px solid rgba(255,255,255,0.25);background:#000}
  video{width:100%;display:block}
  #result{margin-top:12px;white-space:pre-line;text-align:left;max-width:420px;background:rgba(255,255,255,0.06);padding:10px;border-radius:8px}
  .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center}
  button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  #viewBtn{background:#0066ff;color:#fff}
  #logoutBtn{background:#ff4d4f;color:#fff}
  #restartBtn{background:#ffd966;color:#000;display:none}
  small{opacity:.9}
</style>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- EmailJS (optional) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>üì∏ Qu√©t QR - Ch·∫•m c√¥ng</h1>

<div id="video-container">
  <video id="video" autoplay playsinline muted></video>
</div>

<div id="result">ƒêang m·ªü camera... <br><small>Ch·ªù qu√©t QR h·ª£p l·ªá...</small></div>

<div class="controls">
  <button id="viewBtn">üìã Xem ch·∫•m c√¥ng</button>
  <button id="restartBtn">üîÑ Qu√©t l·∫°i</button>
  <button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
</div>

<!-- beep sound -->
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
/* ================== C·∫§U H√åNH ================== */
// Firebase config (gi·ªØ nguy√™n c·ªßa b·∫°n)
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// EmailJS (n·∫øu mu·ªën g·ª≠i mail, h√£y thay PUBLIC_KEY & kh·ªüi t·∫°o)
try{ emailjs.init("zw8NnWti6A--Pyys9"); }catch(e){ /* optional */ }

// QR & company
const VALID_QR = "CHECKIN_GLASS_COMPANY"; // n·ªôi dung QR chu·∫©n
const COMPANY_LOCATION = { lat: 10.849641858164617, lng: 106.58569113116769 }; // thay t·ªça ƒë·ªô th·∫≠t (lat,lng)
const MAX_DISTANCE_METERS = 100; // kho·∫£ng c√°ch ch·∫•p nh·∫≠n ƒë∆∞·ª£c

/* ================== NG∆Ø·ªúI D√ôNG ================== */
const userEmail = sessionStorage.getItem('userEmail'); // username/email ƒë√£ login
if(!userEmail){
  alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.'); 
  window.location.href = 'index.html';
}

/* ================== ELEM ================== */
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const restartBtn = document.getElementById('restartBtn');
const logoutBtn = document.getElementById('logoutBtn');
const viewBtn = document.getElementById('viewBtn');
const beep = document.getElementById('beep');

/* ================== Canvas t√°i s·ª≠ d·ª•ng cho jsQR ================== */
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

/* ================== Tr·∫°ng th√°i qu√©t ================== */
let scanning = false;
let streamRef = null;

/* ================== H·ªñ TR·ª¢ TIME/GPS ================== */
function formatTime(now){
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}
function toHourDecimal(hhmm){
  if(!hhmm) return 0;
  const parts = hhmm.replace(/[^0-9:]/g,'').split(':').map(Number);
  if(parts.length<2) return 0;
  return parts[0] + (parts[1]||0)/60;
}
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/* ================== CAMERA START/STOP ================== */
async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    streamRef = s;
    video.srcObject = s;
    video.play();
    resultDiv.textContent = 'ƒêang qu√©t...';
    scanning = true;
    requestAnimationFrame(scanLoop);
  }catch(err){
    console.error(err);
    resultDiv.textContent = '‚ùå Kh√¥ng th·ªÉ m·ªü camera. H√£y c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.';
  }
}
function stopCamera(){
  scanning = false;
  if(streamRef){
    streamRef.getTracks().forEach(t=>t.stop());
    streamRef = null;
  }
}

/* ================== SCAN LOOP (jsQR) ================== */
function scanLoop(){
  if(!scanning) return;
  const w = video.videoWidth, h = video.videoHeight;
  if(!w || !h){
    requestAnimationFrame(scanLoop);
    return;
  }
  // resize canvas only when size changed (cheaper)
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  ctx.drawImage(video, 0, 0, w, h);
  const img = ctx.getImageData(0,0,w,h);
  const code = jsQR(img.data, w, h, { inversionAttempts: "attemptBoth" });
  if(code && code.data){
    scanning = false;
    handleScan(code.data);
    return;
  }
  requestAnimationFrame(scanLoop);
}

/* ================== HANDLER ================== */
function handleScan(text){
  // quick UI
  resultDiv.textContent = 'M√£ ƒë·ªçc ƒë∆∞·ª£c: ' + text;
  // check QR
  if(text !== VALID_QR){
    resultDiv.textContent = '‚ùå M√£ QR kh√¥ng h·ª£p l·ªá';
    beepFailure();
    setTimeout(()=>{ scanning = true; requestAnimationFrame(scanLoop); }, 1200);
    return;
  }
  // get GPS then save
  resultDiv.textContent = '‚úÖ QR h·ª£p l·ªá ‚Äî L·∫•y v·ªã tr√≠...';
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      // check distance
      const d = distanceMeters(lat,lng, COMPANY_LOCATION.lat, COMPANY_LOCATION.lng);
      if(d > MAX_DISTANCE_METERS){
        resultDiv.textContent = `‚ùå Qu√° xa c√¥ng ty: ${d.toFixed(1)} m`;
        beepFailure();
        setTimeout(()=>{ scanning = true; requestAnimationFrame(scanLoop); }, 1500);
        return;
      }
      // OK -> l∆∞u
      saveAttendance(lat,lng);
    },
    err => {
      console.warn('GPS error', err);
      alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. H√£y c·∫•p quy·ªÅn v·ªã tr√≠ ho·∫∑c th·ª≠ l·∫°i.');
      scanning = true;
      setTimeout(()=>requestAnimationFrame(scanLoop), 800);
    },
    { enableHighAccuracy:true, timeout:6000, maximumAge:0 }
  );
}

/* ================== T√çNH GI·ªú + L∆ØU ================== */
function encodeEmail(e){ return String(e).replaceAll('.',' ,').replace(/\s+/g,''); } // ƒë∆°n gi·∫£n h√≥a kh√≥a
function safeStr(s){ return (s===undefined || s===null || s==='')? '' : String(s); }

function saveAttendance(lat, lng){
  const now = new Date();
  const dayKey = now.toISOString().slice(0,10); // yyyy-mm-dd
  const timeStr = formatTime(now);
  const hourDecimal = now.getHours() + now.getMinutes()/60;
  const userKey = encodeEmail(userEmail);
  const ref = db.ref('chamcong/' + userKey + '/' + dayKey);

  ref.once('value').then(snapshot => {
    const data = snapshot.val() || {};

    // ensure fields exist
    data.vaoCaSang = safeStr(data.vaoCaSang);
    data.raCaSang = safeStr(data.raCaSang);
    data.vaoCaTrua = safeStr(data.vaoCaTrua);
    data.raCaTrua = safeStr(data.raCaTrua);
    data.vaoCaChieu = safeStr(data.vaoCaChieu);
    data.raCaChieu = safeStr(data.raCaChieu);
    data.vaoLamThem = safeStr(data.vaoLamThem);
    data.raLamThem = safeStr(data.raLamThem);
    data.ghiChu = safeStr(data.ghiChu);

    // notes for each ca (append, kh√¥ng ghi ƒë√®)
    data.noteVaoCaSang = safeStr(data.noteVaoCaSang);
    data.noteRaCaSang = safeStr(data.noteRaCaSang);
    data.noteVaoCaTrua = safeStr(data.noteVaoCaTrua);
    data.noteRaCaTrua = safeStr(data.noteRaCaTrua);
    data.noteVaoCaChieu = safeStr(data.noteVaoCaChieu);
    data.noteRaCaChieu = safeStr(data.noteRaCaChieu);
    data.noteVaoLamThem = safeStr(data.noteVaoLamThem);
    data.noteRaLamThem = safeStr(data.noteRaLamThem);

    let msgForAlert = '';

    // --- Quy t·∫Øc ca ---
    // Ca s√°ng: 07:30 - 11:30  (7.5 -> 11.5)
    // Gi·ªù tr∆∞a: 11:30 - 13:00 (11.5 -> 13)
    // Ca chi·ªÅu: 13:00 - 17:30 (13 -> 17.5)
    // OT: >17.5

    if(hourDecimal >= 7.5 && hourDecimal <= 11.5){
      // x·ª≠ l√Ω v√†o/ra s√°ng
      if(!data.vaoCaSang){
        data.vaoCaSang = timeStr;
        data.noteVaoCaSang += (data.noteVaoCaSang ? ' | ' : '') + (hourDecimal>7.5 ? 'ƒêi mu·ªôn' : 'V√†o ƒë√∫ng gi·ªù') + ' ' + timeStr;
        msgForAlert = 'V√†o ca s√°ng';
      } else {
        data.raCaSang = timeStr;
        data.noteRaCaSang += (data.noteRaCaSang ? ' | ' : '') + (hourDecimal<11.5 ? 'V·ªÅ s·ªõm' : 'Ra ƒë√∫ng gi·ªù') + ' ' + timeStr;
        msgForAlert = 'Ra ca s√°ng';
      }
    }
    else if(hourDecimal > 11.5 && hourDecimal < 13){
      // tr∆∞a (c√≥ th·ªÉ v√†o tr∆∞a ho·∫∑c ra tr∆∞a)
      if(!data.vaoCaTrua){
        // n·∫øu ch∆∞a c√≥ raCaSang v√† qu√©t tr∆∞a th√¨ t·ª± ch·ªët raCaSang 11:30 v√† t√≠nh tr∆∞a t·ª´ 11:30->now
        if(data.vaoCaSang && !data.raCaSang){
          data.raCaSang = '11:30:00';
          data.noteRaCaSang += (data.noteRaCaSang ? ' | ' : '') + 'T·ª± ch·ªët ra s√°ng 11:30';
        }
        data.vaoCaTrua = timeStr;
        data.noteVaoCaTrua += (data.noteVaoCaTrua ? ' | ' : '') + 'V√†o tr∆∞a ' + timeStr;
        msgForAlert = 'V√†o ca tr∆∞a';
      } else {
        data.raCaTrua = timeStr;
        data.noteRaCaTrua += (data.noteRaCaTrua ? ' | ' : '') + 'Ra tr∆∞a ' + timeStr;
        msgForAlert = 'Ra ca tr∆∞a';
      }
    }
    else if(hourDecimal >= 13 && hourDecimal <= 17.5){
      // chi·ªÅu
      if(!data.vaoCaChieu){
        // n·∫øu ch∆∞a c√≥ vaoCaTrua but raCaTrua exists? we simply set vaoCaChieu
        data.vaoCaChieu = timeStr;
        data.noteVaoCaChieu += (data.noteVaoCaChieu ? ' | ' : '') + (hourDecimal>13 ? 'ƒêi mu·ªôn' : 'V√†o ƒë√∫ng gi·ªù') + ' ' + timeStr;
        msgForAlert = 'V√†o ca chi·ªÅu';
      } else {
        data.raCaChieu = timeStr;
        data.noteRaCaChieu += (data.noteRaCaChieu ? ' | ' : '') + (hourDecimal<17.5 ? 'V·ªÅ s·ªõm' : 'Ra ƒë√∫ng gi·ªù') + ' ' + timeStr;
        msgForAlert = 'Ra ca chi·ªÅu';
      }
    }
    else { // tr∆∞·ªõc 7.5 ho·∫∑c >17.5 (x·ª≠ l√Ω OT ho·∫∑c v√†o qu√° s·ªõm)
      if(hourDecimal <= 7.5){
        // very early come -> ghi v√†o v√†o s√°ng
        if(!data.vaoCaSang){
          data.vaoCaSang = timeStr;
          data.noteVaoCaSang += (data.noteVaoCaSang ? ' | ' : '') + 'ƒêi s·ªõm ' + timeStr;
          msgForAlert = 'V√†o s·ªõm ca s√°ng';
        } else {
          // fallback
          msgForAlert = 'Qu√©t v√†o gi·ªù s·ªõm';
        }
      } else {
        // OT (sau 17:30)
        if(!data.vaoLamThem){
          // t·ª± ch·ªët ca chi·ªÅu n·∫øu ch∆∞a c√≥ raCaChieu
          if(!data.raCaChieu && data.vaoCaChieu){
            data.raCaChieu = '17:30:00';
            data.noteRaCaChieu += (data.noteRaCaChieu ? ' | ' : '') + 'T·ª± ch·ªët ra chi·ªÅu 17:30';
          }
          data.vaoLamThem = timeStr;
          data.noteVaoLamThem += (data.noteVaoLamThem ? ' | ' : '') + 'B·∫Øt ƒë·∫ßu OT ' + timeStr;
          msgForAlert = 'B·∫Øt ƒë·∫ßu l√†m th√™m';
        } else {
          data.raLamThem = timeStr;
          data.noteRaLamThem += (data.noteRaLamThem ? ' | ' : '') + 'K·∫øt th√∫c OT ' + timeStr;
          msgForAlert = 'K·∫øt th√∫c l√†m th√™m';
        }
      }
    }

    // t√≠nh gi·ªù t·ªïng trong ng√†y: c·ªông c√°c ca c√≥ ƒë·ªß v√†o+ra (s√°ng/tr∆∞a/chi·ªÅu)
    let total = 0;
    try{
      if(data.vaoCaSang && data.raCaSang) total += toHourDecimal(data.raCaSang) - toHourDecimal(data.vaoCaSang);
      if(data.vaoCaTrua && data.raCaTrua) total += toHourDecimal(data.raCaTrua) - toHourDecimal(data.vaoCaTrua);
      if(data.vaoCaChieu && data.raCaChieu) total += toHourDecimal(data.raCaChieu) - toHourDecimal(data.vaoCaChieu);
    }catch(e){
      console.warn('calc total err', e);
    }
    data.gioLamTrongNgay = (isNaN(total) ? 0 : Number(total.toFixed(2)));

    // gi·ªù OT
    let ot = 0;
    try{
      if(data.vaoLamThem && data.raLamThem) ot = toHourDecimal(data.raLamThem) - toHourDecimal(data.vaoLamThem);
    }catch(e){}
    data.gioLamThem = (isNaN(ot) ? 0 : Number(ot.toFixed(2)));

    // v·ªã tr√≠ & qr
    data.diaDiemQuet = `${lat},${lng}`;
    data.noiDungMaQuet = VALID_QR;

    // ghi ch√∫ chung (append)
    const noteAppend = (msgForAlert ? (msgForAlert + ' @' + timeStr) : '');
    data.ghiChu = (data.ghiChu ? data.ghiChu + ' | ' : '') + noteAppend;

    // l∆∞u
    ref.set(data).then(()=>{
      // beep
      try{ beep.currentTime = 0; beep.play(); }catch(e){}

      // x√¢y alert message hi·ªÉn th·ªã chi ti·∫øt note t·ª´ng ca
      let out = '‚úî CH·∫§M C√îNG TH√ÄNH C√îNG\n';
      out += '----------------------------\n';
      out += `Nh√¢n vi√™n: ${userEmail}\n`;
      out += `Ng√†y: ${dayKey}\n`;
      out += `Gi·ªù qu√©t: ${timeStr}\n`;
      out += '----------------------------\n';
      if(msgForAlert) out += `> ${msgForAlert}\n`;
      if(data.noteVaoCaSang) out += `Ca s√°ng v√†o: ${data.noteVaoCaSang}\n`;
      if(data.noteRaCaSang) out += `Ca s√°ng ra: ${data.noteRaCaSang}\n`;
      if(data.noteVaoCaTrua) out += `Ca tr∆∞a v√†o: ${data.noteVaoCaTrua}\n`;
      if(data.noteRaCaTrua) out += `Ca tr∆∞a ra: ${data.noteRaCaTrua}\n`;
      if(data.noteVaoCaChieu) out += `Ca chi·ªÅu v√†o: ${data.noteVaoCaChieu}\n`;
      if(data.noteRaCaChieu) out += `Ca chi·ªÅu ra: ${data.noteRaCaChieu}\n`;
      if(data.noteVaoLamThem) out += `OT v√†o: ${data.noteVaoLamThem}\n`;
      if(data.noteRaLamThem) out += `OT ra: ${data.noteRaLamThem}\n`;
      out += '----------------------------\n';
      out += `T·ªïng gi·ªù: ${data.gioLamTrongNgay} h\n`;
      out += `Gi·ªù OT: ${data.gioLamThem} h\n`;

      alert(out);
      // Update UI
      resultDiv.textContent = `‚úî ${msgForAlert}\nT·ªïng: ${data.gioLamTrongNgay} h | OT: ${data.gioLamThem} h`;

      // send email optional (if you configured EmailJS & template)
      try{
        const emailParams = {
          to_name: "Qu·∫£n l√Ω",
          to_email: "vudinhhung11@gmail.com",
          from_name: "H·ªá th·ªëng ch·∫•m c√¥ng",
          employee_email: userEmail,
          date: dayKey,
          time: timeStr,
          location: data.diaDiemQuet,
          note: data.ghiChu
        };
        emailjs.send("service_pwhmtr3","template_dfq8ykc", emailParams)
          .then(()=> console.log('Email g·ª≠i OK'))
          .catch(()=> console.log('EmailJS send fail (b·ªè qua)'));
      }catch(e){}

      // resume scan after short delay
      restartBtn.style.display = 'inline-block';
      setTimeout(()=>{ scanning = true; requestAnimationFrame(scanLoop); restartBtn.style.display = 'none'; }, 1200);
    }).catch(err=>{
      console.error('L·ªói l∆∞u firebase', err);
      alert('‚ùå L·ªói l∆∞u d·ªØ li·ªáu: ' + err);
      scanning = true;
      setTimeout(()=>requestAnimationFrame(scanLoop), 800);
    });
  }).catch(err=>{
    console.error('L·ªói ƒë·ªçc firebase', err);
    alert('‚ùå L·ªói ƒë·ªçc d·ªØ li·ªáu: ' + err);
    scanning = true;
    setTimeout(()=>requestAnimationFrame(scanLoop), 800);
  });
}

/* ================== UI BUTTONS ================== */
restartBtn.addEventListener('click', ()=>{ if(!scanning){ scanning=true; requestAnimationFrame(scanLoop); restartBtn.style.display='none'; } });
logoutBtn.addEventListener('click', ()=>{ sessionStorage.clear(); stopCamera(); window.location.href='index.html'; });
viewBtn.addEventListener('click', ()=>{ // d√πng email l√†m param ƒë·ªÉ xem trang xem.html
  const q = encodeURIComponent(userEmail);
  window.location.href = 'xem.html?user=' + q;
});

/* ================== beep failure small ================== */
function beepFailure(){
  // short tone by reusing beep but lower volume (best-effort)
  try{ beep.currentTime = 0; beep.play(); }catch(e){}
}

/* ================== AUTO START ================== */
window.addEventListener('load', ()=> {
  startCamera();
});
</script>

</body>
</html>
