<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu√©t m√£ QR ch·∫•m c√¥ng</title>
  <style>
    body { font-family: Arial; text-align:center; background:#eef2f7; }
    #video { width:300px; margin:20px; border:2px solid #007bff; border-radius:10px; }
  </style>
</head>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  // C·∫•u h√¨nh Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
    authDomain: "sellglass-3ebe9.firebaseapp.com",
    databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sellglass-3ebe9",
    storageBucket: "sellglass-3ebe9.appspot.com",
    messagingSenderId: "513741829035",
    appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const db = firebase.database();
  const auth = firebase.auth();

  window.db = db;   // cho c√°c file kh√°c d√πng
  window.auth = auth;
</script>
<body>
  <h2>üì∏ Qu√©t m√£ QR ch·∫•m c√¥ng</h2>
  <video id="video" muted></video>
  <div id="result"></div>
  <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
  <p><a href="xem.html">Xem th·ªùi gian l√†m</a></p>

  <script type="module">
   
    import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

    const videoElem = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const userEmail = sessionStorage.getItem('userEmail');

    if (!userEmail) window.location.href = 'index.html';

    const scanner = new QrScanner(videoElem, result => handleScan(result), {
      highlightScanRegion: true, highlightCodeOutline: true
    });
    scanner.start();

    async function handleScan(result) {
      const qrValue = result.data || result;
      resultDiv.textContent = '‚úÖ Qu√©t th√†nh c√¥ng: ' + qrValue;

      const now = new Date();
      const date = now.toISOString().split('T')[0];
      const time = now.toLocaleTimeString();
      const dbPath = `chamcong/${userEmail.replace(/\./g, "_")}/${date}`;

      await update(ref(db, dbPath), {
        tendangnhap: userEmail,
        noidungmaquet: qrValue,
        giolamtrongngay: time,
        diadiemquetma: "VƒÉn ph√≤ng",
        updatedAt: now.toISOString()
      });

      alert('‚úÖ Ch·∫•m c√¥ng th√†nh c√¥ng!');
      scanner.stop();
    }

    document.getElementById('logoutBtn').onclick = () => {
      sessionStorage.clear();
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>

