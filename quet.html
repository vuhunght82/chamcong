<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

    <style>
        body {
            font-family: Arial;
            text-align: center;
            background: #00c6ff;
            margin: 0;
            padding: 10px;
        }

        h2 {
            color: white;
            font-weight: bold;
        }

        #video-container {
            width: 100%;
            max-width: 350px;
            margin: auto;
            position: relative;
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #result {
            margin-top: 10px;
            color: white;
            font-weight: bold;
        }

        button {
            margin-top: 12px;
            padding: 12px;
            width: 90%;
            max-width: 300px;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }

        #logoutBtn {
            background: #ff3333;
        }

        #viewBtn {
            background: #005ae0;
        }

        #Local {
            background: green;
        }

        #reset {
            background: #cc00FF;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>


    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>üì∏ QU√âT M√É QR</h2>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
</div>

<div id="result">ƒêang m·ªü camera...</div>

<button id="viewBtn">üìã Xem ch·∫•m c√¥ng</button>
<button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
<button id="Local" onclick="checkLocation()">Ki·ªÉm tra v·ªã tr√≠</button>
<div>
    <button id="reset">‚è≥ Qu√©t l·∫°i</button>
</div>
<script>
// S·ª¨A L·ªñI LOGIC: G·ªçi ƒë√∫ng h√†m startScanner()
document.getElementById('reset').addEventListener('click', () => {
    startScanner();
});

    function checkLocation() {
  if (!navigator.geolocation) {
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation!');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => alert(`Vƒ© ƒë·ªô: ${pos.coords.latitude}, Kinh ƒë·ªô: ${pos.coords.longitude}`),
    err => alert(`L·ªói: ${err.code} - ${err.message}`),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}
/* ===================== LOGIN ===================== */
const userEmail = sessionStorage.getItem("userEmail");
if (!userEmail) location.href = "index.html";

    /* ============ BI·∫æN ============ */
    const VALID_QR = "CHECKIN_GLASS_COMPANY";
    const videoElem = document.getElementById("video");
    const resultDiv = document.getElementById("result");
    let scanner;
// Bi·∫øn scanning kh√¥ng c√≤n c·∫ßn thi·∫øt n·∫øu d√πng logic c·ªßa qr-scanner
// let scanning = false; 

/* ===================== FIREBASE ===================== */
firebase.initializeApp({
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});
const db = firebase.database();
    /* ================== B·∫ÆT ƒê·∫¶U CAMERA ================== */
    async function startScanner() {
        resultDiv.textContent = "ƒêang kh·ªüi ƒë·ªông camera...";
        
        // Ki·ªÉm tra xem c√≥ camera kh√¥ng (ƒë·ªÅ xu·∫•t t·ª´ l·∫ßn tr∆∞·ªõc)
        if (!(await QrScanner.hasCamera())) {
             resultDiv.textContent = "‚ùå Kh√¥ng t√¨m th·∫•y camera.";
             return;
        }

        if (scanner) scanner.stop();

        // G·ªçi scanner UMD
        scanner = new QrScanner(
            videoElem,
            result => {
                scanner.stop();
                handleQRCode(result.data);
            },
            {
                highlightScanRegion: true,
                highlightCodeOutline: true,
                // S·ª¨A L·ªñI 2: Th√™m workerScript
                workerScript: 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner-worker.min.js'
            }
        );

        scanner.start().catch(err => {
            // Hi·ªÉn th·ªã l·ªói r√µ r√†ng, th∆∞·ªùng l√† l·ªói Quy·ªÅn (NotAllowedError)
            resultDiv.textContent = "‚ùå L·ªói camera: " + err;
        });
    }

    /* ================== X·ª¨ L√ù M√É QR ================== */
    function handleQRCode(data) {
        if (data !== VALID_QR) {
            alert("‚ùå M√£ QR kh√¥ng h·ª£p l·ªá!");
            startScanner(); // Cho qu√©t l·∫°i
            return;
        }

        resultDiv.textContent = "‚úÖ M√£ QR h·ª£p l·ªá! ƒêang l·∫•y GPS...";

        navigator.geolocation.getCurrentPosition(
            pos => {
                // S·ª¨A L·ªñI 4: G·ªçi h√†m saveAttendance
                saveAttendance(pos.coords.latitude, pos.coords.longitude);
            },
            err => {
                alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message);
                startScanner(); // L·ªói GPS, cho qu√©t l·∫°i
            },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    }

/* ===================== QR CHECK ===================== */
// S·ª¨A L·ªñI 1: X√≥a khai b√°o 'VALID_QR' tr√πng l·∫∑p
const COMPANY = { lat: 10.84964185816, lng: 106.58569113116 };

function encodeEmail(e) { return e.replace(/\./g, ","); }

    // t·∫Øt camera khi r·ªùi trang
window.addEventListener("pagehide", () => {
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    // D·ª´ng h·∫≥n scanner n·∫øu c√≥
    if (scanner) scanner.stop();
});

// b·∫≠t camera l·∫°i
    document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        // quay l·∫°i trang ‚Üí m·ªü l·∫°i camera
        // S·ª¨A L·ªñI 3: G·ªçi ƒë√∫ng h√†m startScanner
        startScanner();
    } else {
        // r·ªùi trang ‚Üí t·∫Øt camera
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(t => t.stop());
        }
        if (scanner) scanner.stop();
    }
});
    
/* ===================== T√çNH GI·ªú ===================== */
// S·ª¨A L·ªñI 6: X√≥a h√†m timeDiff b·ªã tr√πng l·∫∑p (ƒë√£ x√≥a h√†m c≈© ƒë∆°n gi·∫£n)
function distance(a, b, c, d) {
    const R = 6371000;
    let x = (c - a) * Math.PI / 180;
    let y = (d - b) * Math.PI / 180;
    let s = Math.sin(x/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(y/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
}
function timeDiff(a, b) {
    if (!a || !b) return 0;

    // ch·ªâ l·∫•y HH:MM
    a = a.replace(/[^0-9:]/g, "");
    b = b.replace(/[^0-9:]/g, "");

    if (!a.includes(":") || !b.includes(":")) return 0;

    const pa = a.split(":").map(Number);
    const pb = b.split(":").map(Number);

    if (pa.length < 2 || pb.length < 2) return 0;
    if (isNaN(pa[0]) || isNaN(pa[1]) || isNaN(pb[0]) || isNaN(pb[1])) return 0;

    const t1 = pa[0] + pa[1] / 60;
    const t2 = pb[0] + pb[1] / 60;
    return t2 - t1;
}
/* ===================== L∆ØU CH·∫§M C√îNG ===================== */
function saveAttendance(lat, lng) {

    // Kho·∫£ng c√°ch > 100m (b·∫°n c√≥ th·ªÉ tƒÉng/gi·∫£m n·∫øu c·∫ßn)
    if (distance(lat, lng, COMPANY.lat, COMPANY.lng) > 100) {
        
        alert("‚ùå B·∫°n qu√° xa c√¥ng ty!");
        setTimeout(() => {
                // S·ª¨A L·ªñI 3: G·ªçi ƒë√∫ng h√†m startScanner
                startScanner();
            }, 1000); // ƒë·ª£i ng∆∞·ªùi d√πng b·∫•m OK xong
        return;
        
    }

    const emailKey = encodeEmail(userEmail);
    const now = new Date();
    const day = now.toISOString().slice(0, 10);
    const time = now.toLocaleTimeString(); // V√≠ d·ª•: "08:30:15"
    const hour = now.getHours() + now.getMinutes() / 60;

    const ref = db.ref("chamcong/" + emailKey + "/" + day);

    ref.once("value").then((snap) => {
        let d = snap.val() || {};

        d.vaoCaSang ??= "";
        d.raCaSang ??= "";
        d.vaoCaTrua ??= "";
        d.raCaTrua ??= "";
        d.vaoCaChieu ??= "";
        d.raCaChieu ??= "";
        d.vaoLamThem ??= "";
        d.raLamThem ??= "";

        let msg = "";

        if (hour >= 7.5 && hour <= 11.5)
        {
            if(!d.vaoCaSang)
            {
                d.vaoCaSang = time;
                // msg="V√†o ca s√°ng"; // B·ªã ghi ƒë√®
                msg="ƒëi mu·ªôn!";
                d.noteVaoCaSang = "ƒëi mu·ªôn";
            }
            else{
                 d.raCaSang = time;
                msg="V·ªÅ s·ªõm!";
                d.noteRaCaSang = "v·ªÅ s·ªõm";
            }
                
        }
      else  if (hour < 7.5){
        if(!d.vaoCaSang)
        {
            d.vaoCaSang = time;
            msg="S√°ng ƒëi s·ªõm";
             d.noteVaoCaSang = "ƒëi s·ªõm";
        }
      }
            
        // ======= CA TR∆ØA =======
// C. CA TR∆ØA (11:30 - 13:00)
        else if (hour > 11.5 && hour <= 13.0) { 
            // 1. Auto Ra Ca S√°ng n·∫øu ch∆∞a c√≥
            if (!d.raCaSang && d.vaoCaSang) {
                d.raCaSang = "11:30:00"; 
                d.noteRaCaSang = "auto ƒë√∫ng gi·ªù";
            }
            
            // 2. Logic V√†o/Ra Ca Tr∆∞a
            if (!d.vaoCaTrua) {
                // L·∫ßn qu√©t ƒë·∫ßu ti√™n trong khung gi·ªù n√†y l√† V√ÄO TR∆ØA
                d.vaoCaTrua = "11:30"; // L∆∞u gi·ªù th·ª±c t·∫ø (v√≠ d·ª•: 11:34:00)
                d.raCaTrua = time;
                d.noteVaoCaTrua="tƒÉng ca tr∆∞a";
                
                msg = "tƒÉng ca tr∆∞a";
            }
          //  else if (!d.raCaTrua) {
                // L·∫ßn qu√©t th·ª© hai l√† RA TR∆ØA
           //     d.raCaTrua = time;
           //     msg = "Ra ca tr∆∞a";
           //     if (timeDiff(d.vaoCaTrua, d.raCaTrua) < 0.5) { 
            //        d.noteRaCaTrua = "ngh·ªâ tr∆∞a qu√° √≠t";
            //    }
          //  } 
            else {
                msg = "ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng tr∆∞a.";
            }
        }

       else if (hour > 13.03 && hour <= 17.5) {
         if(d.vaoCaTrua && !d.raCaTrua)
             {
                  d.raCaTrua=d.vaoCaTrua;
                  d.vaoCaTrua="11:30";
                 d.noteraCaTrua="ca tr∆∞a"
             }
        else if (!d.raCaSang&&!d.vaoCaTrua&&!d.raCaTrua) {
             d.raCaSang = "11:30";
            d.vaoCaTrua="11:30";
            d.raCaTrua="13:00";
             msg = "l√†m xuy√™n tr∆∞a";
             d.noteVaoCaTrua="l√†m xuy√™n tr∆∞a";
        
         }
             
         else  (!d.vaoCaChieu) {
             d.vaoCaChieu = time;
             msg = "V√†o ca chi·ªÅu";
             d.noteVaoCaChieu="chi·ªÅu ƒëi mu·ªôn ";
        
         }
             
             
            // S·ª¨A L·ªñI 5: L·ªói ch√≠nh t·∫£ 'RaCaSang' -> 'raCaSang'
            else if(!d.raCaSang)
            {
                 d.raCaSang="11:30";
                 d.vaoCaTrua="11:30";
                 d.raCaTrua="13:00";
                
                 
            }
            else  {
                 d.raCaChieu = time;
                 msg = "Ra ca chi·ªÅu";
                
                 // üëâ Ghi ch√∫ ca chi·ªÅu (ra s·ªõm)
            if (hour < 17.5) {
                         d.noteRaCaChieu = "V·ªÅ s·ªõm";
                         }
            }
     }
            
       else if (hour > 17.5)
       {
          if( d.vaoCaChieu && !d.raCaChieu)
          {
             d.raCaChieu="17:30";
              d.vaoLamThem = "17:30";
             d.raLamThem = time;
             msg = "tƒÉng ca t·ªëi - v√†o ghi ch√∫ ƒë·ªÉ b·ªï sung";
             d.noteRaLamThem="tƒÉng ca t·ªëi"
            
              
          }
              else if(d.vaoCaSang&&!d.vaoCaTrua&&!d.vaoCaChieu)
              {
                 
                  d.raCaSang="11:30";
                 d.vaoCaTrua="11:30";
                 d.raCaTrua="13:00";
                  d.vaoCaChieu="13:00";
                  d.raCaChieu="17:30";
                  d.vaoLamThem="17:30";
                  d.raLamThem=time;
                   msg = "L√†m xuy√™n ng√†y ";
                  d.noteRaLamThem="l√†m xuy√™n ng√†y";
              }
           else {
                  d.vaoLamThem = "17:30";
                  d.raLamThem = time;
               msg = "tƒÉng ca t·ªëi ";
               d.noteRaLamThem="tƒÉng ca t·ªëi"
           }
           

       }

        // T√çNH GI·ªú
        let total = 0;
total += timeDiff(d.vaoCaSang, d.raCaSang);
total += timeDiff(d.vaoCaTrua, d.raCaTrua); // B·∫°n ƒëang t√≠nh gi·ªù ngh·ªâ tr∆∞a l√† gi·ªù l√†m?
total += timeDiff(d.vaoCaChieu, d.raCaChieu);
d.gioLamTrongNgay = total.toFixed(2);

// L∆∞u √Ω: B·∫°n ƒëang c·ªông gi·ªù ngh·ªâ tr∆∞a v√†o gi·ªù l√†m th√™m
let ot = timeDiff(d.vaoLamThem, d.raLamThem)+timeDiff(d.vaoCaTrua,d.raCaTrua);
d.gioLamThem = ot.toFixed(2);

        d.diaDiemQuet = `${lat},${lng}`;

        ref.set(d).then(() => {
         // scanning = false; // Kh√¥ng c·∫ßn thi·∫øt n·∫øu d√πng logic c·ªßa qr-scanner
            alert(
                "‚úî Ch·∫•m c√¥ng th√†nh c√¥ng!\n" +
                "üìÖ Ng√†y: "+day+"\n"+
                "‚è∞ "+time+"_"+msg+"\n"+
                "‚è≥ Gi·ªù l√†m: "+d.gioLamTrongNgay+"h\n"+
                "üåô TƒÉng ca: "+d.gioLamThem+"h"
            );

            setTimeout(() => {
                // S·ª¨A L·ªñI 3: G·ªçi ƒë√∫ng h√†m startScanner
                startScanner();
            }, 1000); // ƒë·ª£i ng∆∞·ªùi d√πng b·∫•m OK xong
             });
    });
}

// S·ª¨A L·ªñI 3: X√≥a b·ªè h√†m restartScan() v√† scanLoop() kh√¥ng c·∫ßn thi·∫øt

/* ===================== BUTTONS ===================== */
document.getElementById("viewBtn").onclick = () =>
    location.href = "xem.html?user=" + userEmail;

document.getElementById("logoutBtn").onclick = () => {
    sessionStorage.clear();
    location.href = "index.html";
};

/* ===================== AUTO START ===================== */
    /* ================== AUTO M·ªû CAMERA ================== */
    window.onload = startScanner;

</script>

</body>
</html>

















