<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

    <style>
        body {
            font-family: Arial;
            text-align: center;
            background: #00c6ff;
            margin: 0;
            padding: 10px;
        }

        h2 {
            color: white;
            font-weight: bold;
        }

        #video-container {
            width: 100%;
            max-width: 350px;
            margin: auto;
            position: relative;
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        #result {
            margin-top: 10px;
            color: white;
            font-weight: bold;
        }

        button {
            margin-top: 12px;
            padding: 12px;
            width: 90%;
            max-width: 300px;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }

        #logoutBtn {
            background: #ff3333;
        }

        #viewBtn {
            background: #005ae0;
        }

        #reset {
            background: #cc00FF;
        }
    </style>

    <!-- üî• LOAD QR-SCANNER KH√îNG IMPORT -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

    <h2>üì∏ QU√âT M√É QR</h2>

    <div id="video-container">
        <video id="video" muted playsinline></video>
    </div>

    <div id="result">ƒêang m·ªü camera...</div>

    <button id="viewBtn">üìã Xem ch·∫•m c√¥ng</button>
    <button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
    <button id="reset">‚è≥ Qu√©t l·∫°i</button>

    <script>
        /* ================= FIREBASE ================= */
        firebase.initializeApp({
            apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
            authDomain: "sellglass-3ebe9.firebaseapp.com",
            databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sellglass-3ebe9",
            storageBucket: "sellglass-3ebe9.appspot.com",
            messagingSenderId: "513741829035",
            appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
        });
        const db = firebase.database();

        /* ============ BI·∫æN ============ */
        const VALID_QR = "CHECKIN_GLASS_COMPANY";
        const videoElem = document.getElementById("video");
        const resultDiv = document.getElementById("result");
        let scanner;

        /* ================== B·∫ÆT ƒê·∫¶U CAMERA ================== */
        function startScanner() {
            if (scanner) scanner.stop();

            // G·ªçi scanner UMD
            scanner = new QrScanner(
                videoElem,
                result => {
                    scanner.stop();
                    handleQRCode(result.data);
                },
                {
                    highlightScanRegion: true,
                    highlightCodeOutline: true
                }
            );

            scanner.start().catch(err => {
                resultDiv.textContent = "‚ùå Kh√¥ng m·ªü ƒë∆∞·ª£c camera: " + err;
            });
        }

        /* ================== X·ª¨ L√ù M√É QR ================== */
        function handleQRCode(data) {
            if (data !== VALID_QR) {
                alert("‚ùå M√£ QR kh√¥ng h·ª£p l·ªá!");
                startScanner();
                return;
            }

            resultDiv.textContent = "ƒêang l·∫•y GPS...";

            navigator.geolocation.getCurrentPosition(
                pos => {
                    alert("üéâ Qu√©t OK!\nLat: " + pos.coords.latitude + "\nLng: " + pos.coords.longitude);
                    startScanner();
                },
                err => {
                    alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message);
                    startScanner();
                },
                { enableHighAccuracy: true, timeout: 8000 }
            );
        }




        /* ================== N√öT ================== */
        document.getElementById("reset").onclick = startScanner;
        document.getElementById("viewBtn").onclick = () => location.href = "xem.html";
        document.getElementById("logoutBtn").onclick = () => {
            sessionStorage.clear();
            location.href = "index.html";
        };

        /* ================== AUTO M·ªû CAMERA ================== */
        window.onload = startScanner;
    </script>

</body>
</html>
