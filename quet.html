<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body { font-family: Arial; text-align:center; background:#00c6ff; margin:0; padding:10px; }
h2 { color:white; font-weight:bold; }
#video-container { width:100%; max-width:350px; margin:auto; position:relative; }
video { width:100%; border-radius:10px; }
#result { margin-top:10px; color:white; font-weight:bold; }
button {
    margin-top:12px; padding:12px; width:90%; max-width:300px;
    border:none; border-radius:10px; color:white; font-size:16px;
}
#logoutBtn { background:#ff3333; }
#viewBtn   { background:#005ae0; }
#reset     { background:#cc00FF; }
</style>

<!-- ğŸ”¥ LOAD QR-SCANNER KHÃ”NG IMPORT -->
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>ğŸ“¸ QUÃ‰T MÃƒ QR</h2>

<div id="video-container">
    <video id="video" muted playsinline></video>
</div>

<div id="result">Äang má»Ÿ camera...</div>

<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>
<button id="reset">â³ QuÃ©t láº¡i</button>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});
const db = firebase.database();

/* ============ BIáº¾N ============ */
const VALID_QR = "CHECKIN_GLASS_COMPANY";
const videoElem = document.getElementById("video");
const resultDiv = document.getElementById("result");
let scanner;

/* ================== Báº®T Äáº¦U CAMERA ================== */
function startScanner() {
    if (scanner) scanner.stop();

    // Gá»i scanner UMD
    scanner = new QrScanner(
        videoElem,
        result => {
            scanner.stop();
            handleQRCode(result.data);
        },
        {
            highlightScanRegion: true,
            highlightCodeOutline: true
        }
    );

    scanner.start().catch(err => {
        resultDiv.textContent = "âŒ KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera: " + err;
    });
}

/* ================== Xá»¬ LÃ MÃƒ QR ================== */
function handleQRCode(data) {
    if (data !== VALID_QR) {
        alert("âŒ MÃ£ QR khÃ´ng há»£p lá»‡!");
        startScanner();
        return;
    }

    resultDiv.textContent = "Äang láº¥y GPS...";

    navigator.geolocation.getCurrentPosition(
        pos => {
            alert("ğŸ‰ QuÃ©t OK!\nLat: " + pos.coords.latitude + "\nLng: " + pos.coords.longitude);
            startScanner();
        },
        err => {
            alert("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c GPS: " + err.message);
            startScanner();
        },
        { enableHighAccuracy:true, timeout:8000 }
    );
}

/* ================== NÃšT ================== */
document.getElementById("reset").onclick = startScanner;
document.getElementById("viewBtn").onclick = () => location.href = "xem.html";
document.getElementById("logoutBtn").onclick = () => {
    sessionStorage.clear();
    location.href = "index.html";
};

/* ================== AUTO Má» CAMERA ================== */
window.onload = startScanner;
</script>

</body>
</html>
