<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body {
  font-family: Arial;
  background: linear-gradient(to right,#00ffff,#00c6ff);
  text-align:center;
  margin:0; padding:10px;
}
h2 { color:#fff; }
#video-container {
  width:100%; max-width:360px;
  margin:20px auto;
  border:2px solid #0099ff;
  border-radius:12px;
  overflow:hidden;
}
video { width:100%; }
#result { white-space:pre-line; font-weight:bold; margin-top:10px; }
button {
  margin-top:12px;
  padding:12px 20px;
  border:none;
  background:green;
  color:white;
  font-size:16px;
  border-radius:8px;
  width:90%;
  max-width:320px;
}
#logoutBtn { background:#ff3333; }
#viewBtn { background:#005ae0; }
#retry { background:#ffaa00; }
</style>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>ğŸ“¸ QUÃ‰T MÃƒ QR CHáº¤M CÃ”NG</h2>

<div id="video-container">
  <video id="video" autoplay playsinline></video>
</div>

<div id="result">Äang má»Ÿ camera...</div>

<button id="retry">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<script>
/* =========== KHá»I Äá»˜NG =========== */
const userEmail = sessionStorage.getItem("userEmail");
if(!userEmail){
  alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
  window.location.href = "index.html";
}

const video = document.getElementById("video");
const resultDiv = document.getElementById("result");
const retryBtn = document.getElementById("retry");
const viewBtn = document.getElementById("viewBtn");
const logoutBtn = document.getElementById("logoutBtn");

let scanning = false;

/* =========== Báº¬T CAMERA Tá»° Äá»˜NG =========== */
async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });
    video.srcObject = stream;
    scanning = true;
    resultDiv.textContent="Äang quÃ©t mÃ£...";
    requestAnimationFrame(scanLoop);
  } catch (e){
    resultDiv.textContent="âŒ KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera!";
  }
}

function scanLoop(){
  if(!scanning) return;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const qr = jsQR(img.data, img.width, img.height);

  if(qr){
    scanning = false;
    handleQR(qr.data);
    return;
  }
  requestAnimationFrame(scanLoop);
}

retryBtn.onclick = ()=>{
  resultDiv.textContent="Äang quÃ©t láº¡i...";
  scanning = true;
  requestAnimationFrame(scanLoop);
};

/* =========== FIREBASE =========== */
firebase.initializeApp({
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});

const db = firebase.database();
const VALID_QR = "CHECKIN_GLASS_COMPANY";
const COMPANY = { lat:10.84964185816, lng:106.58569113116 };

function encodeEmail(e){ return e.replace(/\./g,","); }

/* =========== Xá»¬ LÃ QR =========== */
function handleQR(text){
  if(text !== VALID_QR){
    alert("âŒ MÃ£ QR khÃ´ng há»£p lá»‡!");
    return;
  }

  resultDiv.textContent = "Äang láº¥y vá»‹ trÃ­ GPS...";

  navigator.geolocation.getCurrentPosition(
    pos => saveAttendance(pos.coords.latitude, pos.coords.longitude),
    err => alert("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c GPS!"),
    { enableHighAccuracy:true, timeout:5000 }
  );
}

/* =========== TÃNH GIá»œ =========== */
function timeDiff(t1,t2){
  const p1 = t1.replace(/[^0-9:]/g,"").split(":").map(Number);
  const p2 = t2.replace(/[^0-9:]/g,"").split(":").map(Number);
  const h1 = p1[0] + p1[1]/60;
  const h2 = p2[0] + p2[1]/60;
  return h2 - h1;
}

function getDistance(lat1,lon1,lat2,lon2){
  const R = 6371000;
  const x = (lat2-lat1)*Math.PI/180;
  const y = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(x/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(y/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* =========== LÆ¯U CHáº¤M CÃ”NG =========== */
function saveAttendance(lat, lng){
  const email = userEmail;
  const key = encodeEmail(email);

  const now = new Date();
  const day = now.toISOString().slice(0,10);
  const time = now.toLocaleTimeString();
  const hour = now.getHours() + now.getMinutes()/60;

  // kiá»ƒm tra GPS
  const d = getDistance(lat, lng, COMPANY.lat, COMPANY.lng);
  if(d > 100){
    alert("âŒ Báº¡n Ä‘ang quÃ¡ xa cÃ´ng ty: " + d.toFixed(1) + "m");
    return;
  }

  const ref = db.ref("chamcong/"+key+"/"+day);

  ref.once("value").then(snap=>{
    const data = snap.val() || {};

    // Ä‘áº£m báº£o cÃ³ field ghi chÃº
    data.noteVaoCaSang ??= "";
    data.noteRaCaSang ??= "";
    data.noteVaoCaTrua ??= "";
    data.noteRaCaTrua ??= "";
    data.noteVaoCaChieu ??= "";
    data.noteRaCaChieu ??= "";
    data.noteVaoOT ??= "";
    data.noteRaOT ??= "";
    data.ghiChu ??= "";

    let msg="";

    /* ===== CA SÃNG ===== */
    if(hour>=7.5 && hour<=11.5){
      if(!data.vaoCaSang){
        data.vaoCaSang = time;
        if(hour>7.5) data.noteVaoCaSang += "Äi muá»™n. ";
        msg="VÃ o ca sÃ¡ng";
      } else {
        data.raCaSang = time;
        if(hour<11.5) data.noteRaCaSang += "Ra sá»›m. ";
        msg="Ra ca sÃ¡ng";
      }
    }

    /* ===== CA TRÆ¯A ===== */
    else if(hour>=11.5 && hour<13){
      if(!data.vaoCaTrua){
        data.vaoCaTrua = time;
        data.noteVaoCaTrua += "Báº¯t Ä‘áº§u ca trÆ°a. ";
        msg="VÃ o ca trÆ°a";
      } else {
        data.raCaTrua = time;
        data.noteRaCaTrua += "Káº¿t thÃºc ca trÆ°a. ";
        msg="Ra ca trÆ°a";
      }
    }

    /* ===== CA CHIá»€U ===== */
    else if(hour>=13 && hour<=17.5){
      if(!data.vaoCaChieu){
        data.vaoCaChieu = time;
        if(hour>13) data.noteVaoCaChieu += "Äi muá»™n ca chiá»u. ";
        msg="VÃ o ca chiá»u";
      } else {
        data.raCaChieu = time;
        if(hour<17.5) data.noteRaCaChieu += "Ra sá»›m. ";
        msg="Ra ca chiá»u";
      }
    }

    /* ===== TÄ‚NG CA ===== */
    else if(hour>17.5){
      if(!data.vaoLamThem){
        data.vaoLamThem = time;
        data.noteVaoOT += "Báº¯t Ä‘áº§u tÄƒng ca. ";
        msg="VÃ o OT";
      } else {
        data.raLamThem = time;
        data.noteRaOT += "Káº¿t thÃºc tÄƒng ca. ";
        msg="Ra OT";
      }
    }

    /* ===== TÃNH GIá»œ ===== */
    let total = 0;

    if(data.vaoCaSang && data.raCaSang)
      total += timeDiff(data.vaoCaSang, data.raCaSang);

    if(data.vaoCaTrua && data.raCaTrua)
      total += timeDiff(data.vaoCaTrua, data.raCaTrua);

    if(data.vaoCaChieu && data.raCaChieu)
      total += timeDiff(data.vaoCaChieu, data.raCaChieu);

    data.gioLamTrongNgay = total.toFixed(2);

    let ot = 0;
    if(data.vaoLamThem && data.raLamThem)
      ot = timeDiff(data.vaoLamThem, data.raLamThem);
    data.gioLamThem = ot.toFixed(2);

    data.diaDiemQuet = lat + ", " + lng;

    ref.set(data).then(()=>{
      alert("âœ” " + msg);
      resultDiv.textContent = "âœ” ÄÃ£ lÆ°u cháº¥m cÃ´ng\n" + JSON.stringify(data,null,2);
    });

  });
}

/* =========== BUTTONS =========== */
viewBtn.onclick = ()=>{
  window.location.href = "xem.html?user="+userEmail;
};
logoutBtn.onclick = ()=>{
  sessionStorage.removeItem("userEmail");
  window.location.href = "index.html";
};

/* ======= AUTO START CAMERA ======= */
window.onload = startCamera;
</script>

</body>
</html>
