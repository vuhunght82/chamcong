<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>
<style>
body {
        font-family: Arial;
        text-align: center;
        background: linear-gradient(to right, #00ffff, #00c6ff);
        margin: 0;
        padding: 0 10px;
    }
h1 { color:#ffffff; margin: 15px 0; }
#video-container { margin:20px auto; width:100%; max-width:360px; border:2px solid #007bff; border-radius:10px; overflow:hidden; }
video { width:100%; height:auto; }
#result { font-weight:bold; color:green; margin-top:20px; white-space: pre-line; }
#error { color:red; margin-top:10px; }
    button {
        margin: 5px;
        padding: 20px 30px;
        font-size: 16px;
        border-radius: 10px;
        background-color:green;
        color:#fff;
        border-color:#fff;
    }
@media (max-width:480px){
  button, input { width:95%; font-size:1em; }
}
</style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init("zw8NnWti6A--Pyys9"); // ğŸ”¹ Thay YOUR_PUBLIC_KEY báº±ng mÃ£ trong EmailJS Dashboard
  })();
</script>
</head>
  
<body>
<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<h1>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h1>

<div id="video-container">
  <video id="qr-video" muted></video>
</div>

<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>
<button id="restartBtn" style="display:none;">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>
<button onclick="checkLocation()">Kiá»ƒm tra vá»‹ trÃ­</button>
<script>
function checkLocation() {
  if (!navigator.geolocation) {
    alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ geolocation!');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => alert(`VÄ© Ä‘á»™: ${pos.coords.latitude}, Kinh Ä‘á»™: ${pos.coords.longitude}`),
    err => alert(`Lá»—i: ${err.code} - ${err.message}`),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}
</script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QR Scanner -->
<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

// ================== Firebase ==================
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================== Kiá»ƒm tra Ä‘Äƒng nháº­p ==================
const userEmail = sessionStorage.getItem('userEmail');
if (!userEmail) {
  alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
  window.location.href = 'index.html';
}

// ================== Elements ==================
const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const restartBtn = document.getElementById('restartBtn');
const logoutBtn = document.getElementById('logoutBtn');
const viewBtn = document.getElementById('viewBtn');

let scanner;

// ================== HÃ m quÃ©t ==================
function startScanner() {
  scanner = new QrScanner(videoElem, qrResult => {
    navigator.geolocation.getCurrentPosition(
      pos => handleAttendance(userEmail, qrResult.data, pos.coords.latitude, pos.coords.longitude),
      err => {
       
        console.warn('âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­:', err);
        handleAttendance(userEmail, qrResult.data, null, null);
      },
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );
  }, { highlightScanRegion: true, highlightCodeOutline: true });

  scanner.start().catch(err => {
    console.error(err);
    errorDiv.textContent = 'âŒ KhÃ´ng thá»ƒ má»Ÿ camera: ' + err;
  });
}

// Vá»‹ trÃ­ cÃ´ng ty (kinh Ä‘á»™, vÄ© Ä‘á»™)
const COMPANY_LOCATION = { lat: 10.849641858164617, lng: 106.58569113116769 }; // Thay báº±ng tá»a Ä‘á»™ tháº­t
// 10.849641858164617,106.58569113116769
// Ná»™i dung QR chuáº©n
const VALID_QR_CODE = "CHECKIN_GLASS_COMPANY";

// ================== Xá»­ lÃ½ cháº¥m cÃ´ng ==================
function handleAttendance(email, qrContent, lat, lng) {
  scanner.stop();

// --- Kiá»ƒm tra QR ---
  if(qrContent !== VALID_QR_CODE){
    alert('âŒ MÃ£ QR khÃ´ng há»£p lá»‡!');
    restartBtn.style.display = 'inline-block';
    return;
  }

  // --- Kiá»ƒm tra khoáº£ng cÃ¡ch GPS ---
  if(lat && lng){
    const distance = getDistanceFromLatLonInMeters(lat, lng, COMPANY_LOCATION.lat, COMPANY_LOCATION.lng);
    if(distance > 100){
      

      alert(`âŒ Vá»‹ trÃ­ quÃ©t quÃ¡ xa so vá»›i cÃ´ng ty (${distance.toFixed(1)} m)!`);
      restartBtn.style.display = 'inline-block';
      return;
    }
  } else {
    alert('âŒ KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c vá»‹ trÃ­ quÃ©t!');
    restartBtn.style.display = 'inline-block';
    return;
  }
  
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const currentTime = now.toLocaleTimeString();
  const currentHour = now.getHours() + now.getMinutes() / 60;
  const emailKey = encodeEmail(email);
  const ref = db.ref('chamcong/' + emailKey + '/' + today);
  
  ref.once('value')
    .then(snapshot => {
      const data = snapshot.val() || {};
      let msg = '';
      let isOvertime = false;
 
    let ghichucalam="";
let noteVaoCaSang="";
            let noteRaCaSang="";
            let noteVaoCaTrua="";
            let noteRaCaTrua="";
            let noteVaoChieu="";
            let noteRaCaChieu="";
            let noteVaoLamThem="";
            let noteRaLamThem="";
            
             
      // --- Ca sÃ¡ng ---
if (currentHour >= 7.5 && currentHour <= 11.5) {
  if (!data.vaoCaSang) {
    data.vaoCaSang = currentTime;
    if (currentHour > 7.5) msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
    ghichucalam += 'Äi muá»™n ca sÃ¡ng! ';
  } else {
    data.raCaSang = currentTime;
    if (currentHour < 11.5) msg += 'âš  Vá» sá»›m ca sÃ¡ng! ';
    noteRaCaSang += 'Vá» sá»›m ca sÃ¡ng! ';
  }
}

        // ca trua
     else  if (currentHour > 11.5 && currentHour < 13) {
  if (!data.vaoCaTrua) {
    data.vaoCaTrua = currentTime;
   noteVaoCaTrua = 'vÃ o LÃ m trÆ°a';
  } else {
    data.raCaTrua = currentTime;
   noteRaCaTrua="lÃ m thÃªm trÆ°a"
  }
}

// --- Äi sá»›m ca sÃ¡ng ---
else if (currentHour < 7.5) {
  data.vaoCaSang = currentTime;
  msg += 'âœ… Äi sá»›m ca sÃ¡ng! ';
  ghichucalam += 'Äi sá»›m ca sÃ¡ng! ';
}

// --- Ca chiá»u ---
else if (currentHour >= 13 && currentHour <= 17.5) {
  if (!data.vaoCaChieu) {
    data.vaoCaChieu = currentTime;
    if (currentHour > 13);
    noteVaoCaChieu += 'Äi muá»™n ca chiá»u! ';
  } else {
    data.raCaChieu = currentTime;
    if (currentHour < 17.5)
    noteRaCaChieu+= 'âš  Vá» sá»›m ca chiá»u! ';
    data.raCaChieu = currentTime;
  }
}

// --- Nghá»‰ trÆ°a / LÃ m thÃªm giá»¯a ca ---
else if (currentHour >= 11.5 && currentHour < 13) {
  isOvertime = true;
  msg += 'ğŸ•› QuÃ©t trong giá» nghá»‰ trÆ°a. ';
  ghichucalam += 'QuÃ©t trong giá» nghá»‰ trÆ°a. ';
 if( !data.vaoLamThem)
 {
        data.vaoLamThem= currentTime;
         
 }
        else if (data.vaoLamThem && !data.raLamThem)
        {
                data.raLamThem= currentTime;
        }
}

// --- LÃ m thÃªm sau giá» ---
else if (currentHour > 17.5) {
  isOvertime = true;
  msg += 'â„¹ Giá» lÃ m thÃªm sau giá» hÃ nh chÃ­nh. ';
 // ghichucalam += 'Giá» lÃ m thÃªm sau giá» hÃ nh chÃ­nh. ';

  // Náº¿u chÆ°a chá»‘t ca chiá»u, tá»± Ä‘á»™ng chá»‘t
  if (!data.raCaChieu) {
    data.raCaChieu = '17:30';
    msg += 'âš  Tá»± Ä‘á»™ng chá»‘t ca chiá»u 17:30. ';
  }
  data.vaoLamThem = '17:30';
  data.raLamThem = currentTime+ '(lÃ m thÃªm)';
}
    
      // --- TÃ­nh tá»•ng giá» lÃ m ---
      let totalHours = 0;
      if (data.vaoCaSang && data.raCaSang) totalHours += parseTime(data.raCaSang) - parseTime(data.vaoCaSang);
      if (data.vaoCaChieu && data.raCaChieu) totalHours += parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu);
      data.gioLamTrongNgay = totalHours.toFixed(2);

      data.noiDungMaQuet = qrContent;
      data.diadiemQuet = (lat && lng) ? `${lat},${lng}` : 'ChÆ°a láº¥y GPS';

      // Nháº­p ghi chÃº náº¿u lÃ m thÃªm
      if (isOvertime) {
        const note = prompt("ğŸ“ Báº¡n cÃ³ giá» lÃ m thÃªm, vui lÃ²ng nháº­p ghi chÃº:");
         if (note) ghiChu += note + ' ';
       
      }

    

  // GÃ¡n trá»±c tiáº¿p vÃ o data trÆ°á»›c khi set:
  data.noteCaTrua = ghichucalam;
data.noteVaoCaChieu=noteVaoCaChieu;
      
        // --- LÆ°u dá»¯ liá»‡u Firebase ---
      ref.set(data)
        .then(() => {
         
          // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o
          alert('âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!\n' + msg + (isOvertime ? '\nGhi chÃº: ' + (data.ghiChu || ''): ''));


          
          // Cáº­p nháº­t trÃªn trang
          resultDiv.textContent = `NhÃ¢n viÃªn: ${email}
SÃ¡ng: ${data.vaoCaSang || '-'} - ${data.raCaSang || '-'}
Chiá»u: ${data.vaoCaChieu || '-'} - ${data.raCaChieu || '-'}
Tá»•ng giá»: ${data.gioLamTrongNgay}h
${msg}`;
          restartBtn.style.display = 'inline-block';

});
});
}
// ================== HÃ m phá»¥ trá»£ ==================
function encodeEmail(email) {
  return email.replace(/\./g, ',');
}
function parseTime(timeStr) {
  if (!timeStr) return 0;
  // Bá» má»i kÃ½ tá»± khÃ´ng pháº£i sá»‘ hoáº·c dáº¥u ':'
  timeStr = timeStr.replace(/[^0-9:]/g, '');
  const [h, m, s = 0] = timeStr.split(':').map(Number);
  return h + (m || 0) / 60 + (s || 0) / 3600;
}

// ================== Sá»± kiá»‡n ==================
restartBtn.addEventListener('click', startScanner);
logoutBtn.addEventListener('click', () => {
  sessionStorage.removeItem('userEmail');
  window.location.href = 'index.html';
});
viewBtn.addEventListener('click', () => {
  window.location.href = 'xem.html';
});

window.addEventListener('load', startScanner);
  // HÃ m tÃ­nh khoáº£ng cÃ¡ch giá»¯a 2 Ä‘iá»ƒm (m)
function getDistanceFromLatLonInMeters(lat1,lon1,lat2,lon2){
  const R = 6371000; // bÃ¡n kÃ­nh TrÃ¡i Äáº¥t (m)
  const dLat = deg2rad(lat2-lat1);
  const dLon = deg2rad(lon2-lon1);
  const a = 
    Math.sin(dLat/2)*Math.sin(dLat/2)+
    Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*
    Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function deg2rad(deg){ return deg*Math.PI/180; }
</script>
</body>
</html>
















































































