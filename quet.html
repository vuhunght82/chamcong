<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

    <style>
        body {
            font-family: Arial;
            text-align: center;
            background: #00c6ff;
            margin: 0;
            padding: 10px;
        }

        h2 {
            color: white;
            font-weight: bold;
        }

        #video-container {
            width: 100%;
            max-width: 350px;
            margin: auto;
            position: relative;
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #result {
            margin-top: 10px;
            color: white;
            font-weight: bold;
        }

        button {
            margin-top: 12px;
            padding: 12px;
            width: 90%;
            max-width: 300px;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }

        #logoutBtn {
            background: #ff3333;
        }

        #viewBtn {
            background: #005ae0;
        }

        #Local {
            background: green;
        }

        #reset {
            background: #cc00FF;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

    <script>
        // Ph·∫£i thi·∫øt l·∫≠p WorkerPath ngay sau khi th∆∞ vi·ªán ch√≠nh ƒë∆∞·ª£c t·∫£i.
        if (typeof QrScanner !== 'undefined') {
            QrScanner.WorkerPath = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner-worker.min.js';
        } else {
            console.error("L·ªói: QrScanner kh√¥ng t·∫£i ƒë∆∞·ª£c.");
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>üì∏ QU√âT M√É QR</h2>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
</div>

<div id="result">ƒêang m·ªü camera...</div>

<button id="viewBtn">üìã Xem ch·∫•m c√¥ng</button>
<button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
<button id="Local" onclick="checkLocation()">Ki·ªÉm tra v·ªã tr√≠</button>
<div>
    <button id="reset">‚è≥ Qu√©t l·∫°i</button>
</div>

<script>
/* ===================== C√ÅC H√ÄM C∆† B·∫¢N V√Ä BI·∫æN (GLOBAL SCOPE) ===================== */

// Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
const VALID_QR = "CHECKIN_GLASS_COMPANY";
const resultDiv = document.getElementById("result");
const videoElem = document.getElementById('video');
let scanner;
let scanning = false;
const COMPANY = { lat: 10.84964185816, lng: 106.58569113116 }; // T·ªça ƒë·ªô c√¥ng ty

const userEmail = sessionStorage.getItem("userEmail");
if (!userEmail) location.href = "index.html";


/* ===================== FIREBASE ===================== */
firebase.initializeApp({
    apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
    authDomain: "sellglass-3ebe9.firebaseapp.com",
    databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sellglass-3ebe9",
    storageBucket: "sellglass-3ebe9.appspot.com",
    messagingSenderId: "513741829035",
    appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});
const db = firebase.database();


/* ===================== H√ÄM H·ªñ TR·ª¢ CHUNG ===================== */

function encodeEmail(e) { return e.replace(/\./g, ","); }

function distance(a, b, c, d) {
    const R = 6371000;
    let x = (c - a) * Math.PI / 180;
    let y = (d - b) * Math.PI / 180;
    let s = Math.sin(x/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(y/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
}

// H√†m timeDiff t·ªëi ∆∞u v√† an to√†n
function timeDiff(a, b) {
    if (!a || !b) return 0;
    a = a.replace(/[^0-9:]/g, "");
    b = b.replace(/[^0-9:]/g, "");

    if (!a.includes(":") || !b.includes(":")) return 0;

    const pa = a.split(":").map(Number);
    const pb = b.split(":").map(Number);

    if (pa.length < 2 || pb.length < 2) return 0;
    if (isNaN(pa[0]) || isNaN(pa[1]) || isNaN(pb[0]) || isNaN(pb[1])) return 0;

    const t1 = pa[0] + pa[1] / 60;
    const t2 = pb[0] + pb[1] / 60;
    return t2 - t1;
}

// Kh·∫Øc ph·ª•c l·ªói checkLocation is not defined: H√†m n√†y ph·∫£i n·∫±m ·ªü global scope
function checkLocation() {
    if (!navigator.geolocation) {
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation!');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => alert(`Vƒ© ƒë·ªô: ${pos.coords.latitude}, Kinh ƒë·ªô: ${pos.coords.longitude}`),
        err => alert(`L·ªói: ${err.code} - ${err.message}`),
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

/* ================== QU√âT & CAMERA ================== */

function restartScan() {
    resultDiv.textContent = "ƒêang qu√©t...";
    scanning = true;
    // G·ªçi start() ƒë·ªÉ m·ªü l·∫°i lu·ªìng camera
    if (scanner) scanner.start().catch(err => {
         console.error("L·ªói kh·ªüi ƒë·ªông l·∫°i camera:", err);
         startScanner();
    });
    else startScanner();
}

function startScanner() {
    if (scanner) scanner.stop();

    // Kh·ªüi t·∫°o QrScanner
    scanner = new QrScanner(
        videoElem,
        result => {
            scanner.stop(); 
            handleQRCode(result.data);
        },
        {
            highlightScanRegion: true,
            highlightCodeOutline: true
        }
    );

    scanner.start().catch(err => {
        resultDiv.textContent = "‚ùå Kh√¥ng m·ªü ƒë∆∞·ª£c camera: " + err;
        console.error("Camera error:", err);
    });
}

// B·∫Øt ƒë·∫ßu qu√©t khi DOM t·∫£i xong
document.addEventListener("DOMContentLoaded", startScanner);

// X·ª≠ l√Ω n√∫t "Qu√©t l·∫°i"
document.getElementById('reset').addEventListener('click', () => {
    restartScan();
});

// X·ª≠ l√Ω khi r·ªùi trang/·∫©n trang
window.addEventListener("pagehide", () => {
    if (videoElem.srcObject) {
        videoElem.srcObject.getTracks().forEach(track => track.stop());
        videoElem.srcObject = null;
    }
});
document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        startScanner(); 
    } else {
        if (videoElem.srcObject) { 
            videoElem.srcObject.getTracks().forEach(t => t.stop());
        }
    }
});


/* ================== X·ª¨ L√ù M√É QR & GPS ================== */
function handleQRCode(data) {
    if (data !== VALID_QR) {
        alert("‚ùå M√£ QR kh√¥ng h·ª£p l·ªá!");
        restartScan(); 
        return;
    }

    resultDiv.textContent = "ƒêang l·∫•y GPS...";

    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            console.log("GPS OK:", lat, lng);
            saveAttendance(lat, lng); 
        },
        err => {
            alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message);
            restartScan();
        },
        { enableHighAccuracy: true, timeout: 8000 }
    );
}


/* ===================== L∆ØU CH·∫§M C√îNG (ƒê√£ T·ªëi ∆Øu Logic & Kh·∫Øc ph·ª•c c√∫ ph√°p) ===================== */
function saveAttendance(lat, lng) {

    // 1. Ki·ªÉm tra kho·∫£ng c√°ch
    if (distance(lat, lng, COMPANY.lat, COMPANY.lng) > 100) {
        alert("‚ùå B·∫°n qu√° xa c√¥ng ty (T·ªëi ƒëa 100m)!");
        setTimeout(restartScan, 1000);
        return; 
    }

    const emailKey = encodeEmail(userEmail);
    const now = new Date();
    const day = now.toISOString().slice(0, 10);
    const time = now.toLocaleTimeString('en-US', { hour12: false }); // ƒê·ªãnh d·∫°ng HH:MM:SS
    const hour = now.getHours() + now.getMinutes() / 60;

    const ref = db.ref("chamcong/" + emailKey + "/" + day);
    let msg = "Ho√†n th√†nh ch·∫•m c√¥ng."; 

    ref.once("value").then((snap) => {
        let d = snap.val() || {};

        // üéØ Kh·∫Øc ph·ª•c L·ªói C√∫ ph√°p (SyntaxError: missing ) do ??=) 
        // Thay th·∫ø ??= b·∫±ng c√∫ ph√°p || ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi m·ªçi tr√¨nh duy·ªát
        d.vaoCaSang = d.vaoCaSang || ""; 
        d.raCaSang = d.raCaSang || "";
        d.vaoCaTrua = d.vaoCaTrua || "";
        d.raCaTrua = d.raCaTrua || "";
        d.vaoCaChieu = d.vaoCaChieu || "";
        d.raCaChieu = d.raCaChieu || "";
        d.vaoLamThem = d.vaoLamThem || "";
        d.raLamThem = d.raLamThem || "";
        d.ghiChu = d.ghiChu || "";


        // 2. LOGIC CH·∫§M C√îNG theo Khung Gi·ªù

        // **A. CA S√ÅNG (Tr∆∞·ªõc 7:30):**
        if (hour < 7.5) { 
            if (!d.vaoCaSang) {
                d.vaoCaSang = time; msg = "V√†o ca s√°ng (ƒêi s·ªõm)"; d.noteVaoCaSang = "ƒëi s·ªõm";
            } else if (!d.raCaSang) {
                d.raCaSang = time; msg = "Ra ca s√°ng s·ªõm"; d.noteRaCaSang = "ra s·ªõm";
            } else { msg = "ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng s√°ng."; }
        }
        
        // **B. CA S√ÅNG (7:30 - 11:30):**
        else if (hour >= 7.5 && hour <= 11.5) { 
            if (!d.vaoCaSang) {
                d.vaoCaSang = time; msg = "V√†o ca s√°ng (ƒêi mu·ªôn)"; d.noteVaoCaSang = "ƒëi mu·ªôn";
            } else if (!d.raCaSang) {
                d.raCaSang = time; msg = "Ra ca s√°ng (V·ªÅ s·ªõm)!"; d.noteRaCaSang = "v·ªÅ s·ªõm";
            } else { msg = "ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng s√°ng."; }
        }

        // **C. CA TR∆ØA (11:30 - 13:00):**
        else if (hour > 11.5 && hour <= 13.0) { 
            if (!d.raCaSang && d.vaoCaSang) { d.raCaSang = "11:30:00"; d.noteRaCaSang = "ƒë√∫ng gi·ªù"; }

            if (!d.vaoCaTrua) {
                d.vaoCaTrua = time; msg = "V√†o ca tr∆∞a";
            } else if (!d.raCaTrua) {
                d.raCaTrua = time; msg = "Ra ca tr∆∞a";
                if (timeDiff(d.vaoCaTrua, d.raCaTrua) < 0.5) { d.noteRaCaTrua = "ra s·ªõm"; }
            } else { msg = "ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng tr∆∞a."; }
        }

        // **D. CA CHI·ªÄU (13:00 - 17:30):** else if (hour > 13.0 && hour <= 17.5) { 
            if (!d.raCaTrua && d.vaoCaTrua) { d.raCaTrua = "13:00:00"; }

            if (!d.vaoCaChieu) {
                d.vaoCaChieu = time; msg = "V√†o ca chi·ªÅu";
            } else if (!d.raCaChieu) {
                d.raCaChieu = time; msg = "Ra ca chi·ªÅu";
            } else { msg = "ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng chi·ªÅu."; }
        }
                           }

        // **E. TƒÇNG CA (Sau 17:30):**
        else if (hour > 17.5) { 
            d.ghiChu = "L√†mth√™m"; 

            if (!d.raCaChieu) { d.raCaChieu = "17:30:00"; d.noteRaCaChieu = "ƒë√∫ng gi·ªù"; }

            // L·∫ßn qu√©t ƒë·∫ßu ti√™n sau 17:30 s·∫Ω t·ª± ƒë·ªông g√°n vaoLamThem l√† 17:30:00
            if (!d.vaoLamThem) {
                d.vaoLamThem = "17:30:00"; msg = "V√†o tƒÉng ca (Auto 17:30)";
            } 
            // L·∫ßn qu√©t th·ª© hai (Qu√©t ra)
            else if (!d.raLamThem) {
                d.raLamThem = time; msg = "Ra tƒÉng ca t·ªëi"; d.noteRaLamThem = "tƒÉng ca t·ªëi";
            } else { msg = "ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng tƒÉng ca."; }
        }


        // 3. T√çNH GI·ªú
        let total = 0;
        total += timeDiff(d.vaoCaSang, d.raCaSang);
        total += timeDiff(d.vaoCaTrua, d.raCaTrua);
        total += timeDiff(d.vaoCaChieu, d.raCaChieu);
        d.gioLamTrongNgay = total.toFixed(2);

        // T√≠nh OT (Ch·ªâ t√≠nh gi·ªù l√†m th√™m th·ª±c t·∫ø)
        let ot = timeDiff(d.vaoLamThem, d.raLamThem); 
        d.gioLamThem = ot.toFixed(2);

        d.diaDiemQuet = `${lat},${lng}`;


        // 4. L∆ØU V√Ä KH·ªûI ƒê·ªòNG L·∫†I SCAN
        ref.set(d).then(() => {
            scanning = false;
            alert(
                "‚úî Ch·∫•m c√¥ng th√†nh c√¥ng!\n" +
                "üìÖ Ng√†y: "+day+"\n"+
                "‚è∞ "+time+" - "+msg+"\n"+
                "‚è≥ Gi·ªù l√†m: "+d.gioLamTrongNgay+"h\n"+
                "üåô TƒÉng ca: "+d.gioLamThem+"h"
            );

            setTimeout(restartScan, 1000);
        })
        .catch(error => {
            alert("‚ùå L·ªói l∆∞u d·ªØ li·ªáu Firebase: " + error.message);
            restartScan();
        });
    });
}

/* ===================== BUTTONS ===================== */
document.getElementById("viewBtn").onclick = () =>
    location.href = "xem.html?user=" + userEmail;

document.getElementById("logoutBtn").onclick = () => {
    sessionStorage.clear();
    location.href = "index.html";
};

</script>

</body>
</html>

