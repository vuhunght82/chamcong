<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu√©t m√£ QR ch·∫•m c√¥ng</title>
  <style>
    body { font-family: Arial; text-align:center; background:#eef2f7; }
    #video { width:300px; margin:20px; border:2px solid #007bff; border-radius:10px; }
  </style>
</head>
<body>
  <h2>üì∏ Qu√©t m√£ QR ch·∫•m c√¥ng</h2>
  <video id="video" muted></video>
  <div id="result"></div>
  <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
  <p><a href="xem.html">Xem th·ªùi gian l√†m</a></p>

  <script type="module">
    import { auth, db, ref, set, update } from './firebase.js';
    import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

    const videoElem = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const userEmail = sessionStorage.getItem('userEmail');

    if (!userEmail) window.location.href = 'index.html';

    const scanner = new QrScanner(videoElem, result => handleScan(result), {
      highlightScanRegion: true, highlightCodeOutline: true
    });
    scanner.start();

    async function handleScan(result) {
      const qrValue = result.data || result;
      resultDiv.textContent = '‚úÖ Qu√©t th√†nh c√¥ng: ' + qrValue;

      const now = new Date();
      const date = now.toISOString().split('T')[0];
      const time = now.toLocaleTimeString();
      const dbPath = `chamcong/${userEmail.replace(/\./g, "_")}/${date}`;

      await update(ref(db, dbPath), {
        tendangnhap: userEmail,
        noidungmaquet: qrValue,
        giolamtrongngay: time,
        diadiemquetma: "VƒÉn ph√≤ng",
        updatedAt: now.toISOString()
      });

      alert('‚úÖ Ch·∫•m c√¥ng th√†nh c√¥ng!');
      scanner.stop();
    }

    document.getElementById('logoutBtn').onclick = () => {
      sessionStorage.clear();
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>
