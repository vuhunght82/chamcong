<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ch·∫•m c√¥ng QR</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f2f5; margin:0; }
    h1 { background:#007bff; color:white; padding:15px; }
    #video-container { margin:20px auto; width:300px; border:2px solid #007bff; border-radius:10px; overflow:hidden;}
    video { width:100%; height:auto; }
    button { padding:10px 20px; font-size:16px; margin:10px; }
  </style>
</head>
<body>

<h1>üì∑ Qu√©t m√£ ch·∫•m c√¥ng</h1>
<div id="video-container"><video id="qr-video" muted></video></div>
<div id="result">ƒêang ch·ªù qu√©t QR...</div>
<div id="error" style="color:red;"></div>
<button id="restartBtn" style="display:none;">Qu√©t l·∫°i</button>
<button id="viewBtn">Xem th·ªùi gian l√†m</button>
<button id="logoutBtn">ƒêƒÉng xu·∫•t</button>

<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';
import './firebase.js';

const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const restartBtn = document.getElementById('restartBtn');
const errorDiv = document.getElementById('error');

const email = sessionStorage.getItem('userEmail');
if (!email) window.location.href = 'index.html';

let scanner;

function startScanner() {
  resultDiv.textContent = 'ƒêang ch·ªù qu√©t QR...';
  scanner = new QrScanner(videoElem, qrResult => handleAttendance(qrResult), { highlightScanRegion:true });
  scanner.start().catch(err => errorDiv.textContent = '‚ùå Kh√¥ng m·ªü ƒë∆∞·ª£c camera: ' + err);
}

restartBtn.addEventListener('click', startScanner);
document.getElementById('viewBtn').onclick = () => location.href = 'xem.html';
document.getElementById('logoutBtn').onclick = () => { sessionStorage.clear(); location.href = 'index.html'; };

// H√†m x·ª≠ l√Ω ch·∫•m c√¥ng
function handleAttendance(qrResult) {
  scanner.stop();
  const now = new Date();
  const dateKey = now.toISOString().split('T')[0];
  const timeStr = now.toLocaleTimeString('vi-VN');
  const hour = now.getHours() + now.getMinutes()/60;
  const ref = db.ref('attendance/' + email.replace('.', '_') + '/' + dateKey);

  ref.once('value').then(snapshot => {
    let data = snapshot.val() || {};
    let msg = '';
    const morningStart = 7.5, morningEnd = 11.5, afternoonStart = 13, afternoonEnd = 17;

    if (hour >= morningStart && hour <= morningEnd) {
      if (!data.vaoCaSang) {
        data.vaoCaSang = timeStr;
        if (hour > morningStart) data.diMuon = true, msg = '‚ö† ƒêi mu·ªôn ca s√°ng!';
      } else data.raCaSang = timeStr;
    } else if (hour >= afternoonStart && hour <= afternoonEnd) {
      if (!data.vaoCaChieu) {
        data.vaoCaChieu = timeStr;
        if (hour > afternoonStart) data.diMuon = true, msg = '‚ö† ƒêi mu·ªôn ca chi·ªÅu!';
      } else data.raCaChieu = timeStr;
    } else if (hour > morningEnd && hour < afternoonStart) {
      data.lamThem = true; msg = 'üïê L√†m th√™m bu·ªïi tr∆∞a!';
    }

    data.noiDungMaQuet = qrResult;
    data.diaDiemQuetMa = "C·ªïng c√¥ng ty";
    data.gioLamTrongNgay = tinhGio(data);

    ref.set(data);
    resultDiv.textContent = `‚úÖ Qu√©t th√†nh c√¥ng: ${qrResult}\n${msg}\nT·ªïng gi·ªù: ${data.gioLamTrongNgay}h`;
    alert(msg || '‚úÖ Qu√©t th√†nh c√¥ng!');
    restartBtn.style.display = 'inline-block';
  });
}

function tinhGio(data) {
  let sum = 0;
  if (data.vaoCaSang && data.raCaSang) sum += parseTime(data.raCaSang) - parseTime(data.vaoCaSang);
  if (data.vaoCaChieu && data.raCaChieu) sum += parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu);
  return sum.toFixed(2);
}
function parseTime(t) { const [h,m,s] = t.split(':').map(Number); return h + m/60 + (s||0)/3600; }

startScanner();
</script>
</body>
</html>
