<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

    <style>
        body {
            font-family: Arial;
            text-align: center;
            background: linear-gradient(to right, #00ffff, #00c6ff);
            margin: 0;
            padding: 0 10px;
        }

        h1 {
            color: #ffffff;
            margin: 15px 0;
        }

        #video-container {
            margin: 20px auto;
            width: 100%;
            max-width: 360px;
            border: 2px solid #007bff;
            border-radius: 10px;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: auto;
        }

        #result {
            font-weight: bold;
            color: green;
            margin-top: 20px;
            white-space: pre-line;
        }

        #error {
            color: red;
            margin-top: 10px;
        }

        button {
            margin: 5px;
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 10px;
            border: none;
            background: #008000;
            color: white;
        }
    </style>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>emailjs.init("zw8NnWti6A--Pyys9");</script>

</head>
<body>

    <audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <h1>üì∏ Qu√©t QR Ch·∫•m C√¥ng</h1>

    <div id="video-container">
        <video id="qr-video" muted></video>
    </div>

    <div id="result">ƒêang ch·ªù qu√©t QR...</div>
    <div id="error"></div>

    <button id="restartBtn" style="display:none;">üîÑ Qu√©t l·∫°i</button>
    <button id="viewBtn">üìã Xem ch·∫•m c√¥ng</button>
    <button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- QRScanner UMD ‚Äì ch·∫°y ƒë∆∞·ª£c tr√™n iPhone -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <!-- QR Scanner -->
    <script>

        /* ================== Firebase ================== */
        const firebaseConfig = {
            apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
            authDomain: "sellglass-3ebe9.firebaseapp.com",
            databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sellglass-3ebe9",
            storageBucket: "sellglass-3ebe9.appspot.com",
            messagingSenderId: "513741829035",
            appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        /* ================== Login Check ================== */
        const emailUser = sessionStorage.getItem("userEmail");
        if (!emailUser) { alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); location.href = "index.html"; }

        /* ================== Elements ================== */
        const videoElem = document.getElementById("qr-video");
        const resultDiv = document.getElementById("result");
        const restartBtn = document.getElementById("restartBtn");
        const beep = document.getElementById("beepSound");

       
        let scanner;




        /* ================== QR Scanner ================== */
       
        function startScanner() {
            resultDiv.textContent = "ƒêang ch·ªù qu√©t QR...";
            restartBtn.style.display = "none";

            scanner = new QrScanner(videoElem, qrText => {
                getGPS((lat, lng) => processQR(emailUser, qrText, lat, lng));
            });

            scanner.start().catch(() => alert("Kh√¥ng th·ªÉ m·ªü camera!"));
        }

        /* ================== L·∫•y GPS ================== */
        function getGPS(callback) {
            if (!navigator.geolocation) return callback(null, null);

            navigator.geolocation.getCurrentPosition(
                pos => callback(pos.coords.latitude, pos.coords.longitude),
                err => callback(null, null),
                { enableHighAccuracy: true, timeout: 8000 }
            );
        }

        /* ================== C·∫•u h√¨nh c√¥ng ty ================== */
        const VALID_QR = "CHECKIN_GLASS_COMPANY";
        const COMPANY = { lat: 10.849641858164617, lng: 106.58569113116769 };

        /* ================== X·ª≠ l√Ω qu√©t ================== */
        async function processQR(email, qr, lat, lng) {
            scanner.stop();
            beep.play();

            if (qr !== VALID_QR) {
                alert("‚ùå Sai m√£ QR!");
                restartBtn.style.display = "inline-block";
                return;
            }

            if (lat && lng) {
                const d = getDistance(lat, lng, COMPANY.lat, COMPANY.lng);
                if (d > 100) {
                    alert("‚ùå B·∫°n qu√° xa khu v·ª±c c√¥ng ty!");
                    restartBtn.style.display = "inline-block";
                    return;
                }
            }

            const now = new Date();
            const day = now.toISOString().split("T")[0];
            const time = now.toLocaleTimeString("en-GB");
            const hour = now.getHours() + now.getMinutes() / 60;

            const ref = db.ref("chamcong/" + encode(email) + "/" + day);
            const snap = await ref.once("value");
            const data = snap.val() || {};

            let note = "";

            /* ========= CA S√ÅNG (07:30 ‚Äì 11:30) ========= */
            if (hour >= 7.5 && hour <= 11.5) {
                if (!data.vaoCaSang) {
                    data.vaoCaSang = time;
                    if (hour > 7.5) note += "ƒêi mu·ªôn ca s√°ng. ";
                } else {
                    data.raCaSang = time;
                    if (hour < 11.5) note += "V·ªÅ s·ªõm ca s√°ng. ";
                }
            }

            /* ========= CA TR∆ØA (11:30 ‚Äì 13:00) ========= */
            else if (hour >= 11.5 && hour < 13) {
                if (!data.vaoCaTrua) {
                    data.vaoCaTrua = time;
                    note += "V√†o ca tr∆∞a. ";
                } else {
                    data.raCaTrua = time;
                    note += "Ra ca tr∆∞a. ";
                }
            }

            /* ========= CA CHI·ªÄU (13:00 ‚Äì 17:30) ========= */
            else if (hour >= 13 && hour <= 17.5) {
                if (!data.vaoCaChieu) {
                    data.vaoCaChieu = time;
                    if (hour > 13) note += "ƒêi mu·ªôn ca chi·ªÅu. ";
                } else {
                    data.raCaChieu = time;
                    if (hour < 17.5) note += "V·ªÅ s·ªõm ca chi·ªÅu. ";
                }
            }

            /* ========= OT SAU GI·ªú ( >17:30 ) ========= */
            else if (hour > 17.5) {
                if (!data.vaoLamThem) data.vaoLamThem = "17:30";
                data.raLamThem = time;
                note += "L√†m th√™m gi·ªù. ";
            }

            /* ================== T√çNH GI·ªú ================== */
            data.gioLamTrongNgay = calcHours(data).toFixed(2);
            data.ghiChu = (data.ghiChu || "") + note;

            data.diadiemQuet = lat ? `${lat},${lng}` : "Kh√¥ng c√≥ GPS";

            await ref.set(data);

            resultDiv.textContent =
                `üéâ CH·∫§M C√îNG TH√ÄNH C√îNG!
S√°ng: ${data.vaoCaSang || "-"} ‚Üí ${data.raCaSang || "-"}
Tr∆∞a: ${data.vaoCaTrua || "-"} ‚Üí ${data.raCaTrua || "-"}
Chi·ªÅu: ${data.vaoCaChieu || "-"} ‚Üí ${data.raCaChieu || "-"}
OT: ${data.vaoLamThem || "-"} ‚Üí ${data.raLamThem || "-"}
T·ªïng gi·ªù: ${data.gioLamTrongNgay}
Ghi ch√∫: ${note}`;

            restartBtn.style.display = "inline-block";
        }

        /* ================== H√ÄM PH·ª§ ================== */
        function encode(e) { return e.replace(/\./g, ","); }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000, dLat = deg(lat2 - lat1), dLon = deg(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(deg(lat1)) * Math.cos(deg(lat2)) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        function deg(x) { return x * Math.PI / 180; }

        function parseTime(t) {
            if (!t) return 0;
            t = t.replace(/[^0-9:]/g, "");
            const [h, m] = t.split(":").map(Number);
            return h + (m || 0) / 60;
        }

        function calcHours(d) {
            let h = 0;
            if (d.vaoCaSang && d.raCaSang) h += parseTime(d.raCaSang) - parseTime(d.vaoCaSang);
            if (d.vaoCaTrua && d.raCaTrua) h += parseTime(d.raCaTrua) - parseTime(d.vaoCaTrua);
            if (d.vaoCaChieu && d.raCaChieu) h += parseTime(d.raCaChieu) - parseTime(d.vaoCaChieu);
            if (d.vaoLamThem && d.raLamThem) h += parseTime(d.raLamThem) - parseTime(d.vaoLamThem);
            return h;
        }

        /* ================== BUTTONS ================== */
        restartBtn.onclick = startScanner;
        document.getElementById("logoutBtn").onclick = () => { sessionStorage.clear(); location.href = "index.html"; };
        document.getElementById("viewBtn").onclick = () => location.href = "xem.html";

        startScanner();

    </script>
</body>
</html>

