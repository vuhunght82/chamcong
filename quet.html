<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body { font-family: Arial; text-align:center; background:#00c6ff; margin:0; padding:10px; }
h2 { color:#fff; }
#video-container { width:100%; max-width:350px; margin:auto; border:2px solid #fff; border-radius:10px; overflow:hidden; }
video { width:100%; }
#result { color:#fff; margin-top:10px; white-space:pre-line; }
button { margin-top:12px; padding:12px; width:90%; max-width:300px; border:none; border-radius:10px; color:white; font-size:16px; }
#logoutBtn { background:#ff3333; }
#viewBtn { background:#005ae0; }
</style>

<!-- QR decode -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>ğŸ“¸ QUÃ‰T MÃƒ QR</h2>

<div id="video-container"><video id="video" autoplay playsinline></video></div>
<div id="result">Äang má»Ÿ camera...</div>

<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<script>
/* ================== LOGIN ================== */
const userEmail = sessionStorage.getItem("userEmail");
if(!userEmail){ window.location.href="index.html"; }

/* ================== VIDEO ================== */
const video = document.getElementById("video");
const resultDiv = document.getElementById("result");

let scanning = false;

/* ================== FIREBASE ================== */
firebase.initializeApp({
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});
const db = firebase.database();

/* ================== AUTO START CAMERA ================== */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    video.srcObject = stream;

    video.onloadeddata = () => {
      scanning = true;
      resultDiv.textContent = "Äang quÃ©t...";
      scanLoop();
    };

  }catch(e){
    resultDiv.textContent = "âŒ KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera!";
  }
}

/* ================== AUTO SCAN LOOP ================== */
function scanLoop(){
  if(!scanning) return;

  const w = video.videoWidth;
  const h = video.videoHeight;

  if(w === 0 || h === 0){
    // Camera chÆ°a load â†’ thá»­ láº¡i
    return requestAnimationFrame(scanLoop);
  }

  const cvs = document.createElement("canvas");
  const ctx = cvs.getContext("2d");
  cvs.width = w; cvs.height = h;
  ctx.drawImage(video,0,0,w,h);

  const img = ctx.getImageData(0,0,w,h);
  const code = jsQR(img.data, w, h);

  if(code){
    scanning = false;
    handleScan(code.data);
    return;
  }

  requestAnimationFrame(scanLoop);
}

/* ================== QR CHECK ================== */
const VALID_QR = "CHECKIN_GLASS_COMPANY";
const COMPANY = { lat:10.84964185816, lng:106.58569113116 };

function encodeEmail(e){ return e.replace(/\./g,","); }

function handleScan(text){
  if(text !== VALID_QR){
    resultDiv.textContent = "âŒ MÃ£ QR sai!";
    setTimeout(()=>{ scanning=true; scanLoop(); }, 1500);
    return;
  }

  resultDiv.textContent="Äang láº¥y GPS...";

  navigator.geolocation.getCurrentPosition(
    pos => saveAttendance(pos.coords.latitude,pos.coords.longitude),
    err => {
      alert("KhÃ´ng láº¥y Ä‘Æ°á»£c GPS");
      scanning = true;
      scanLoop();
    },
    { enableHighAccuracy:true, timeout:5000 }
  );
}

/* ================== TÃNH GIá»œ ================== */
function diff(a,b){
  a = a.replace(/[^0-9:]/g,"").split(":").map(Number);
  b = b.replace(/[^0-9:]/g,"").split(":").map(Number);
  return (b[0]+b[1]/60) - (a[0]+a[1]/60);
}
function distance(a,b,c,d){
  const R=6371000;
  let x=(c-a)*Math.PI/180, y=(d-b)*Math.PI/180;
  let s=Math.sin(x/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(y/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

/* ================== LÆ¯U CHáº¤M CÃ”NG ================== */
function saveAttendance(lat,lng){
  const emailKey = encodeEmail(userEmail);
  const now = new Date();
  const day = now.toISOString().slice(0,10);
  const time = now.toLocaleTimeString();
  const hour = now.getHours() + now.getMinutes()/60;

  // check GPS
  if(distance(lat,lng,COMPANY.lat,COMPANY.lng) > 100){
    alert("âŒ Báº¡n Ä‘ang quÃ¡ xa cÃ´ng ty!");
    scanning = true;
    return scanLoop();
  }

  const ref = db.ref("chamcong/"+emailKey+"/"+day);

  ref.once("value").then(snap=>{
    const d = snap.val() || {};

    d.vaoCaSang ??= "";
    d.raCaSang ??= "";
    d.vaoCaTrua ??= "";
    d.raCaTrua ??= "";
    d.vaoCaChieu ??= "";
    d.raCaChieu ??= "";
    d.vaoLamThem ??= "";
    d.raLamThem ??= "";
    d.ghiChu ??= "";

    let msg="";

    if(hour>=7.5 && hour<=11.5){
      !d.vaoCaSang ? (d.vaoCaSang=time,msg="VÃ o ca sÃ¡ng") : (d.raCaSang=time,msg="Ra ca sÃ¡ng");
    }
    else if(hour>=11.5 && hour<13){
      !d.vaoCaTrua ? (d.vaoCaTrua=time,msg="VÃ o ca trÆ°a") : (d.raCaTrua=time,msg="Ra ca trÆ°a");
    }
    else if(hour>=13 && hour<=17.5){
      !d.vaoCaChieu ? (d.vaoCaChieu=time,msg="VÃ o ca chiá»u") : (d.raCaChieu=time,msg="Ra ca chiá»u");
    }
    else if(hour>17.5){
      !d.vaoLamThem ? (d.vaoLamThem=time,msg="VÃ o tÄƒng ca") : (d.raLamThem=time,msg="Ra tÄƒng ca");
    }

    let total = 0;
    if(d.vaoCaSang && d.raCaSang) total += diff(d.vaoCaSang,d.raCaSang);
    if(d.vaoCaTrua && d.raCaTrua) total += diff(d.vaoCaTrua,d.raCaTrua);
    if(d.vaoCaChieu && d.raCaChieu) total += diff(d.vaoCaChieu,d.raCaChieu);
    d.gioLamTrongNgay = total.toFixed(2);

    let ot = 0;
    if(d.vaoLamThem && d.raLamThem) ot = diff(d.vaoLamThem,d.raLamThem);
    d.gioLamThem = ot.toFixed(2);

    d.diaDiemQuet = lat+","+lng;

   ref.set(d).then(() => {

    // ===== Táº O THÃ”NG BÃO HOÃ€N CHá»ˆNH =====
    let alertMessage =  "âœ” CHáº¤M CÃ”NG THÃ€NH CÃ”NG!\n";
    alertMessage += "------------------------------\n";
    alertMessage += "ğŸ§‘ NhÃ¢n viÃªn: " + email + "\n";
    alertMessage += "ğŸ“… NgÃ y: " + day + "\n";
    alertMessage += "â° Giá» quÃ©t: " + time + "\n";
    alertMessage += "------------------------------\n";

    // GHI CHÃš THEO Tá»ªNG CA
    if (msg) alertMessage += "ğŸ“Œ " + msg + "\n";

    if (d.noteVaoCaSang) alertMessage += "ğŸŒ… Ca sÃ¡ng: " + d.noteVaoCaSang + "\n";
    if (d.noteRaCaSang) alertMessage += "ğŸŒ… Ra sÃ¡ng: " + d.noteRaCaSang + "\n";

    if (d.noteVaoCaTrua) alertMessage += "ğŸ± VÃ o ca trÆ°a: " + d.noteVaoCaTrua + "\n";
    if (d.noteRaCaTrua) alertMessage += "ğŸ± Ra ca trÆ°a: " + d.noteRaCaTrua + "\n";

    if (d.noteVaoCaChieu) alertMessage += "ğŸŒ‡ VÃ o ca chiá»u: " + d.noteVaoCaChieu + "\n";
    if (d.noteRaCaChieu) alertMessage += "ğŸŒ‡ Ra ca chiá»u: " + d.noteRaCaChieu + "\n";

    if (d.noteVaoLamThem) alertMessage += "ğŸŒ™ VÃ o lÃ m thÃªm: " + d.noteVaoLamThem + "\n";
    if (d.noteRaLamThem) alertMessage += "ğŸŒ™ Ra lÃ m thÃªm: " + d.noteRaLamThem + "\n";

    alertMessage += "------------------------------\n";
    alertMessage += "â³ Tá»•ng giá»: " + d.gioLamTrongNgay + "h\n";
    alertMessage += "â³ Giá» tÄƒng ca: " + d.gioLamThem + "h\n";

    // HIá»†N ALERT
    alert(alertMessage);

    // Hiá»‡n ra mÃ n hÃ¬nh
    resultDiv.textContent = "âœ” " + msg;

    // 1.5s sau quÃ©t láº¡i
    setTimeout(() => {
        scanning = true;
        scanLoop();
    }, 1500);
});


  });
}

/* ================== BUTTONS ================== */
viewBtn.onclick = ()=> window.location.href="xem.html?user="+userEmail;
logoutBtn.onclick = ()=>{ sessionStorage.clear(); window.location.href="index.html"; };

/* ================== AUTO START ================== */
window.onload = startCamera;
</script>

</body>
</html>


