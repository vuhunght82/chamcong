function handleAttendance(email, qrContent, lat, lng){
  scanner.stop();

  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const currentTime = now.toLocaleTimeString();
  const currentHour = now.getHours() + now.getMinutes()/60;
  const emailKey = encodeEmail(email);
  const ref = firebase.database().ref('chamcong/' + emailKey + '/' + today);

  ref.once('value')
    .then(snapshot => {
      const data = snapshot.val() || {};
      let msg = '';
      let isOvertime = false;

      // --- Ca sÃ¡ng ---
      if(currentHour >= 7.5 && currentHour <= 11.5){
        if(!data.vaoCaSang){
          data.vaoCaSang = currentTime;
          if(currentHour > 7.5) msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
        } else {
          data.raCaSang = currentTime;
          if(currentHour < 11.5) msg += 'âš  Vá» sá»›m ca sÃ¡ng! ';
        }
      }
      // --- Ca chiá»u ---
      else if(currentHour >= 13 && currentHour <= 17.5){
        if(!data.vaoCaChieu){
          data.vaoCaChieu = currentTime;
          if(currentHour > 13) msg += 'âš  Äi muá»™n ca chiá»u! ';
        } else {
          data.raCaChieu = currentTime;
          if(currentHour < 17.5) msg += 'âš  Vá» sá»›m ca chiá»u! ';
        }
      }
      // --- LÃ m thÃªm ---
      else if((currentHour > 11.5 && currentHour < 13) || currentHour > 17.5){
        msg += 'â„¹ Giá» lÃ m thÃªm!';
        isOvertime = true;
      }

      // TÃ­nh tá»•ng giá» lÃ m
      let totalHours = 0;
      if(data.vaoCaSang && data.raCaSang) totalHours += parseTime(data.raCaSang)-parseTime(data.vaoCaSang);
      if(data.vaoCaChieu && data.raCaChieu) totalHours += parseTime(data.raCaChieu)-parseTime(data.vaoCaChieu);
      data.gioLamTrongNgay = totalHours.toFixed(2);

      data.noiDungMaQuet = qrContent;
      data.diadiemQuet = (lat && lng) ? lat + ',' + lng : 'ChÆ°a láº¥y GPS';

      // Ghi chÃº giá» lÃ m thÃªm
      if(isOvertime){
        const note = prompt("ğŸ“ Báº¡n cÃ³ giá» lÃ m thÃªm, vui lÃ²ng nháº­p ghi chÃº:");
        if(note) data.ghiChu = note;
      }

      // LÆ°u vÃ o Firebase
      ref.set(data)
        .then(() => {
          alert('âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!\n' + msg + (isOvertime ? '\nGhi chÃº: ' + (data.ghiChu||'') : ''));
          resultDiv.textContent = `NhÃ¢n viÃªn: ${email}
SÃ¡ng: ${data.vaoCaSang||'-'} - ${data.raCaSang||'-'}
Chiá»u: ${data.vaoCaChieu||'-'} - ${data.raCaChieu||'-'}
Tá»•ng giá»: ${data.gioLamTrongNgay}h
${msg}`;
          restartBtn.style.display = 'inline-block';
        })
        .catch(err => {
          console.error('âŒ Lá»—i lÆ°u Firebase:', err);
          errorDiv.textContent = 'âŒ Lá»—i lÆ°u Firebase: ' + err;
        });
    })
    .catch(err => {
      console.error('âŒ Lá»—i Ä‘á»c Firebase:', err);
      errorDiv.textContent = 'âŒ Lá»—i Ä‘á»c Firebase: ' + err;
    });
}

// MÃ£ encode email
function encodeEmail(email){
  return email.replace(/\./g, ',');
}
