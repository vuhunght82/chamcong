<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cháº¥m cÃ´ng QR</title>
<style>
  body { font-family: Arial; text-align:center; background:#f0f2f5; }
  h1 { color:#007bff; }
  #video-container { margin:20px auto; width:300px; border:2px solid #007bff; border-radius:10px; overflow:hidden; }
  video { width:100%; height:auto; }
  #result { font-weight:bold; color:green; margin-top:20px; white-space: pre-line; }
  #error { color:red; margin-top:10px; }
  button { margin-top:10px; padding:10px 20px; font-size:16px; }
</style>
</head>
<body>

<h1>ğŸ“¸ QuÃ©t QR cháº¥m cÃ´ng</h1>
<div id="video-container">
  <video id="qr-video" muted></video>
</div>
<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>
<button id="restartBtn" style="display:none;">QuÃ©t láº¡i</button>
<button id="logoutBtn">ÄÄƒng xuáº¥t</button>
<div>
  <button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button></div>
<script>
document.getElementById('viewBtn').addEventListener('click', () => {
  window.location.href = 'xem.html';
});
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QR Scanner -->
<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Láº¥y userEmail tá»« Ä‘Äƒng nháº­p
const userEmail = sessionStorage.getItem('userEmail');
if(!userEmail) {
  alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
  window.location.href = 'index.html';
}

// Khá»Ÿi táº¡o video
const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const restartBtn = document.getElementById('restartBtn');
const logoutBtn = document.getElementById('logoutBtn');

let scanner;

function startScanner() {
  resultDiv.textContent = 'Äang chá» quÃ©t QR...';
  errorDiv.textContent = '';
  restartBtn.style.display = 'none';

  scanner = new QrScanner(videoElem, qrResult => {
    handleAttendance(qrResult);
  }, { highlightScanRegion: true, highlightCodeOutline: true });

  scanner.start().catch(err => {
    errorDiv.textContent = 'âŒ KhÃ´ng thá»ƒ má»Ÿ camera: ' + err;
  });
}

restartBtn.addEventListener('click', startScanner);
logoutBtn.addEventListener('click', () => {
  sessionStorage.removeItem('userEmail');
  window.location.href = 'index.html';
});

// Xá»­ lÃ½ cháº¥m cÃ´ng
function handleAttendance(employeeId, qrContent, lat, lng) {
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const currentTime = now.toLocaleTimeString();
  const currentHour = now.getHours() + now.getMinutes()/60;

  const docRef = db.ref('chamcong/' + employeeId + '/' + today);

  docRef.once('value').then(snapshot => {
    const data = snapshot.val() || {};
    let msg = '';
    let isOvertime = false;

    // --- Ca sÃ¡ng ---
    if(currentHour >= 7.5 && currentHour <= 11.5){
      if(!data.vaoCaSang){
        data.vaoCaSang = currentTime;
        if(currentHour > 7.5) msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
      } else {
        data.raCaSang = currentTime;
        if(currentHour < 11.5) msg += 'âš  Vá» sá»›m ca sÃ¡ng! ';
      }
    }
    // --- Ca chiá»u ---
    else if(currentHour >= 13 && currentHour <= 17.5){
      if(!data.vaoCaChieu){
        data.vaoCaChieu = currentTime;
        if(currentHour > 13) msg += 'âš  Äi muá»™n ca chiá»u! ';
      } else {
        data.raCaChieu = currentTime;
        if(currentHour < 17.5) msg += 'âš  Vá» sá»›m ca chiá»u! ';
      }
    }
    // --- LÃ m thÃªm ngoÃ i giá» ---
    else if((currentHour > 11.5 && currentHour < 13) || currentHour > 17.5){
      msg += 'â„¹ Giá» lÃ m thÃªm phÃ¡t hiá»‡n!';
      isOvertime = true;
    }

    // TÃ­nh giá» lÃ m trong ngÃ y
    let totalHours = 0;
    if(data.vaoCaSang && data.raCaSang) totalHours += parseTime(data.raCaSang) - parseTime(data.vaoCaSang);
    if(data.vaoCaChieu && data.raCaChieu) totalHours += parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu);
    data.gioLamTrongNgay = totalHours.toFixed(2);

    data.noiDungMaQuet = qrContent;
    data.diadiemQuet = lat + ',' + lng;

    // --- Náº¿u cÃ³ lÃ m thÃªm thÃ¬ yÃªu cáº§u ghi chÃº ---
    if(isOvertime){
      const note = prompt("ğŸ“ Báº¡n cÃ³ giá» lÃ m thÃªm, vui lÃ²ng nháº­p ghi chÃº:");
      if(note) data.ghiChu = note;
    }

    // LÆ°u vÃ o Firebase
    docRef.set(data).then(() => {
      alert('âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!\n' + msg + (isOvertime ? `\nGhi chÃº: ${data.ghiChu || ''}` : ''));
    });
  });
}

function parseTime(timeStr) {
  const parts = timeStr.split(':');
  return Number(parts[0]) + Number(parts[1])/60 + (parts[2]?Number(parts[2])/3600:0);
}

window.addEventListener('load', startScanner);
</script>

</body>
</html>


