<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

<style>
body {
  font-family: Arial;
  background: linear-gradient(to right,#00ffff,#00c6ff);
  text-align:center;
  margin:0;
  padding:10px;
}
h2 { color:#fff; }
#video-container {
  width:100%; max-width:360px;
  margin:20px auto;
  border:2px solid #0099ff;
  border-radius:12px;
  overflow:hidden;
}
video { width:100%; }
#result { white-space:pre-line; font-weight:bold; margin-top:10px; }
button {
  margin-top:12px;
  padding:12px 20px;
  border:none;
  background:green;
  color:white;
  font-size:16px;
  border-radius:8px;
}
</style>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>üì∏ Qu√©t QR Ch·∫•m C√¥ng</h2>

<div id="video-container">
  <video id="video" autoplay playsinline></video>
</div>

<div id="result">ƒêang ch·ªù qu√©t...</div>
<button id="retry">üîÑ Qu√©t l·∫°i</button>

<script>
/* ===================== CAMERA ===================== */
const video = document.getElementById("video");
const resultDiv = document.getElementById("result");
const retryBtn = document.getElementById("retry");

let scanning = false;

async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });
    video.srcObject = stream;
    scanning = true;
    scanLoop();
  } catch (e){
    resultDiv.textContent = "‚ùå Kh√¥ng m·ªü ƒë∆∞·ª£c camera";
  }
}

function scanLoop(){
  if(!scanning) return;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(frame.data, frame.width, frame.height);

  if(code){
    scanning = false;
    decodeQR(code.data);
    return;
  }
  requestAnimationFrame(scanLoop);
}

retryBtn.onclick = ()=>{ scanning = true; resultDiv.textContent="ƒêang ch·ªù qu√©t..."; scanLoop(); };


/* ===================== FIREBASE ===================== */
firebase.initializeApp({
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});
const db = firebase.database();

function encodeEmail(e){ return e.replace(/\./g,","); }


/* ===================== X·ª¨ L√ù QR ===================== */

const VALID_QR = "CHECKIN_GLASS_COMPANY";

// GPS c√¥ng ty
const COMPANY = { lat:10.84964185816, lng:106.58569113116 };

function decodeQR(text){
  if(text !== VALID_QR){
    alert("‚ùå QR kh√¥ng h·ª£p l·ªá");
    return;
  }

  // l·∫•y GPS user
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      saveAttendance(lat,lng);
    },
    err=>{
      alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS");
    },
    { enableHighAccuracy:true, timeout:5000 }
  );
}


/* ===================== L∆ØU CH·∫§M C√îNG ===================== */

function saveAttendance(lat,lng){
  const email = sessionStorage.getItem("userEmail");
  if(!email){
    alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
    return;
  }

  const key = encodeEmail(email);
  const now = new Date();
  const day = now.toISOString().slice(0,10);
  const time = now.toLocaleTimeString();
  const hour = now.getHours() + now.getMinutes()/60;

  // ki·ªÉm tra kho·∫£ng c√°ch
  const d = getDistance(lat,lng, COMPANY.lat, COMPANY.lng);
  if(d > 100){
    alert("‚ùå B·∫°n ƒëang qu√° xa c√¥ng ty (" + d.toFixed(1) + "m)");
    return;
  }

  const ref = db.ref("chamcong/"+key+"/"+day);

  ref.once("value").then(snap=>{
    const data = snap.val() || {};

    // t·∫°o note r·ªóng
    data.noteVaoCaSang = data.noteVaoCaSang || "";
    data.noteRaCaSang = data.noteRaCaSang || "";
    data.noteVaoCaTrua = data.noteVaoCaTrua || "";
    data.noteRaCaTrua = data.noteRaCaTrua || "";
    data.noteVaoCaChieu = data.noteVaoCaChieu || "";
    data.noteRaCaChieu = data.noteRaCaChieu || "";
    data.noteVaoOT = data.noteVaoOT || "";
    data.noteRaOT = data.noteRaOT || "";
    data.ghiChu = data.ghiChu || "";

    let msg = "";

    /* ==== CA S√ÅNG (7h30 ‚Üí 11h30) ==== */
    if(hour >= 7.5 && hour <= 11.5){
      if(!data.vaoCaSang){
        data.vaoCaSang = time;
        if(hour > 7.5) data.noteVaoCaSang += "ƒêi mu·ªôn. ";
        msg="V√†o ca s√°ng";
      } else {
        data.raCaSang = time;
        if(hour < 11.5) data.noteRaCaSang += "Ra s·ªõm. ";
        msg="Ra ca s√°ng";
      }
    }

    /* ==== CA TR∆ØA (11h30 ‚Üí 13h) ==== */
    else if(hour >= 11.5 && hour < 13){
      if(!data.vaoCaTrua){
        data.vaoCaTrua = time;
        data.noteVaoCaTrua += "B·∫Øt ƒë·∫ßu ca tr∆∞a. ";
        msg="V√†o ca tr∆∞a";
      }
      else if(!data.raCaTrua){
        data.raCaTrua = time;
        data.noteRaCaTrua += "K·∫øt th√∫c ca tr∆∞a. ";
        msg="Ra ca tr∆∞a";
      }
    }

    /* ==== CA CHI·ªÄU (13h ‚Üí 17h30) ==== */
    else if(hour >= 13 && hour <= 17.5){
      if(!data.vaoCaChieu){
        data.vaoCaChieu = time;
        if(hour>13) data.noteVaoCaChieu += "ƒêi mu·ªôn ca chi·ªÅu. ";
        msg="V√†o ca chi·ªÅu";
      }
      else {
        data.raCaChieu = time;
        if(hour < 17.5) data.noteRaCaChieu += "Ra s·ªõm. ";
        msg="Ra ca chi·ªÅu";
      }
    }

    /* ==== L√ÄM TH√äM (sau 17h30) ==== */
    else if(hour > 17.5){
      if(!data.vaoLamThem){
        data.vaoLamThem = time;
        data.noteVaoOT += "B·∫Øt ƒë·∫ßu OT. ";
        msg="V√†o tƒÉng ca";
      }
      else {
        data.raLamThem = time;
        data.noteRaOT += "K·∫øt th√∫c OT. ";
        msg="Ra tƒÉng ca";
      }
    }

    /* ==== T√≠nh t·ªïng gi·ªù ==== */
    let total = 0;
    if(data.vaoCaSang && data.raCaSang)
      total += parseTime(data.raCaSang) - parseTime(data.vaoCaSang);
    if(data.vaoCaTrua && data.raCaTrua)
      total += parseTime(data.raCaTrua) - parseTime(data.vaoCaTrua);
    if(data.vaoCaChieu && data.raCaChieu)
      total += parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu);

    data.gioLamTrongNgay = total.toFixed(2);

    let ot=0;
    if(data.vaoLamThem && data.raLamThem)
      ot = parseTime(data.raLamThem)-parseTime(data.vaoLamThem);

    data.gioLamThem = ot.toFixed(2);

    // l∆∞u GPS
    data.diaDiemQuet = lat+", "+lng;

    ref.set(data).then(()=>{
      alert("‚úî "+msg);
      resultDiv.textContent = JSON.stringify(data, null, 2);
      scanning=false;
    });

  });
}


/* ===================== H√ÄM PH·ª§ ===================== */
function parseTime(t){
  if(!t) return 0;
  t = t.replace(/[^0-9:]/g,"");
  const [h,m] = t.split(":").map(Number);
  return h + m/60;
}

// T√≠nh kho·∫£ng c√°ch theo m√©t
function getDistance(lat1,lon1,lat2,lon2){
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = 
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

startCamera();
</script>

</body>
</html>
