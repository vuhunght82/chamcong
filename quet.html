<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body {
  font-family: Arial;
  text-align: center;
  background: linear-gradient(to right, #00ffff, #00c6ff);
  margin: 0;
  padding: 0 10px;
}
h1 { color:#ffffff; margin: 15px 0; }
#video-container { margin:20px auto; width:100%; max-width:360px; border:2px solid #007bff; border-radius:10px; overflow:hidden; }
video { width:100%; height:auto; }
#result { font-weight:bold; color:green; margin-top:20px; white-space: pre-line; }
#error { color:red; margin-top:10px; }
button {
  margin: 5px;
  padding: 15px 20px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: #008000;
  color: white;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script> emailjs.init("zw8NnWti6A--Pyys9"); </script>

</head>
<body>

<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<h1>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h1>

<div id="video-container">
  <video id="qr-video" muted></video>
</div>

<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>

<button id="restartBtn" style="display:none;">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QR SCANNER -->
<script type="module">
import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

/* ================== Firebase ================== */
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================== Elements ================== */
const resultDiv = document.getElementById("result");
const errorDiv = document.getElementById("error");
const restartBtn = document.getElementById("restartBtn");
const videoElem = document.getElementById("qr-video");
const beep = document.getElementById("beepSound");

/* ================== Login Check ================== */
const emailUser = sessionStorage.getItem("userEmail");
if (!emailUser) { alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href = "index.html"; }

/* ================== Scanner ================== */
let scanner = null;

function startScanner() {
  resultDiv.textContent = "Äang chá» quÃ©t QR...";
  errorDiv.textContent = "";
  restartBtn.style.display = "none";

  scanner = new QrScanner(videoElem, (qrText) => {
    console.log("QR Ä‘á»c Ä‘Æ°á»£c:", qrText);
    getGPS((lat, lng) => handleScan(emailUser, qrText, lat, lng));
  });

  scanner.start().catch(err => {
    console.error(err);
    errorDiv.textContent = "KhÃ´ng thá»ƒ má»Ÿ camera!";
  });
}

/* ================== Láº¥y GPS ================== */
function getGPS(callback) {
  if (!navigator.geolocation) return callback(null, null);

  navigator.geolocation.getCurrentPosition(
    pos => callback(pos.coords.latitude, pos.coords.longitude),
    err => callback(null, null),
    { enableHighAccuracy: true, timeout: 8000 }
  );
}

/* ================== CHECKIN ================== */
const VALID_CODE = "CHECKIN_GLASS_COMPANY";
const COMPANY = { lat: 10.849641858164617, lng: 106.58569113116769 };

async function handleScan(email, qr, lat, lng) {
  scanner.stop();
  beep.play();

  if (qr !== VALID_CODE) {
    alert("âŒ Sai mÃ£ QR");
    restartBtn.style.display = "inline-block";
    return;
  }

  if (lat && lng) {
    const d = distance(lat, lng, COMPANY.lat, COMPANY.lng);
    if (d > 100) {
      alert("âŒ Báº¡n Ä‘ang cÃ¡ch cÃ´ng ty quÃ¡ xa!");
      restartBtn.style.display = "inline-block";
      return;
    }
  }

  const now = new Date();
  const day = now.toISOString().split("T")[0];
  const time = now.toLocaleTimeString("en-GB");
  const hour = now.getHours() + now.getMinutes() / 60;

  const ref = db.ref("chamcong/" + encode(email) + "/" + day);
  const snap = await ref.once("value");
  const data = snap.val() || {};

  /* ===== BIáº¾N GHI CHÃš ===== */
  let note = "";

  /* ===== CA SÃNG ===== */
  if (hour >= 7.5 && hour <= 11.5) {
    if (!data.vaoCaSang) {
      data.vaoCaSang = time;
      if (hour > 7.5) note += "Äi muá»™n ca sÃ¡ng. ";
    } else {
      data.raCaSang = time;
      if (hour < 11.5) note += "Vá» sá»›m ca sÃ¡ng. ";
    }
  }

  /* ===== CA TRÆ¯A ===== */
  else if (hour >= 11.5 && hour < 13) {
    if (!data.vaoCaTrua) {
      data.vaoCaTrua = time;
      note += "VÃ o ca trÆ°a. ";
    } else if (!data.raCaTrua) {
      data.raCaTrua = time;
      note += "Ra ca trÆ°a. ";
    }
  }

  /* ===== CA CHIá»€U ===== */
  else if (hour >= 13 && hour <= 17.5) {
    if (!data.vaoCaChieu) {
      data.vaoCaChieu = time;
      if (hour > 13) note += "Äi muá»™n ca chiá»u. ";
    } else {
      data.raCaChieu = time;
      if (hour < 17.5) note += "Vá» sá»›m ca chiá»u. ";
    }
  }

  /* ===== LÃ€M THÃŠM ===== */
  else if (hour > 17.5) {
    if (!data.vaoLamThem) data.vaoLamThem = "17:30";
    data.raLamThem = time;

    note += "LÃ m thÃªm. ";
  }

  /* ===== TÃNH GIá»œ ===== */
  data.gioLamTrongNgay = calcWork(data).toFixed(2);
  data.ghiChu = (data.ghiChu || "") + note;

  if (!lat) data.ghiChu += "KhÃ´ng cÃ³ GPS. ";
  data.diadiemQuet = lat ? `${lat},${lng}` : "No GPS";

  await ref.set(data);

  resultDiv.textContent = 
`âœ” Cháº¥m cÃ´ng thÃ nh cÃ´ng!
VÃ o sÃ¡ng: ${data.vaoCaSang || "-"}
Ra sÃ¡ng:  ${data.raCaSang || "-"}
VÃ o trÆ°a: ${data.vaoCaTrua || "-"}
Ra trÆ°a:  ${data.raCaTrua || "-"}
VÃ o chiá»u: ${data.vaoCaChieu || "-"}
Ra chiá»u:  ${data.raCaChieu || "-"}
OT: ${data.vaoLamThem || "-"} â†’ ${data.raLamThem || "-"}
Tá»•ng giá»: ${data.gioLamTrongNgay} giá»
Ghi chÃº: ${note}`;

  restartBtn.style.display = "inline-block";
}

/* ================== HÃ€M PHá»¤ ================== */
function encode(email) { return email.replace(/\./g, ","); }

function distance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = deg(lat2 - lat1);
  const dLon = deg(lon2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(deg(lat1)) * Math.cos(deg(lat2)) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function deg(d) { return d * Math.PI / 180; }

function parseTime(t) {
  if (!t) return 0;
  t = t.replace(/[^0-9:]/g, "");
  const [h, m] = t.split(":").map(Number);
  return h + (m || 0) / 60;
}

function calcWork(d) {
  let h = 0;
  if (d.vaoCaSang && d.raCaSang) h += parseTime(d.raCaSang) - parseTime(d.vaoCaSang);
  if (d.vaoCaTrua && d.raCaTrua) h += parseTime(d.raCaTrua) - parseTime(d.vaoCaTrua);
  if (d.vaoCaChieu && d.raCaChieu) h += parseTime(d.raCaChieu) - parseTime(d.vaoCaChieu);
  if (d.vaoLamThem && d.raLamThem) h += parseTime(d.raLamThem) - parseTime(d.vaoLamThem);
  return h;
}

restartBtn.addEventListener("click", startScanner);
document.getElementById("logoutBtn").onclick = () => { sessionStorage.clear(); location.href="index.html"; };
document.getElementById("viewBtn").onclick = () => location.href="xem.html";

startScanner();

</script>
</body>
</html>
