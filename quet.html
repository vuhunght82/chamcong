<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</title>

<style>
body {
  font-family: Arial;
  text-align: center;
  background: linear-gradient(to right, #00ffff, #00c6ff);
  margin: 0;
  padding: 0 10px;
}
h1 {
  color:#ffffff;
  margin: 15px 0;
}
#video-container {
  margin:20px auto;
  width:100%;
  max-width:360px;
  border:2px solid #007bff;
  border-radius:10px;
  overflow:hidden;
}
video {
  width:100%;
  height:auto;
}
#result {
  font-weight:bold;
  color:green;
  margin-top:20px;
  white-space: pre-line;
}
#error { color:red; margin-top:10px; }

button {
  margin: 5px;
  padding: 20px 30px;
  font-size: 16px;
  border-radius: 10px;
  background-color:green;
  color:#fff;
  border-color:#fff;
}
@media (max-width:480px){
  button { width:95%; font-size:1em; }
}
</style>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init("zw8NnWti6A--Pyys9");
  })();
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- QRScanner UMD â€“ cháº¡y Ä‘Æ°á»£c trÃªn iPhone -->
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

</head>
<body>

<h1>ğŸ“¸ QuÃ©t QR Cháº¥m CÃ´ng</h1>

<div id="video-container">
  <video id="qr-video" muted playsinline></video>
</div>

<div id="result">Äang chá» quÃ©t QR...</div>
<div id="error"></div>

<button id="restartBtn" style="display:none;">ğŸ”„ QuÃ©t láº¡i</button>
<button id="viewBtn">ğŸ“‹ Xem cháº¥m cÃ´ng</button>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<script>
/*===========================
  Firebase
===========================*/
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*===========================
  Check login
===========================*/
const userEmail = sessionStorage.getItem("userEmail");
if (!userEmail) {
  alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c");
  location.href = "index.html";
}

/*===========================
  QR Scanner (UMD â€“ cháº¡y Ä‘Æ°á»£c trÃªn iPhone)
===========================*/
const videoElem = document.getElementById("qr-video");
let scanner;

function startScanner() {
  scanner = new QrScanner(
    videoElem,
    result => {
      handleScan(result.data);
    },
    {
      highlightScanRegion: true,
      highlightCodeOutline: true,
      preferredCamera: "environment"
    }
  );

  scanner.start().catch(err => {
    document.getElementById("error").textContent =
      "KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera: " + err;
  });
}

function handleScan(text) {
  scanner.stop();
  document.getElementById("result").textContent = "ÄÃ£ quÃ©t: " + text;

  if (text !== "CHECKIN_GLASS_COMPANY") {
    alert("âŒ MÃ£ QR khÃ´ng há»£p lá»‡");
    restartBtn.style.display = "block";
    return;
  }

  handleAttendance();
}

/*===========================
  Xá»­ lÃ½ cháº¥m cÃ´ng
===========================*/
function handleAttendance() {
    
  const now = new Date();
  const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
  const currentTime = now.toLocaleTimeString('en-GB'); // HH:MM:SS 24h preferable
  const currentHour = now.getHours() + now.getMinutes()/60;
  const emailKey = encodeEmail(email);
  const ref = db.ref('chamcong/' + emailKey + '/' + today);

  // khá»Ÿi táº¡o cÃ¡c chuá»—i ghi chÃº
  let ghichucalam = "";
  let noteVaoCaSang = "";
  let noteRaCaSang = "";
  let noteVaoCaTrua = "";
  let noteRaCaTrua = "";
  let noteVaoCaChieu = "";
  let noteRaCaChieu = "";
  let noteVaoLamThem = "";
  let noteRaLamThem = "";

  ref.once('value').then(snapshot=>{
    const data = snapshot.val() || {};

    let msg = '';
    let isOvertime = false;

    // --- Ca sÃ¡ng ---
    if (currentHour >= 7.5 && currentHour <= 11.5) {
      if (!data.vaoCaSang) {
        data.vaoCaSang = currentTime;
        if (currentHour > 7.5) {
          msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
          noteVaoCaSang += 'Äi muá»™n ca sÃ¡ng! ';
          ghichucalam += 'Äi muá»™n ca sÃ¡ng! ';
        }
      } else {
        data.raCaSang = currentTime;
        if (currentHour < 11.5) {
          msg += 'âš  Vá» sá»›m ca sÃ¡ng! ';
          noteRaCaSang += 'Vá» sá»›m ca sÃ¡ng! ';
          ghichucalam += 'Vá» sá»›m ca sÃ¡ng! ';
        }
      }
    }
    // --- Äi sá»›m ca sÃ¡ng (trÆ°á»ng há»£p quÃ©t trÆ°á»›c 7:30) ---
    else if (currentHour < 7.5) {
      data.vaoCaSang = currentTime;
      msg += 'âœ… Äi sá»›m ca sÃ¡ng! ';
      ghichucalam += 'Äi sá»›m ca sÃ¡ng! ';
    }
    // --- Nghá»‰ trÆ°a / LÃ m thÃªm giá»¯a ca (11:30 - 13:00) ---
    else if (currentHour >= 11.5 && currentHour < 13) {
      // náº¿u chÆ°a cÃ³ vÃ o trÆ°a thÃ¬ ghi vÃ o trÆ°a
      if (!data.vaoCaTrua) {
        data.vaoCaTrua = currentTime;
        noteVaoCaTrua += 'VÃ o trÆ°a';
        ghichucalam += 'VÃ o trÆ°a ';
        msg += 'â± VÃ o trÆ°a / táº¡m nghá»‰. ';
      } else if (data.vaoCaTrua && !data.raCaTrua) {
        data.raCaTrua = currentTime;
        noteRaCaTrua += 'Ra trÆ°a';
        ghichucalam += 'Ra trÆ°a ';
        msg += 'â± Ra trÆ°a. ';
      } else {
        // náº¿u Ä‘Ã£ cÃ³ cáº£ vao/ra trÆ°a, thÃ¬ tÃ­nh lÃ m thÃªm giá»¯a ca
        isOvertime = true;
        msg += 'â„¹ LÃ m thÃªm trong giá» trÆ°a. ';
        if (!data.vaoLamThem) data.vaoLamThem = currentTime;
        else if (data.vaoLamThem && !data.raLamThem) data.raLamThem = currentTime;
      }
    }
    // --- Ca chiá»u ---
    else if (currentHour >= 13 && currentHour <= 17.5) {
      if (!data.vaoCaChieu) {
        data.vaoCaChieu = currentTime;
        if (currentHour > 13) {
          msg += 'âš  Äi muá»™n ca chiá»u! ';
          noteVaoCaChieu += 'Äi muá»™n ca chiá»u! ';
          ghichucalam += 'Äi muá»™n ca chiá»u! ';
        }
      } else {
        data.raCaChieu = currentTime;
        if (currentHour < 17.5) {
          msg += 'âš  Vá» sá»›m ca chiá»u! ';
          noteRaCaChieu += 'Vá» sá»›m ca chiá»u! ';
          ghichucalam += 'Vá» sá»›m ca chiá»u! ';
        }
      }
    }
    // --- LÃ m thÃªm sau giá» ---
    else if (currentHour > 17.5) {
      isOvertime = true;
      msg += 'â„¹ Giá» lÃ m thÃªm sau giá» hÃ nh chÃ­nh. ';
      if (!data.raCaChieu) {
        data.raCaChieu = '17:30';
        msg += 'âš  Tá»± Ä‘á»™ng chá»‘t ca chiá»u 17:30. ';
        ghichucalam += 'Tá»± Ä‘á»™ng chá»‘t ca chiá»u 17:30. ';
      }
      if (!data.vaoLamThem) data.vaoLamThem = '17:30';
      data.raLamThem = currentTime + ' (lÃ m thÃªm)';
      noteVaoLamThem += 'Báº¯t Ä‘áº§u OT';
      noteRaLamThem += 'Káº¿t thÃºc OT';
    }

    // --- TÃ­nh tá»•ng giá» lÃ m (chá»‰ tÃ­nh tá»« giá» hh:mm, bá» pháº§n chá»¯ náº¿u cÃ³) ---
    let totalHours = 0;
    try {
      if (data.vaoCaSang && data.raCaSang) totalHours += (parseTime(data.raCaSang) - parseTime(data.vaoCaSang));
      if (data.vaoCaTrua && data.raCaTrua) totalHours += (parseTime(data.raCaTrua) - parseTime(data.vaoCaTrua));
      if (data.vaoCaChieu && data.raCaChieu) totalHours += (parseTime(data.raCaChieu) - parseTime(data.vaoCaChieu));
    } catch(e){
      console.warn('parseTime error', e);
    }
    data.gioLamTrongNgay = Number(totalHours.toFixed(2));

    // --- ná»™i dung quÃ©t & vá»‹ trÃ­ ---
    data.noiDungMaQuet = qrContent;
    data.diadiemQuet = (lat && lng) ? `${lat},${lng}` : 'ChÆ°a láº¥y GPS';

    // combine ghi chÃº (khÃ´ng ghi Ä‘Ã¨, ghÃ©p thÃªm)
    data.ghiChu = (data.ghiChu || "") + (ghichucalam ? ghichucalam + " " : "") 
      + (noteVaoCaSang ? noteVaoCaSang + " " : "")
      + (noteRaCaSang ? noteRaCaSang + " " : "")
      + (noteVaoCaTrua ? noteVaoCaTrua + " " : "")
      + (noteRaCaTrua ? noteRaCaTrua + " " : "")
      + (noteVaoCaChieu ? noteVaoCaChieu + " " : "")
      + (noteRaCaChieu ? noteRaCaChieu + " " : "")
      + (noteVaoLamThem ? noteVaoLamThem + " " : "")
      + (noteRaLamThem ? noteRaLamThem + " " : "");

    // náº¿u lÃ m thÃªm thÃ¬ há»i ghi chÃº bá»• sung
    if (isOvertime) {
      const note = prompt("ğŸ“ Báº¡n cÃ³ giá» lÃ m thÃªm, vui lÃ²ng nháº­p ghi chÃº (bá» trá»‘ng náº¿u khÃ´ng):");
      if (note) data.ghiChu = (data.ghiChu || "") + note + " ";
    }

    / lÆ°u vÃ o Firebase
    ref.set(data)
      .then(()=>{
        // play beep
        try { beep.play().catch(()=>{}); } catch(e){}

        alert('âœ… Cháº¥m cÃ´ng thÃ nh cÃ´ng!\n' + msg + (isOvertime ? '\nGhi chÃº: '+(data.ghiChu||'') : ''));

        resultDiv.textContent = `NhÃ¢n viÃªn: ${email}
SÃ¡ng: ${data.vaoCaSang||'-'} - ${data.raCaSang||'-'}
TrÆ°a: ${data.vaoCaTrua||'-'} - ${data.raCaTrua||'-'}
Chiá»u: ${data.vaoCaChieu||'-'} - ${data.raCaChieu||'-'}
Tá»•ng giá»: ${data.gioLamTrongNgay}h
${msg}`;

       
      restartBtn.style.display = "block";
    });
  });
}

/*===========================
  Button
===========================*/
restartBtn.onclick = startScanner;
viewBtn.onclick = () => location.href = "xem.html";
logoutBtn.onclick = () => {
  sessionStorage.clear();
  location.href = "index.html";
};

window.onload = startScanner;
</script>

</body>
</html>

