<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì∏ Qu√©t QR Ch·∫•m C√¥ng</title>

<style>
body {
    font-family: Arial;
    text-align: center;
    background: #00c6ff;
    margin: 0;
    padding: 10px;
}
h2 {
    color: white;
    font-weight: bold;
}
#video-container {
    width: 100%;
    max-width: 350px;
    margin: auto;
    position: relative;
}
video {
    width: 100%;
    border-radius: 10px;
}
#canvas {
    position: absolute;
    top: 0;
    left: 0;
}
#result {
    margin-top: 10px;
    color: white;
    font-weight: bold;
}
button {
    margin-top: 12px;
    padding: 12px;
    width: 90%;
    max-width: 300px;
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 16px;
}
#logoutBtn { background: #ff3333; }
#viewBtn { background: #005ae0; }
    #Local { background: green; }
    #reset { background: #cc00FF; }
</style>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>üì∏ QU√âT M√É QR</h2>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
</div>

<div id="result">ƒêang m·ªü camera...</div>

<button id="viewBtn">üìã Xem ch·∫•m c√¥ng</button>
<button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
<button  id="Local" onclick="checkLocation()">Ki·ªÉm tra v·ªã tr√≠</button>
<di>
    <button  id="reset">‚è≥ Qu√©t l·∫°i</button>
</di>
<script>
document.getElementById('reset').addEventListener('click', () => {
    // n·∫øu stream ch∆∞a c√≥ th√¨ m·ªü, n·∫øu c√≥ r·ªìi ch·ªâ b·∫≠t l·∫°i scan loop
    if (!video.srcObject) startCamera();
    else {
        scanning = true;
        restartScan();
    }
});

    function checkLocation() {
  if (!navigator.geolocation) {
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation!');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => alert(`Vƒ© ƒë·ªô: ${pos.coords.latitude}, Kinh ƒë·ªô: ${pos.coords.longitude}`),
    err => alert(`L·ªói: ${err.code} - ${err.message}`),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}
/* ===================== LOGIN ===================== */
const userEmail = sessionStorage.getItem("userEmail");
if (!userEmail) location.href = "index.html";

/* ===================== ELEMENTS ===================== */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const resultDiv = document.getElementById("result");

let scanning = false;

/* ===================== FIREBASE ===================== */
firebase.initializeApp({
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
});
const db = firebase.database();

/* ===================== START CAMERA ===================== */
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        video.srcObject = stream;

        video.onloadedmetadata = () => {
            canvas.width = video.clientWidth+"px";
            canvas.height = video.clientHeight+"px";
            scanning = true;
            resultDiv.textContent = "ƒêang qu√©t...";
            scanLoop();
        };

    } catch (err) {
        resultDiv.textContent = "‚ùå Kh√¥ng th·ªÉ m·ªü camera!";
    }
}

/* ===================== SCAN LOOP ===================== */
function scanLoop() {
    if (!scanning) return;
ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let code = jsQR(imgData.data, canvas.width, canvas.height, { inversionAttempts: "attemptBoth" });

    ctx.lineWidth = 4;

    if (code) {
        // V·∫º KHUNG QR M√ÄU XANH
        drawBox(code.location, "#00FF00");
        scanning = false;
        handleQRCode(code.data);
        return;
    } else {
        // V·∫º KHUNG C·∫¢NH B√ÅO M√ÄU ƒê·ªé NH·∫†T
        ctx.strokeStyle = "rgba(255,0,0,0.3)";
        ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
    }

    requestAnimationFrame(scanLoop);
}

function drawBox(loc, color) {
    ctx.beginPath();
    ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
    ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
    ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
    ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
    ctx.closePath();
    ctx.strokeStyle = color;
    ctx.stroke();
}

/* ===================== QR CHECK ===================== */
const VALID_QR = "CHECKIN_GLASS_COMPANY";
const COMPANY = { lat: 10.84964185816, lng: 106.58569113116 };

function encodeEmail(e) { return e.replace(/\./g, ","); }

function handleQRCode(text) {
    if (text !== VALID_QR) {
        scanning = false;
        alert("‚ùå M√£ QR kh√¥ng ƒë√∫ng!");
        setTimeout(() => restartScan(), 800);
        return;
    }
     resultDiv.textContent = "ƒêang l·∫•y GPS...";

    requestLocationSafariFix()
        .then(pos => {
            console.log("GPS OK:", pos.coords);
            saveAttendance(pos.coords.latitude, pos.coords.longitude);
        })
        .catch(err => {
            console.log("GPS ERROR", err);
            restartScan();
        });
    
}

    // t·∫Øt camera khi r√≤i trang
window.addEventListener("pagehide", () => {
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
});

// b·∫≠t camera l·∫°i
    document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        // quay l·∫°i trang ‚Üí m·ªü l·∫°i camera
        startCamera();
    } else {
        // r·ªùi trang ‚Üí t·∫Øt camera
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(t => t.stop());
        }
    }
});





    
/* ===================== T√çNH GI·ªú ===================== */
function timeDiff(a, b) {
    const pa = a.replace(/[^0-9:]/g, "").split(":").map(Number);
    const pb = b.replace(/[^0-9:]/g, "").split(":").map(Number);
    return (pb[0] + pb[1] / 60) - (pa[0] + pa[1] / 60);
}

function distance(a, b, c, d) {
    const R = 6371000;
    let x = (c - a) * Math.PI / 180;
    let y = (d - b) * Math.PI / 180;
    let s = Math.sin(x/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(y/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
}
function timeDiff(a, b) {
    if (!a || !b) return 0;

    // ch·ªâ l·∫•y HH:MM
    a = a.replace(/[^0-9:]/g, "");
    b = b.replace(/[^0-9:]/g, "");

    if (!a.includes(":") || !b.includes(":")) return 0;

    const pa = a.split(":").map(Number);
    const pb = b.split(":").map(Number);

    if (pa.length < 2 || pb.length < 2) return 0;
    if (isNaN(pa[0]) || isNaN(pa[1]) || isNaN(pb[0]) || isNaN(pb[1])) return 0;

    const t1 = pa[0] + pa[1] / 60;
    const t2 = pb[0] + pb[1] / 60;
    return t2 - t1;
}
/* ===================== L∆ØU CH·∫§M C√îNG ===================== */
function saveAttendance(lat, lng) {

    if (distance(lat, lng, COMPANY.lat, COMPANY.lng) > 100) {
        
        alert("‚ùå B·∫°n qu√° xa c√¥ng ty!");
        setTimeout(() => {
                restartScan();
                }, 1000); // ƒë·ª£i ng∆∞·ªùi d√πng b·∫•m OK xong
        return;
       
    }

    const emailKey = encodeEmail(userEmail);
    const now = new Date();
    const day = now.toISOString().slice(0, 10);
    const time = now.toLocaleTimeString();
    const hour = now.getHours() + now.getMinutes() / 60;

    const ref = db.ref("chamcong/" + emailKey + "/" + day);

    ref.once("value").then((snap) => {
        let d = snap.val() || {};

        d.vaoCaSang ??= "";
        d.raCaSang ??= "";
        d.vaoCaTrua ??= "";
        d.raCaTrua ??= "";
        d.vaoCaChieu ??= "";
        d.raCaChieu ??= "";
        d.vaoLamThem ??= "";
        d.raLamThem ??= "";

        let msg = "";

        if (hour >= 7.5 && hour <= 11.5)
        {
            if(!d.vaoCaSang)
            {
                d.vaoCaSang = time;
                msg="V√†o ca s√°ng";
                msg="ƒëi mu·ªôn!"
                d.noteVaoCaSang = "ƒëi mu·ªôn";
            }
            else{
                 d.raCaSang = time;
                msg="V·ªÅ s·ªõm!"
                d.noteRaCaSang = "v·ªÅ s·ªõm";
            }
             
        }
      else   if (hour < 7.5){
        if(!d.vaoCaSang)
        {
            d.vaoCaSang = time;
            msg="S√°ng ƒëi s·ªõm";
             d.noteVaoCaSang = "ƒëi s·ªõm";
        }
      }
            
        // ======= CA TR∆ØA =======
else if (hour >= 11.5 && hour <= 13) {

    // N·∫øu ch∆∞a ch·∫•m ra s√°ng ‚Üí auto ch·∫•m ƒë√∫ng 11:30
    if (!d.raCaSang && d.vaoCaSang) {
        d.raCaSang = "11:30";
        msg=" l√†m tr∆∞a";
        d.noteRaCaSang = "ƒë√∫ng gi·ªù";
    }

    // N·∫øu ch∆∞a v√†o ca tr∆∞a ‚Üí ƒë√¢y l√† l·∫ßn qu√©t V√ÄO TR∆ØA
    if (!d.vaoCaTrua) {
        d.vaoCaTrua = "11:30";   // chu·∫©n gi·ªù
        msg = "V√†o ca tr∆∞a";
    }
    // N·∫øu ƒë√£ v√†o nh∆∞ng ch∆∞a ra ca tr∆∞a ‚Üí ƒë√¢y l√† l·∫ßn qu√©t RA TR∆ØA
    else if (!d.raCaTrua) {
        d.raCaTrua = time;
        msg = "Ra ca tr∆∞a";

        if (hour < 12) {
            d.noteRaCaTrua = "ra s·ªõm";
        }
    }
}
            

       else if (hour >= 13 && hour <= 17.5) {
        if (!d.vaoCaChieu) {
            d.vaoCaChieu = time;
            msg = "V√†o ca chi·ªÅu";
            d.noteVaoCaChieu="chi·ªÅu ƒëi mu·ªôn ";
        }
            else if(!d.RaCaSang)
            {
                d.raCaSang="11:30";
                d.vaoCaTrua="11:30";
                d.raCaTrua="13:00";
                
            }
            else  {
                    d.raCaChieu = time;
                    msg = "Ra ca chi·ªÅu";
            
                    // üëâ Ghi ch√∫ ca chi·ªÅu (ra s·ªõm)
            if (hour < 17.5) {
                            d.noteRaCaChieu = "V·ªÅ s·ªõm";
                            }
            }
    }
           
        else if (hour > 17.5)
        {
           if(!d.raCaChieu)
           {
               d.raCaChieu="17:30";
           }
            else if(!d.vaoLamThem){
                    d.vaoLamThem = "17:30";
                    msg="V√†o tƒÉng ca";
               
            }
            else
            {
                d.raLamThem = time;
                msg="V√†o tƒÉng ca";
                d.noteRaLamThem="tƒÉng ca t·ªëi"
            }

        }

        // T√çNH GI·ªú
        let total = 0;
total += timeDiff(d.vaoCaSang, d.raCaSang);
total += timeDiff(d.vaoCaTrua, d.raCaTrua);
total += timeDiff(d.vaoCaChieu, d.raCaChieu);
d.gioLamTrongNgay = total.toFixed(2);

let ot = timeDiff(d.vaoLamThem, d.raLamThem)+timeDiff(d.vaoCaTrua,d.raCaTrua);
d.gioLamThem = ot.toFixed(2);

        d.diaDiemQuet = `${lat},${lng}`;

        ref.set(d).then(() => {
          scanning = false; // NGƒÇN CAMERA QU√âT TI·∫æP
            alert(
                "‚úî Ch·∫•m c√¥ng th√†nh c√¥ng!\n" +
                "üìÖ Ng√†y: "+day+"\n"+
                "‚è∞ "+time+"_"+msg+"\n"+
                "‚è≥ Gi·ªù l√†m: "+d.gioLamTrongNgay+"h\n"+
                "üåô TƒÉng ca: "+d.gioLamThem+"h"
            );

            setTimeout(() => {
                restartScan();
                }, 1000); // ƒë·ª£i ng∆∞·ªùi d√πng b·∫•m OK xong
                });
    });
}

/* ===================== RESTART SCAN ===================== */
function restartScan() {
    resultDiv.textContent = "ƒêang qu√©t...";
    scanning = true;
    scanLoop();
}

/* ===================== BUTTONS ===================== */
document.getElementById("viewBtn").onclick = () =>
    location.href = "xem.html?user=" + userEmail;

document.getElementById("logoutBtn").onclick = () => {
    sessionStorage.clear();
    location.href = "index.html";
};

/* ===================== AUTO START ===================== */
startCamera();

</script>

</body>
</html>


































