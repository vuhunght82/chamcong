<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cháº¥m CÃ´ng QR</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f2f5; }
    h1 { background: #007bff; color: white; padding: 15px; margin:0; }
    #video-container { margin:20px auto; width:300px; border:2px solid #007bff; border-radius:10px; overflow:hidden;}
    video { width:100%; height:auto; }
    #result { font-weight:bold; color:green; margin-top:20px; }
    #error { color:red; margin-top:10px; }
    input, button { padding:8px; margin:5px; font-size:16px; }
    #logout { margin-top:10px; }
  </style>
</head>
<body>

<h1>ğŸ“¸ Cháº¥m CÃ´ng QR</h1>

<div id="login-section">
  <h2>ÄÄƒng nháº­p nhÃ¢n viÃªn</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Máº­t kháº©u"><br>
  <button id="loginBtn">ÄÄƒng nháº­p</button>
  <div id="loginError" style="color:red;"></div>
</div>

<div id="scanner-section" style="display:none;">
  <button id="logout">ÄÄƒng xuáº¥t</button>
  <div id="video-container">
    <video id="qr-video" muted></video>
  </div>
  <div id="result">Äang chá» quÃ©t QR...</div>
  <div id="error"></div>
  <button id="restartBtn" style="display:none;">QuÃ©t láº¡i</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- QR Scanner -->
<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';

// =================== Cáº¥u hÃ¬nh Firebase ===================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// =================== ÄÄƒng nháº­p ===================
const loginSection = document.getElementById('login-section');
const scannerSection = document.getElementById('scanner-section');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');

loginBtn.addEventListener('click', () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  //auth.signInWithEmailAndPassword(email, password)
  //  .then(userCredential => {
  //    loginSection.style.display = 'none';
  //    scannerSection.style.display = 'block';
  //    startScanner();
  //  })
  //  .catch(error => {
  //    loginError.textContent = error.message;
  //  });
   
    
      startScanner();
    
});

document.getElementById('logout').addEventListener('click', () => {
  auth.signOut().then(() => location.reload());
});

// =================== QR Scanner ===================
const videoElem = document.getElementById('qr-video');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const restartBtn = document.getElementById('restartBtn');

let scanner;

function startScanner() {
  resultDiv.textContent = 'Äang chá» quÃ©t QR...';
  errorDiv.textContent = '';
  restartBtn.style.display = 'none';

  scanner = new QrScanner(videoElem, qrResult => {
    handleAttendance(qrResult);
  }, { highlightScanRegion: true, highlightCodeOutline: true });

  scanner.start().catch(err => {
    errorDiv.textContent = 'âŒ KhÃ´ng thá»ƒ má»Ÿ camera: ' + err;
  });
}

restartBtn.addEventListener('click', () => startScanner());

// =================== Xá»­ lÃ½ cháº¥m cÃ´ng ===================
function handleAttendance(employeeId) {
  scanner.stop();
  const now = new Date();
  const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
  const currentHour = now.getHours() + now.getMinutes()/60;

  const docId = employeeId + '_' + today;
  const attendanceRef = db.collection('attendance').doc(docId);

  attendanceRef.get().then(doc => {
    let data = doc.exists ? doc.data() : {};

    // Ca sÃ¡ng: 7.5 -> 11.5, Ca chiá»u: 13 -> 17.5
    const morningStart = 7.5, morningEnd = 11.5;
    const afternoonStart = 13, afternoonEnd = 17.5;
    let msg = '';

    // Quy táº¯c tÃ­nh check-in/check-out
    if (currentHour >= morningStart && currentHour <= morningEnd) {
      if (!data.checkInMorning) {
        data.checkInMorning = now.toLocaleTimeString();
        if (currentHour > morningStart) msg += 'âš  Äi muá»™n ca sÃ¡ng! ';
      } else {
        data.checkOutMorning = now.toLocaleTimeString();
      }
    } else if (currentHour >= afternoonStart && currentHour <= afternoonEnd) {
      if (!data.checkInAfternoon) {
        data.checkInAfternoon = now.toLocaleTimeString();
        if (currentHour > afternoonStart) msg += 'âš  Äi muá»™n ca chiá»u! ';
      } else {
        data.checkOutAfternoon = now.toLocaleTimeString();
      }
    } else if (currentHour > morningEnd && currentHour < afternoonStart) {
      msg += 'â„¹ Giá» nghá»‰ trÆ°a, ghi nháº­n lÃ m thÃªm náº¿u cÃ³.';
    } else {
      msg += 'â„¹ NgoÃ i giá» ca, ghi nháº­n theo ca.';
    }

    // TÃ­nh tá»•ng giá» lÃ m (sÆ¡ khai, báº¡n cÃ³ thá»ƒ má»Ÿ rá»™ng)
    let totalHours = 0;
    if (data.checkInMorning && data.checkOutMorning) {
      const inM = parseTime(data.checkInMorning), outM = parseTime(data.checkOutMorning);
      totalHours += (outM - inM);
    }
    if (data.checkInAfternoon && data.checkOutAfternoon) {
      const inA = parseTime(data.checkInAfternoon), outA = parseTime(data.checkOutAfternoon);
      totalHours += (outA - inA);
    }

    data.totalWorkingHours = totalHours.toFixed(2);

    attendanceRef.set(data, { merge:true })
      .then(() => {
        resultDiv.textContent = `âœ… NhÃ¢n viÃªn: ${employeeId}\n` +
                                `SÃ¡ng: ${data.checkInMorning || '-'} - ${data.checkOutMorning || '-'}\n` +
                                `Chiá»u: ${data.checkInAfternoon || '-'} - ${data.checkOutAfternoon || '-'}\n` +
                                `Tá»•ng giá»: ${data.totalWorkingHours}h\n` + msg;
        alert('âœ… ÄÃ£ quÃ©t QR!\n' + msg);
        restartBtn.style.display = 'inline-block';
      })
      .catch(err => errorDiv.textContent = 'âŒ Lá»—i lÆ°u dá»¯ liá»‡u: ' + err);
  });
}

// Chuyá»ƒn HH:MM:SS thÃ nh giá» sá»‘
function parseTime(timeStr) {
  const parts = timeStr.split(':');
  return Number(parts[0]) + Number(parts[1])/60 + (parts[2]?Number(parts[2])/3600:0);
}
</script>
</body>
</html>
