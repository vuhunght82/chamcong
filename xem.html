<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã Xem ch·∫•m c√¥ng</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f0f2f5;
  text-align: center;
  padding: 10px;
}
h1 {
  color: #007bff;
}
table {
  width: 100%;
  max-width: 900px;
  margin: 20px auto;
  border-collapse: collapse;
  background: white;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
th {
  background-color: #007bff;
  color: white;
  padding: 10px;
}
td {
  border: 1px solid #ddd;
  padding: 8px;
}
tr:nth-child(even) { background-color: #f9f9f9; }
tr:hover { background-color: #eef; }
#controls {
  margin-bottom: 15px;
}
#userName {
  font-weight: bold;
  color: #007bff;
  margin-bottom: 10px;
}
tfoot td {
  font-weight: bold;
  background-color: #e3f2fd;
}
button {
  padding: 8px 15px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
button:hover {
  background-color: #0056b3;
}
</style>
</head>
<body>

<h1>üìã B·∫£ng ch·∫•m c√¥ng nh√¢n vi√™n</h1>
<div id="userName">ƒêang t·∫£i t√™n nh√¢n vi√™n...</div>

<div id="controls">
  <input type="month" id="monthFilter">
  <button id="exportBtn">‚¨á Xu·∫•t Excel</button>
  <button onclick="window.location.href='quet.html'">üîô Quay l·∫°i</button>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>Ng√†y</th>
      <th>V√†o ca s√°ng</th>
      <th>Ra ca s√°ng</th>
      <th>V√†o ca chi·ªÅu</th>
      <th>Ra ca chi·ªÅu</th>
      <th>V√†o l√†m th√™m</th>
      <th>Ra l√†m th√™m</th>
      <th>Gi·ªù l√†m th√™m</th>
      <th>T·ªïng gi·ªù/ng√†y</th>
      <th>Ghi ch√∫</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="7">T·ªîNG C·ªòNG</td>
      <td id="tongGioThem">0.00</td>
      <td id="tongGioThang">0.00</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
  authDomain: "sellglass-3ebe9.firebaseapp.com",
  databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sellglass-3ebe9",
  storageBucket: "sellglass-3ebe9.appspot.com",
  messagingSenderId: "513741829035",
  appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const userEmail = sessionStorage.getItem('userEmail');
const monthFilter = document.getElementById('monthFilter');
const tbody = document.querySelector('#dataTable tbody');
const tongGioThangCell = document.getElementById('tongGioThang');
const tongGioThemCell = document.getElementById('tongGioThem');
const userNameDiv = document.getElementById('userName');

// ===== L·∫•y t√™n nh√¢n vi√™n =====
if(userEmail){
  const key = userEmail.replace(/\./g, ',');
  db.ref('nhanvien/' + key).once('value').then(snap => {
    const nv = snap.val();
    userNameDiv.textContent = nv?.ten ? `Nh√¢n vi√™n: ${nv.ten}` : `Nh√¢n vi√™n: ${userEmail}`;
  });
} else {
  alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!");
  window.location.href = "index.html";
}

// ===== H√†m hi·ªÉn th·ªã d·ªØ li·ªáu =====
function loadData() {
  if (!userEmail) return;
  const key = userEmail.replace(/\./g, ',');
  const ref = db.ref('chamcong/' + key);
  const month = monthFilter.value || new Date().toISOString().slice(0,7);
  ref.once('value').then(snapshot => {
    const data = snapshot.val() || {};
    const filtered = Object.entries(data)
      .filter(([day]) => day.startsWith(month))
      .sort(([a], [b]) => new Date(a) - new Date(b));

    let html = '';
    let tongGio = 0, tongThem = 0;

    filtered.forEach(([day, d]) => {
      const gioThem = (d.vaoLamThem && d.raLamThem)
        ? (parseTime(d.raLamThem) - parseTime(d.vaoLamThem))
        : 0;
      tongGio += Number(d.gioLamTrongNgay || 0);
      tongThem += gioThem;
      html += `
        <tr>
          <td>$formatDate({day})</td>
          <td>${d.vaoCaSang || '-'}</td>
          <td>${d.raCaSang || '-'}</td>
          <td>${d.vaoCaChieu || '-'}</td>
          <td>${d.raCaChieu || '-'}</td>
          <td>${d.vaoLamThem || '-'}</td>
          <td>${d.raLamThem || '-'}</td>
          <td>${gioThem.toFixed(2)}</td>
          <td>${(parseFloat(d.gioLamTrongNgay) || 0).toFixed(2)}</td>
          <td>${d.ghiChu || ''}</td>
        </tr>`;
    });

    tbody.innerHTML = html;
    tongGioThangCell.textContent = tongGio.toFixed(2);
    tongGioThemCell.textContent = tongThem.toFixed(2);
  });
}

function parseTime(str) {
  if (!str || str === '-') return 0;
  const [h, m, s=0] = str.split(':');
  return Number(h) + Number(m)/60 + Number(s)/3600;
}
  // ƒë·ªãnh d·∫°ng ng√†y th√°ng
function formatDate(dateStr) {
  // Tr∆∞·ªùng h·ª£p d·ªØ li·ªáu t·ª´ Firebase l∆∞u d·∫°ng yyyy-mm-dd
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; // n·∫øu kh√¥ng parse ƒë∆∞·ª£c th√¨ tr·∫£ nguy√™n chu·ªói
  
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}
monthFilter.addEventListener('change', loadData);
window.addEventListener('load', loadData);

// ===== Xu·∫•t Excel =====
document.getElementById('exportBtn').addEventListener('click', () => {
  const wb = XLSX.utils.table_to_book(document.getElementById('dataTable'), { sheet: "ChamCong" });
  XLSX.writeFile(wb, `ChamCong_${new Date().toISOString().slice(0,7)}.xlsx`);
});
</script>
</body>
</html>




