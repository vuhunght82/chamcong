<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë®‚Äçüíº Xem b·∫£ng ch·∫•m c√¥ng</title>
    <style>
        .extra-col {
            background-color: #d0e7ff; /* xanh d∆∞∆°ng nh·∫°t */
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #007bff;
            margin-bottom: 20px;
        }

        select, input[type="month"], button {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin: 5px;
            outline: none;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }

            button:hover {
                background-color: #0056b3;
            }

        table {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background-color: white;
        }

        th {
            background-color: #4da6ff;
            color: white;
            padding: 10px;
        }

        td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        tr:hover {
            background-color: #f1f9ff;
        }

        .deleteBtn {
            background: #ff4d4f;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

            .deleteBtn:hover {
                background: #c82333;
               
            }

        #summary {
            margin-top: 20px;
            font-weight: bold;
            color: #333;
        }
        #backBtn
        {
            background: green;
        }
    </style>
</head>
<body>

    <h1>üë®‚Äçüíº xem b·∫£ng ch·∫•m c√¥ng</h1>
 <div><label for="nhanvien">Nh√¢n vi√™n: <span id="nhanvienSpan"></span></label></div>

    
    <div>
        

        <label for="monthSelect">Th√°ng:</label>
        <input type="month" id="monthSelect">

        <button id="reloadBtn" onclick="loadChamCong()">üîÑ T·∫£i l·∫°i</button>
        <button id="backBtn" onclick="">üîÑ Quay l·∫°i</button>
       
    </div>

    <table id="chamcongTable">
        <thead>
            <tr>
                <th style="width:160px;">Ng√†y</th>
                <th>V√†o s√°ng</th>
                <th>Ra s√°ng</th>
                <th>V√†o tr∆∞a</th>
                <th>Ra tr∆∞a</th>
                <th>V√†o chi·ªÅu</th>
                <th>Ra chi·ªÅu</th>

                <th>V√†o l√†m th√™m</th>
                <th>Ra l√†m th√™m</th>
                <th>Gi·ªù l√†m (h)</th>
                <th>Gi·ªù l√†m th√™m (h)</th>
                <th>Ghi ch√∫</th>
              
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
        </tbody>
    </table>

    <div id="summary"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>


        // ================== Firebase Config ==================
        const firebaseConfig = {
            apiKey: "AIzaSyAb5AZOBvEVY3a_9ioEKTW-wuVMXdnRZGQ",
            authDomain: "sellglass-3ebe9.firebaseapp.com",
            databaseURL: "https://sellglass-3ebe9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sellglass-3ebe9",
            storageBucket: "sellglass-3ebe9.appspot.com",
            messagingSenderId: "513741829035",
            appId: "1:513741829035:web:1b2c59dcf1a0be329358ee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================== Elements ==================
        const nhanvienSelect = document.getElementById('nhanvienSelect');
        const monthSelect = document.getElementById('monthSelect');
        const tableBody = document.querySelector('#chamcongTable tbody');
        const summaryDiv = document.getElementById('summary');
        const reloadBtn = document.getElementById('reloadBtn');
        const exportBtn = document.getElementById('exportBtn');

        let currentData = [];

        // L·∫•y email ƒëƒÉng nh·∫≠p
        const loginEmail = sessionStorage.getItem("userEmail");
        if (!loginEmail) location.href = "index.html";

        const currentUser = loginEmail;  // email d√πng ƒë·ªÉ load d·ªØ li·ªáu
document.getElementById("nhanvienSpan").textContent = loginEmail;
             

        // ================== H√†m parse gi·ªù hh:mm -> s·ªë gi·ªù ==================
        function parseHour(timeStr) {
            if (!timeStr || timeStr === '-') return 0;
            const [h, m] = timeStr.split(':').map(Number);
            if (isNaN(h) || isNaN(m)) return 0;
            return h + m / 60;
        }

        // ================== T√≠nh gi·ªù cho 1 d√≤ng ==================
        function calculateHours(tr) {
            const vaoSang = parseHour(tr.children[1].textContent.trim());
            const raSang = parseHour(tr.children[2].textContent.trim());
            const vaoTrua = parseHour(tr.children[3].textContent.trim());
            const raTrua = parseHour(tr.children[4].textContent.trim());
            const vaoChieu = parseHour(tr.children[5].textContent.trim());
            const raChieu = parseHour(tr.children[6].textContent.trim());
            const vaoLamThem = parseHour(tr.children[7].textContent.trim());
            const raLamThem = parseHour(tr.children[8].textContent.trim());

            const gioLam = (raSang - vaoSang) + (raChieu - vaoChieu);
            const gioLamThem =  (raTrua - vaoTrua) +( raLamThem - vaoLamThem);

          tr.children[9].textContent = gioLam.toFixed(2);
          tr.children[10].textContent = gioLamThem.toFixed(2);

            return { gioLam, gioLamThem };
        }
backBtn.addEventListener('click', () => {
            window.location.href = 'quet.html';
        });
        // ================== C·∫≠p nh·∫≠t t·ªïng c·ªông ==================
        function updateTotals() {
            let tongGio = 0;
            let tongLamThem = 0;

            const dataRows = tableBody.querySelectorAll('tr[data-ngay]');
            dataRows.forEach(tr => {
                const { gioLam, gioLamThem } = calculateHours(tr);
                tongGio += gioLam;
                tongLamThem += gioLamThem;
            });

            // t·∫°o ho·∫∑c c·∫≠p nh·∫≠t d√≤ng t·ªïng c·ªông
            let totalRow = tableBody.querySelector('tr.total-row');
            if (!totalRow) {
                totalRow = document.createElement('tr');
                totalRow.classList.add('total-row');
                totalRow.style.background = "#e9f5ff";
                totalRow.style.fontWeight = "bold";

                // t·∫°o ƒë·ªß 13 c·ªôt
                for (let i = 0; i < 13; i++) {
                    const td = document.createElement('td');
                    totalRow.appendChild(td);
                }
                tableBody.appendChild(totalRow);
            }

          
           

            summaryDiv.textContent = `üßæ T·ªïng gi·ªù l√†m: ${tongGio.toFixed(2)}h | T·ªïng gi·ªù l√†m th√™m: ${tongLamThem.toFixed(2)}h`;
        }


        // ================== H√†m l·∫•y th√°ng t·ª´ ng√†y ==================
        function getMonthFromDateStr(dateStr) {
            return dateStr.substring(0, 7);
        }
        function formatDateDisplay(isoDate) {
            if (!isoDate) return "";
            const [y, m, d] = isoDate.split("-");
            return `${d}/${m}/${y}`;
        }
        // ================== Load d·ªØ li·ªáu ch·∫•m c√¥ng ==================
        function loadChamCong(month) {
            
            const email = currentUser;
            tableBody.innerHTML = '<tr><td colspan="11">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('chamcong/' + encodeEmail(email)).once('value').then(snapshot => {
                const data = snapshot.val();
                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
                    summaryDiv.textContent = '';
                    currentData = [];
                    return;
                }

                const rows = [];
                for (let ngay in data) {
                    const info = data[ngay];
                    if (!month || getMonthFromDateStr(ngay) === month) {
                        const gioLam = parseFloat(info.gioLamTrongNgay || 0);
                        const gioLamThem = parseFloat(info.gioLamThem || 0);
                        rows.push({
                            Ngay: formatDateDisplay(ngay),
                            NgayKey: ngay,   // th√™m d√≤ng n√†y ƒë·ªÉ l∆∞u ng∆∞·ª£c v·ªÅ Firebase
                            vaoCaSang: info.vaoCaSang || '',
                            noteVaoCaSang: info.noteVaoCaSang || '',

                            raCaSang: info.raCaSang || '',
                            noteRaCaSang: info.noteRaCaSang || '',

                            vaoCaTrua: info.vaoCaTrua || '',
                            noteVaoCaTrua: info.noteVaoCaTrua || '',
                            raCaTrua: info.raCaTrua || '',
                            noteRaCaTrua:info.noteRaCaTrua || '',

                            vaoCaChieu: info.vaoCaChieu || '',
                            noteVaoCaChieu: info.noteVaoCaChieu || '',
                           
                            raCaChieu: info.raCaChieu || '',
                            noteRaCaChieu: info.noteRaCaChieu || '',

                            vaoLamThem: info.vaoLamThem || '',
                            noteVaoLamThem: info.noteVaoLamThem||'',
                            raLamThem: info.raLamThem || '',
                            noteRaLamThem: info.noteRaLamThem||'',
                            gioLam: gioLam,
                            gioLamThem: gioLamThem,
                            ghiChu: info.ghiChu || ''
                        });
                    }
                }

                currentData = rows;

                if (rows.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
                    summaryDiv.textContent = '';
                    return;
                }

                // hi·ªÉn th·ªã b·∫£ng
                tableBody.innerHTML = '';
                rows.forEach((r) => {
                    tableBody.insertAdjacentHTML('beforeend', `
           <!-- D√≤ng ch√≠nh -->
        <tr data-ngay="${r.NgayKey}" class="main-row">
          <td  >${r.Ngay}(${getThuTrongTuan(r.Ngay)})</td>
          <td>${r.vaoCaSang}</td>
          <td>${r.raCaSang}</td>
           <td style="background-color: #ffcc33;" >${r.vaoCaTrua}</td>
          <td style="background-color: #ffcc33;" >${r.raCaTrua}</td>

          <td>${r.vaoCaChieu}</td>
          <td >${r.raCaChieu}</td>
          <td  class="extra-col">${r.vaoLamThem}</td>
          <td class="extra-col">${r.raLamThem}</td>
          <td rowspan="2" style="font-size:18px;font-weight: bold;"  >${r.gioLam.toFixed(2)}</td>
          <td rowspan="2" style="font-size:18px;font-weight: bold;">${r.gioLamThem.toFixed(2)}</td>
          <td contenteditable="true" rowspan="2"> ${r.ghiChu || ''}</td>

        </tr>

        <!-- D√≤ng ghi ch√∫ th√™m -->
        <tr class="note-row" style="background-color: #f4e191;">
    <td style="font-size:12px;color:green;">Tr·∫°ng th√°i</td>
    <td>${r.noteVaoCaSang}</td>
    <td >${r.noteRaCaSang}</td>
    <td>${r.noteVaoCaTrua}</td>
    <td >${r.noteRaCaTrua}</td>
    <td >${r.noteVaoCaChieu}</td>
    <td >${r.noteRaCaChieu}</td>
    <td >${r.noteVaoLamThem}</td>
    <td >${r.noteRaLamThem}</td>

  
    
<td></td>
  
 
</tr>
            
          `);
                });

                updateTotals(); // t√≠nh t·ªïng sau khi hi·ªÉn th·ªã
                highlightNoteRows();
            });
        }

        // ================== Encode email ==================
        function encodeEmail(email) { return email.replace(/\./g, ','); }

        // ================== C·∫≠p nh·∫≠t d·ªØ li·ªáu khi s·ª≠a b·∫£ng ==================
        tableBody.addEventListener('input', e => {
            const td = e.target;
            const tr = td.closest("tr");

            // ch·ªâ cho s·ª≠a √¥ ghi ch√∫ (c·ªôt 11 = index 11)
            if (td.cellIndex !== 11) {
                td.textContent = td.textContent_old || td.textContent;
                return;
            }

            if (!tr.dataset.ngay) return;

            const ngay = tr.dataset.ngay;

            db.ref("chamcong/" + encodeEmail(currentUser) + "/" + ngay).update({
                ghiChu: td.textContent
            });
        });



      

      
        // ================== S·ª± ki·ªán ==================
       
        monthSelect.addEventListener('change', () => loadChamCong(nhanvienSelect.value, monthSelect.value));
       
      

        // ================== Kh·ªüi ƒë·ªông ==================
        window.addEventListener('load', () => {
            
            const today = new Date();
            monthSelect.value = today.toISOString().substring(0, 7);
            loadChamCong();
        });

        function highlightNoteRows() {
            const noteRows = document.querySelectorAll(".note-row");

            noteRows.forEach(row => {
                for (let i = 1; i <= 8; i++) {
                    let cell = row.children[i];
                    let text = cell.textContent.toLowerCase();

                    if (text.includes("ƒëi s·ªõm")) {
                        cell.style.background = "#C8F7C5"; // xanh nh·∫°t
                        cell.style.color = "green";
                    } else if (text.trim() !== "") {
                        cell.style.background = "#FFD2D2"; // ƒë·ªè nh·∫°t
                        cell.style.color = "red";
                    } else {
                        cell.style.background = ""; // reset n·∫øu √¥ tr·ªëng
                        cell.style.color = "black";
                    }
                }
            });
        }
        function getThuTrongTuan(dateStr) {
    // Tr∆∞·ªùng h·ª£p YYYY-MM-DD (Firebase l∆∞u d·∫°ng n√†y)
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        const date = new Date(dateStr);
        return ["Ch·ªß Nh·∫≠t","Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y"][date.getDay()];
    }

    // Tr∆∞·ªùng h·ª£p dd/mm/yyyy (b·∫°n ƒëang d√πng tr√™n b·∫£ng)
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
        const [d, m, y] = dateStr.split('/');
        const date = new Date(`${y}-${m}-${d}`);
        return ["Ch·ªß Nh·∫≠t","Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y"][date.getDay()];
    }

    return "Kh√¥ng r√µ";
}
    </script>
</body>
</html>









